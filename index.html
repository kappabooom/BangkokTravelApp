<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026曼谷旅行</title>

    <!-- 1. Apple Touch Icon 與基本設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" href="apple-touch-icon.png">

    <!-- 2. UI 樣式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-white': '#FFFDE7',
                        'ice-blue': '#4DB6AC',
                        'light-snow-blue': '#FFF3E0',
                        'deep-sea-blue': '#E65100',
                        'accent-yellow': '#FFB300',
                        'soft-gray': '#FAFAFA'
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { background-color: #FFF3E0; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; color: #334155; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 30px rgba(0, 0, 0, 0.05); position: relative; padding-bottom: 90px; }
        .header-bg { background-color: #ffffff; padding: 0; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; z-index: 10; }
        .header-image-container { width: 100%; height: 250px; overflow: hidden; background-color: transparent; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; }
        .header-image-container img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .side-tab-bar { position: absolute; bottom: 15px; right: 16px; z-index: 30; display: flex; flex-direction: row; gap: 8px; }
        .tab-button { width: 40px; height: 40px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-size: 1.125rem; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: all 0.2s ease; border: none; cursor: pointer; }
        .tab-button.active { background-color: #E65100; color: #ffffff; box-shadow: 0 6px 15px rgba(230, 81, 0, 0.4); transform: scale(1.05); }
        .tab-button:not(.active) { background-color: #ffffff; color: #4DB6AC; }
        .app-main { padding-top: 25px !important; position: relative; z-index: 5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(230, 81, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fab-shadow { box-shadow: 0 4px 15px rgba(255, 179, 0, 0.5); }
        .note-content { max-height: 2.5rem; overflow: hidden; transition: max-height 0.3s ease-out; }
        .note-content.expanded { max-height: 500px; }
        .expenses-banner { background: linear-gradient(135deg, #FF7043 0%, #AB47BC 100%); }
        .date-selector-sticky { background-color: #ffffff; border-bottom: 1px solid #f0f0f0; z-index: 20; top: 0; padding-top: env(safe-area-inset-top, 20px); }
        .placeholder-white::placeholder { color: rgba(255, 255, 255, 0.6); }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <!-- Header -->
        <div class="header-bg relative">
            <div class="header-image-container">
                <img src="banner.png" alt="曼谷家族旅行計畫" onerror="this.src='https://images.unsplash.com/photo-1596422846543-75c6fc197f07?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'">
            </div>
            <div class="side-tab-bar">
                <button @click="currentTab = 'itinerary'" title="行程" :class="{'active': currentTab === 'itinerary'}" class="tab-button"><i class="fa-solid fa-map-location-dot"></i></button>
                <button @click="currentTab = 'info'" title="資訊" :class="{'active': currentTab === 'info'}" class="tab-button"><i class="fa-solid fa-circle-info"></i></button>
                <button @click="currentTab = 'shopping'" title="購物" :class="{'active': currentTab === 'shopping'}" class="tab-button"><i class="fa-solid fa-basket-shopping"></i></button>
                <button @click="currentTab = 'expenses'" title="花費" :class="{'active': currentTab === 'expenses'}" class="tab-button"><i class="fa-solid fa-coins"></i></button>
            </div>
        </div>

        <main class="p-4 app-main">
            <!-- 1. 行程 Tab -->
            <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
                <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 snap-x px-1 sticky date-selector-sticky pt-1 -mx-4 px-4">
                    <div v-for="(day, index) in dates" :key="index" @click="selectedDateIndex = index"
                         class="snap-center flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                         :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white border-deep-sea-blue shadow-lg scale-105' : 'bg-white text-slate-400 border-white hover:bg-soft-gray'">
                        <span class="text-sm font-bold uppercase tracking-wider">{{ day.weekday }}</span>
                        <span class="text-xs font-medium opacity-70">{{ day.date }}</span>
                    </div>
                </div>

                <!-- 天氣區塊 -->
                <div v-if="weatherData[selectedDateIndex]" class="mb-4 bg-snow-white border border-ice-blue rounded-2xl p-4 flex justify-between items-center shadow-md animate-fade-in">
                    <div class="flex items-start text-deep-sea-blue space-x-4">
                        <i :class="getWeatherIcon(weatherData[selectedDateIndex].condition)" class="text-5xl text-accent-yellow"></i>
                        <div class="pt-1">
                            <span class="text-3xl font-extrabold leading-none">{{ weatherData[selectedDateIndex].temp.split('/')[0] }}°</span>
                            <span class="text-sm font-light text-slate-500 ml-1">/ {{ weatherData[selectedDateIndex].temp.split('/')[1] }}°C</span>
                            <span class="block text-xs text-slate-600 mt-1">體感: {{ weatherData[selectedDateIndex].feel }}°C</span>
                        </div>
                    </div>
                    <div class="text-right text-xs text-slate-600 pl-3">
                        <span class="font-bold block text-slate-700">{{ getWeatherDescription(weatherData[selectedDateIndex].condition) }}</span>
                        <span v-if="weatherData[selectedDateIndex].isFallback" class="block text-[11px] text-orange-500 mt-1">預覽資料<br>(非即時)</span>
                        <span v-else class="block text-[11px] text-emerald-600 mt-1">曼谷當地<br>預報天氣</span>
                        <span v-if="dates[selectedDateIndex].hasCar" class="mt-1 block text-deep-sea-blue font-bold"><i class="fa-solid fa-car-side mr-1 text-accent-yellow"></i> 租車日</span>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group">
                        <div v-if="idx > 0" class="pl-8 pb-2 flex items-center text-xs text-slate-400">
                            <div class="h-6 w-0.5 bg-slate-200 absolute left-6 -top-3"></div>
                            <i :class="getTransportIcon(item.transportType)" class="mr-2 text-slate-300 cursor-pointer hover:text-deep-sea-blue transition-colors" @click="openMapDirections(currentItinerary[idx - 1], item)"></i>
                            <span class="font-bold">{{ item.travelTime || '約15分鐘' }}</span>
                        </div>

                        <div class="bg-white rounded-3xl p-5 card-shadow relative overflow-hidden flex items-start border border-ice-blue/50">
                            <div class="mr-4 flex flex-col items-center min-w-[50px]">
                                <div class="p-2 rounded-full text-white shadow-md text-base mb-1" :style="{ backgroundColor: getCategoryColor(item.category) }"><i :class="getCategoryIcon(item.category)"></i></div>
                                <span v-if="item.startTime" class="text-xs font-bold text-slate-600 mt-1">{{ item.startTime }}</span>
                            </div>
                            <div class="flex-1 pb-1">
                                <h3 class="text-lg font-bold text-slate-800 mb-1 leading-tight pr-8">{{ item.name }}</h3>
                                <div class="text-sm text-slate-500 space-y-1.5 mt-2">
                                    <p v-if="item.hours" class="flex items-center"><i class="fa-regular fa-clock w-4 text-center mr-2 text-ice-blue"></i> {{ item.hours }}</p>
                                    <p v-if="item.price" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center mr-2 text-ice-blue"></i> {{ item.price }}</p>
                                    <p v-if="item.address" class="flex items-start"><i class="fa-solid fa-location-dot w-4 text-center mr-2 mt-1 text-ice-blue"></i> {{ item.address }}</p>
                                </div>
                                <div v-if="item.note" class="mt-3 text-xs bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                    <p class="text-slate-600 font-bold mb-1"><i class="fa-solid fa-highlighter text-accent-yellow mr-2"></i> 備註</p>
                                    <div class="note-content" :class="{'expanded': item.isNoteExpanded}">{{ item.note }}</div>
                                </div>
                            </div>
                            <div class="absolute top-3 right-3 flex flex-col space-y-1">
                                <button @click.stop="openMap(item.address || item.name)" class="w-7 h-7 bg-ice-blue text-white rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-location-arrow"></i></button>
                                <button @click.stop="editItem(item)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-pencil"></i></button>
                                <button @click.stop="removeItineraryItem(item.id)" class="w-7 h-7 bg-slate-100 text-red-400 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 資訊 Tab -->
            <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in">
                <div class="bg-gradient-to-r from-deep-sea-blue to-orange-700 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                    <h3 class="font-bold text-lg mb-4 relative z-10"><i class="fa-solid fa-calculator mr-2"></i> 匯率換算</h3>
                    <div class="flex items-center justify-between space-x-3 relative z-10">
                        <div class="flex-1"><input type="number" v-model.number="inputTHB" @input="updateTWD" class="w-full bg-white/20 rounded-xl px-3 py-2 text-white font-bold" placeholder="泰銖"></div>
                        <i class="fa-solid fa-arrow-right-arrow-left text-orange-300"></i>
                        <div class="flex-1"><input type="number" v-model.number="inputTWD" @input="updateTHB" class="w-full bg-white/10 rounded-xl px-3 py-2 text-white font-bold" placeholder="台幣"></div>
                    </div>
                    <p class="text-[10px] text-orange-200 mt-3 text-right relative z-10">匯率: 1 THB = {{ EXCHANGE_RATE.toFixed(4) }} TWD</p>
                </div>

                <!-- 住宿資訊 -->
                <div class="bg-white rounded-3xl p-6 card-shadow">
                    <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3"><i class="fa-solid fa-hotel text-indigo-500 mr-2"></i> 住宿資訊</h3>
                    <ul class="space-y-5">
                        <li v-for="hotel in hotels" class="border-b last:border-0 pb-4 last:pb-0">
                            <div class="flex justify-between items-start group">
                                <div class="flex-1">
                                    <span class="font-bold block text-slate-700 text-lg">{{ hotel.name }}</span>
                                    <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full inline-block mt-1">{{ hotel.date }}</span>
                                </div>
                                <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                            </div>
                            <div class="text-sm text-slate-500 mt-2 space-y-1">
                                <p><i class="fa-solid fa-phone w-5 text-center mr-1 text-slate-300"></i> {{ hotel.phone }}</p>
                                <p><i class="fa-solid fa-map-pin w-5 text-center mr-1 text-slate-300"></i> {{ hotel.address }}</p>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <!-- 身份切換 -->
                <div class="bg-white rounded-3xl p-5 card-shadow border border-deep-sea-blue/10">
                    <h3 class="font-bold text-slate-800 mb-3 flex items-center"><i class="fa-solid fa-user-gear text-deep-sea-blue mr-2"></i> 使用者設定</h3>
                    <select v-model="currentUser" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none font-bold text-deep-sea-blue">
                        <option v-for="m in members" :key="m.id" :value="m.name">{{ m.name }}</option>
                    </select>
                </div>
            </div>

            <!-- 3. 購物 Tab -->
            <div v-if="currentTab === 'shopping'" class="animate-fade-in">
                <div class="bg-white rounded-3xl p-6 card-shadow min-h-[60vh]">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center justify-between">
                        <span><i class="fa-solid fa-basket-shopping text-accent-yellow mr-2"></i> 購物清單</span>
                    </h3>
                    <ul class="space-y-3">
                        <li v-for="(item, index) in shoppingList" :key="index" class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                            <div class="flex items-center">
                                <input type="checkbox" v-model="item.checked" class="w-5 h-5 mr-3 accent-deep-sea-blue">
                                <span :class="{'line-through text-slate-400': item.checked}">{{ item.name }}</span>
                            </div>
                            <button @click="removeShoppingItem(index)" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 4. 花費 Tab -->
            <div v-if="currentTab === 'expenses'" class="animate-fade-in space-y-6">
                <div class="expenses-banner text-white rounded-3xl p-6 relative overflow-hidden">
                    <p class="text-sm text-orange-100 mb-2 flex items-center"><i class="fa-solid fa-user-circle mr-1"></i> {{ currentUser }} 個人總支出</p>
                    <h2 class="text-4xl font-bold">NT$ {{ formatNumber(finalTotalTWD) }}</h2>
                </div>

                <div class="bg-white rounded-3xl p-6 card-shadow">
                    <h3 class="font-bold text-slate-800 mb-4"><i class="fa-solid fa-user-pen mr-2 text-deep-sea-blue"></i> {{ currentUser }} 的支出紀錄</h3>
                    <ul v-if="myExpenses.length > 0" class="space-y-4">
                        <li v-for="(exp, idx) in myExpenses" :key="idx" class="flex items-center justify-between border-b border-slate-50 last:border-0 pb-3 last:pb-0">
                            <div class="flex items-center flex-1">
                                <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center mr-3 text-slate-500"><i :class="getCategoryIcon(exp.category)"></i></div>
                                <div>
                                    <p class="font-bold text-slate-700 text-sm">{{ exp.name }}</p>
                                    <p class="text-xs text-slate-400">{{ exp.date }}</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="font-bold text-deep-sea-blue mr-3">{{ exp.currency === 'TWD' ? 'NT$' : '฿' }}{{ formatNumber(exp.displayAmount) }}</span>
                                <button @click="removeExpense(exp.id)" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </li>
                    </ul>
                    <div v-else class="text-center py-8 text-slate-400">尚無資料</div>
                </div>
            </div>
        </main>

        <button v-if="currentTab !== 'info'" @click="handleAddClick" class="fixed bottom-6 right-6 w-14 h-14 bg-accent-yellow rounded-full fab-shadow text-deep-sea-blue text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40"><i class="fa-solid fa-plus"></i></button>

        <!-- Expense Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="font-bold text-lg mb-5 text-center text-slate-800">記一筆</h3>
                <div class="space-y-3">
                    <input v-model="newExpense.date" type="date" class="w-full bg-slate-50 rounded-xl p-3 text-sm">
                    <input v-model="newExpense.name" type="text" placeholder="項目名稱" class="w-full bg-slate-50 rounded-xl p-3 text-sm">
                    <div class="flex space-x-2">
                        <select v-model="newExpense.currency" class="bg-slate-50 rounded-xl p-3 text-sm w-24"><option value="THB">฿ THB</option><option value="TWD">$ TWD</option></select>
                        <input v-model.number="newExpense.amount" type="number" placeholder="金額" class="flex-1 bg-slate-50 rounded-xl p-3 text-sm">
                    </div>
                    <!-- 分帳邏輯 -->
                    <div class="bg-slate-50 rounded-xl p-3 mt-2">
                        <div class="flex space-x-1 mb-2">
                            <button v-for="m in ['personal','equal']" @click="newExpense.splitMethod=m" :class="newExpense.splitMethod===m ? 'bg-deep-sea-blue text-white' : 'text-slate-500'" class="flex-1 py-1 text-xs rounded">{{ m==='personal'?'個人':'均分' }}</button>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                    <button @click="saveExpense" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm">儲存</button>
                </div>
            </div>
        </div>
        
        <!-- Shopping/Itinerary Modals (簡化版) -->
        <div v-if="showShoppingModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6">
            <div class="bg-white rounded-3xl p-6 w-full max-w-sm">
                <input v-model="newShoppingItem.name" class="w-full bg-slate-50 p-3 rounded-xl mb-4" placeholder="商品名稱">
                <button @click="addShoppingItem" class="w-full bg-deep-sea-blue text-white py-3 rounded-xl">新增</button>
                <button @click="showShoppingModal=false" class="w-full text-slate-400 py-2 mt-2">取消</button>
            </div>
        </div>

        <div v-if="showItineraryModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6">
            <div class="bg-white rounded-3xl p-6 w-full max-w-sm space-y-3">
                <input v-model="newItinerary.name" class="w-full bg-slate-50 p-3 rounded-xl" placeholder="行程名稱">
                <input v-model="newItinerary.startTime" class="w-full bg-slate-50 p-3 rounded-xl" placeholder="時間 (例如 10:00)">
                <button @click="saveItineraryItem" class="w-full bg-deep-sea-blue text-white py-3 rounded-xl">新增</button>
                <button @click="showItineraryModal=false" class="w-full text-slate-400 py-2 mt-2">取消</button>
            </div>
        </div>
    </div>

    <!-- ★ 重點修改：使用 type="module" 載入 Vue 與 Firebase v12 -->
    <script type="module">
        import { createApp, ref, computed, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        // 載入 Realtime Database 模組
        import { getDatabase, ref as dbRef, push, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // Firebase Config (您提供的)
        const firebaseConfig = {
            apiKey: "AIzaSyCyYCSGWQ0Wdf13AE62UG7W8WiwpqCHs_0",
            authDomain: "bankoktrip2026.firebaseapp.com",
            projectId: "bankoktrip2026",
            storageBucket: "bankoktrip2026.firebasestorage.app",
            messagingSenderId: "347622663908",
            appId: "1:347622663908:web:6a514d1761f215a2ae6ef1",
            measurementId: "G-ENHVD5XKF8"
        };

        // 初始化 Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getDatabase(firebaseApp);

        createApp({
            setup() {
                // UI State
                const currentTab = ref('expenses');
                const selectedDateIndex = ref(0);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showItineraryModal = ref(false);
                const inputTHB = ref(100);
                const inputTWD = ref(92);
                
                // Data
                const dates = ref([
                    { date: '1/16', weekday: '四', hasCar: false },
                    { date: '1/17', weekday: '五', hasCar: false },
                    { date: '1/18', weekday: '六', hasCar: false },
                    { date: '1/19', weekday: '日', hasCar: false },
                    { date: '1/20', weekday: '一', hasCar: false }
                ]);
                const weatherData = ref([]);
                const hotels = ref([{ name: '曼谷市區飯店', date: '1/16 - 1/20', phone: '+66-2-123-4567', address: 'Bangkok' }]);
                const expenses = ref([]);
                const shoppingList = ref([]);
                const itineraryData = ref([[],[],[],[],[]]);
                const members = ref(['kappabooom', 'beibei1029', 'hsiannnnng', 'shinbinwei', 'aylwen4444', 'wunsin', 'rtrtr1', 'blackblacknu'].map((n,i)=>({id:i, name:n})));
                const currentUser = ref('kappabooom');
                const EXCHANGE_RATE = ref(0.92);

                const newExpense = ref({ name: '', amount: null, currency: 'THB', payer: 'kappabooom', splitMethod: 'personal' });
                const newShoppingItem = ref({ name: '', checked: false });
                const newItinerary = ref({ name: '', startTime: '' });

                // Firebase Listeners (v12 寫法: onValue)
                onMounted(() => {
                    onValue(dbRef(db, 'expenses'), (snapshot) => {
                        const data = snapshot.val();
                        expenses.value = data ? Object.entries(data).map(([k,v]) => ({id:k, ...v})) : [];
                    });
                    
                    onValue(dbRef(db, 'shopping'), (snapshot) => {
                        const data = snapshot.val();
                        shoppingList.value = data ? Object.entries(data).map(([k,v]) => ({id:k, ...v})) : [];
                    });

                    fetchWeather();
                });

                // Weather (Mock for stability)
                const fetchWeather = () => {
                   weatherData.value = [
                       { condition: 'sunny', temp: '32/24', feel: '35', isFallback: true },
                       { condition: 'cloudy', temp: '31/25', feel: '34', isFallback: true },
                       { condition: 'rain', temp: '30/24', feel: '33', isFallback: true },
                       { condition: 'sunny', temp: '33/25', feel: '36', isFallback: true },
                       { condition: 'sunny', temp: '32/24', feel: '35', isFallback: true }
                   ];
                };

                // Logic
                const myExpenses = computed(() => {
                    return expenses.value.filter(e => e.payer === currentUser.value || e.splitMethod === 'equal');
                });
                
                const finalTotalTWD = computed(() => {
                    return myExpenses.value.reduce((sum, e) => {
                        let amt = Number(e.amount);
                        if(e.currency === 'THB') amt = amt * EXCHANGE_RATE.value;
                        if(e.splitMethod === 'equal') amt = amt / 8; // 簡易均分
                        return sum + amt;
                    }, 0);
                });
                const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value]);

                // ★ 關鍵修復：儲存功能 (v12 寫法: push)
                const saveExpense = () => {
                    if(!newExpense.value.name || !newExpense.value.amount) return alert('請輸入金額');
                    const expensesRef = dbRef(db, 'expenses');
                    push(expensesRef, { ...newExpense.value, date: new Date().toISOString().split('T')[0] })
                        .then(() => { alert('儲存成功！'); showExpenseModal.value=false; newExpense.value.name=''; newExpense.value.amount=''; })
                        .catch((e) => alert('儲存失敗: ' + e.message));
                };

                const removeExpense = (id) => remove(dbRef(db, `expenses/${id}`));
                const addShoppingItem = () => { push(dbRef(db, 'shopping'), { ...newShoppingItem.value }); showShoppingModal.value=false; newShoppingItem.value.name=''; };
                const removeShoppingItem = (i) => { /* Shopping removal implementation needed via ID */ };
                const saveItineraryItem = () => { itineraryData.value[selectedDateIndex.value].push({...newItinerary.value, id: Date.now()}); showItineraryModal.value=false; };
                const removeItineraryItem = (id) => { const arr=itineraryData.value[selectedDateIndex.value]; const idx=arr.findIndex(i=>i.id===id); if(idx!==-1) arr.splice(idx,1); };

                const handleAddClick = () => {
                    if(currentTab.value === 'expenses') showExpenseModal.value = true;
                    else if(currentTab.value === 'shopping') showShoppingModal.value = true;
                    else if(currentTab.value === 'itinerary') showItineraryModal.value = true;
                };

                // Helpers
                const formatNumber = (n) => Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                const getCategoryIcon = (c) => ({food:'fa-solid fa-utensils', shopping:'fa-solid fa-bag-shopping', transport:'fa-solid fa-car'}[c]||'fa-solid fa-star');
                const getWeatherIcon = (c) => ({sunny:'fa-solid fa-sun', cloudy:'fa-solid fa-cloud', rain:'fa-solid fa-umbrella'}[c]);
                const getWeatherDescription = (c) => ({sunny:'晴朗', cloudy:'多雲', rain:'有雨'}[c]);
                const updateTWD = () => inputTWD.value = Math.round(inputTHB.value * EXCHANGE_RATE.value);
                const updateTHB = () => inputTHB.value = Math.round(inputTWD.value / EXCHANGE_RATE.value);
                const openMap = (q) => window.open('https://maps.google.com/?q='+q);

                return {
                    currentTab, selectedDateIndex, showExpenseModal, showShoppingModal, showItineraryModal,
                    dates, weatherData, hotels, shoppingList, myExpenses, finalTotalTWD, currentItinerary, members, currentUser,
                    newExpense, newShoppingItem, newItinerary, inputTHB, inputTWD, EXCHANGE_RATE,
                    saveExpense, removeExpense, addShoppingItem, removeShoppingItem, saveItineraryItem, removeItineraryItem,
                    handleAddClick, formatNumber, getCategoryIcon, getWeatherIcon, getWeatherDescription, updateTWD, updateTHB, openMap
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
