<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026ÊõºË∞∑ÊóÖË°å</title>

    <!-- Apple Touch Icon -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" href="apple-touch-icon.png">

    <!-- UI ÂáΩÂºèÂ∫´ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-white': '#FFFDE7',
                        'ice-blue': '#4DB6AC',
                        'light-snow-blue': '#FFF3E0',
                        'deep-sea-blue': '#E65100',
                        'accent-yellow': '#FFB300',
                        'soft-gray': '#FAFAFA'
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { background-color: #FFF3E0; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; color: #334155; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 30px rgba(0, 0, 0, 0.05); position: relative; padding-bottom: 90px; }
        
        /* Â±§Á¥öË®≠ÂÆö: Login(60) < MemberModal(70) < PasswordModal(80) < Loader(9999) */
        .login-screen { position: fixed; inset: 0; z-index: 60; background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; }

        .header-bg { background-color: #ffffff; padding: 0; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; z-index: 10; }
        .header-image-container { width: 100%; height: 250px; overflow: hidden; background-color: transparent; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; }
        .header-image-container img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .side-tab-bar { position: absolute; bottom: 15px; right: 16px; z-index: 30; display: flex; flex-direction: row; gap: 8px; }
        .tab-button { width: 40px; height: 40px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-size: 1.125rem; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: all 0.2s ease; border: none; cursor: pointer; }
        .tab-button.active { background-color: #E65100; color: #ffffff; box-shadow: 0 6px 15px rgba(230, 81, 0, 0.4); transform: scale(1.05); }
        .tab-button:not(.active) { background-color: #ffffff; color: #4DB6AC; }
        .app-main { padding-top: 25px !important; position: relative; z-index: 5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(230, 81, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fab-shadow { box-shadow: 0 4px 15px rgba(255, 179, 0, 0.5); }
        .note-content { max-height: 2.5rem; overflow: hidden; transition: max-height 0.3s ease-out; }
        .note-content.expanded { max-height: 500px; }
        .expenses-banner { background: linear-gradient(135deg, #FF7043 0%, #AB47BC 100%); }
        .date-selector-sticky { background-color: #ffffff; border-bottom: 1px solid #f0f0f0; z-index: 20; top: 0; padding-top: env(safe-area-inset-top, 20px); }
        .rotate-180 { transform: rotate(180deg); }
        .custom-select-wrapper { position: relative; }
        .custom-select-wrapper select { -webkit-appearance: none; appearance: none; width: 100%; height: 100%; opacity: 0; position: absolute; left: 0; top: 0; cursor: pointer; z-index: 10; }
        .pulse-arrow { animation: pulse-x 1.5s infinite ease-in-out; }
        @keyframes pulse-x { 0%, 100% { transform: translateX(0); opacity: 0.8; } 50% { transform: translateX(5px); opacity: 1; } }
        
        .flip-list-move { transition: transform 0.5s cubic-bezier(0.2, 0, 0, 1); z-index: 20; position: relative; }
        .flip-list-enter-active, .flip-list-leave-active { transition: all 0.3s cubic-bezier(0.2, 0, 0, 1); }
        .flip-list-enter-from, .flip-list-leave-to { opacity: 0; transform: scale(0.95); }
        .highlight-bg { animation: highlight 1s ease-out forwards; }
        @keyframes highlight { 0% { background-color: #FFF8E1; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); } 100% { background-color: #ffffff; transform: scale(1); box-shadow: 0 4px 20px rgba(230, 81, 0, 0.1); } }

        .loader-container { position: fixed; inset: 0; z-index: 9999; background-color: #FFF3E0; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease, visibility 0.5s ease; }
        .loader-container.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(230, 81, 0, 0.2); border-top-color: #E65100; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        .loader-logo { font-size: 3rem; color: #E65100; margin-bottom: 1rem; animation: pulse-logo 1.5s infinite ease-in-out; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse-logo { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }

        /* iOS Toggle Switch Style */
        .toggle-checkbox:checked { right: 0; border-color: #E65100; }
        .toggle-checkbox:checked + .toggle-label { background-color: #E65100; }
    </style>
</head>
<body>
    <!-- ËºâÂÖ•È†ÅÈù¢ -->
    <div id="loading-screen" class="loader-container">
        <i class="fa-solid fa-plane-departure loader-logo"></i>
        <div class="spinner"></div>
        <p class="text-deep-sea-blue font-bold tracking-widest text-sm">Loading...</p>
    </div>

    <div id="app" class="app-container">

        <!-- ÊàêÂì°ÈÅ∏ÊìáÔºàÁôªÂÖ•ÔºâÈ†ÅÈù¢ÔºöÂè™ÊúâÂú® membersLoaded ‰∏îÂ∞öÊú™ÁôªÂÖ•ÊôÇÈ°ØÁ§∫ -->
        <div v-if="!hasSelectedUser && membersLoaded" class="login-screen animate-fade-in p-6">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-white rounded-full mx-auto shadow-lg flex items-center justify-center mb-4">
                    <i class="fa-solid fa-plane-up text-4xl text-deep-sea-blue"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800 mb-1">Ê≠°ËøéÂõû‰æÜ</h1>
                <p class="text-sm text-slate-500">Ë´ãÈÅ∏ÊìáÊÇ®ÁöÑÊàêÂì°Ë∫´‰ªΩ‰ª•ÁôªÂÖ•</p>
            </div>

            <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
                <div v-for="member in members" :key="member.id" 
                     @click="attemptLogin(member)"
                     class="bg-white p-4 rounded-2xl shadow-sm border border-orange-100 flex flex-col items-center justify-center cursor-pointer hover:shadow-md hover:scale-105 transition-all relative overflow-hidden group">
                     
                     <div class="absolute top-0 right-0 p-2" v-if="member.role === 'admin' || member.password">
                        <i v-if="member.role === 'admin'" class="fa-solid fa-crown text-[10px] text-yellow-500 bg-yellow-100 p-1 rounded-full"></i>
                        <i v-else-if="member.password" class="fa-solid fa-lock text-[10px] text-slate-400 bg-slate-100 p-1 rounded-full"></i>
                     </div>

                    <div class="w-12 h-12 rounded-full mb-2 flex items-center justify-center text-lg font-bold text-white shadow-inner"
                         :class="member.role === 'admin' ? 'bg-gradient-to-br from-orange-400 to-deep-sea-blue' : 'bg-gradient-to-br from-ice-blue to-teal-500'">
                        {{ member.name.substring(0,1).toUpperCase() }}
                    </div>
                    <span class="font-bold text-slate-700 text-sm truncate w-full text-center">{{ member.name }}</span>
                </div>
            </div>
        </div>

        <!-- ‰∏ªÊáâÁî®Áï´Èù¢ -->
        <div v-else>
            <div class="header-bg relative">
                <div class="header-image-container">
                    <img src="banner.png" alt="ÊõºË∞∑ÂÆ∂ÊóèÊóÖË°åË®àÁï´" onerror="this.src='https://images.unsplash.com/photo-1596422846543-e1275c6fc197?auto=format&fit=crop&w=800&q=80'">
                </div>
                <div class="side-tab-bar">
                    <button @click="currentTab = 'itinerary'" title="Ë°åÁ®ã" :class="{'active': currentTab === 'itinerary'}" class="tab-button"><i class="fa-solid fa-map-location-dot"></i></button>
                    <button @click="currentTab = 'info'" title="Ë≥áË®ä" :class="{'active': currentTab === 'info'}" class="tab-button"><i class="fa-solid fa-circle-info"></i></button>
                    <button @click="currentTab = 'shopping'" title="Ë≥ºÁâ©" :class="{'active': currentTab === 'shopping'}" class="tab-button"><i class="fa-solid fa-basket-shopping"></i></button>
                    <button @click="currentTab = 'expenses'" title="Ëä±Ë≤ª" :class="{'active': currentTab === 'expenses'}" class="tab-button"><i class="fa-solid fa-coins"></i></button>
                </div>
            </div>

            <main class="p-4 app-main">
                <!-- Ë°åÁ®ã TabÔºàÁï•ÔºåËàá‰∏ä‰∏ÄÁâàÁõ∏ÂêåÔºâ -->
                <!-- ...ÈÄôË£°‰øùÁïô‰Ω†ÂéüÊú¨ÁöÑË°åÁ®ã / Ë≥ºÁâ© / Ëä±Ë≤ª Tab ÁöÑÂÖßÂÆπÔºàËàá‰∏ä‰∏ÄÁâàÁõ∏ÂêåÔºâ... -->
                <!-- ÁÇ∫‰∫ÜÁØáÂπÖÔºåÊ≠§Ëôï‰∏çÈáçË§áË≤ºË°åÁ®ã / Ë≥ºÁâ© / Ëä±Ë≤ªÁöÑ HTMLÔºåÁõ¥Êé•Áî®‰Ω†Ââç‰∏ÄÁâàÁöÑÈÇ£‰∏âÂÄã Tab Âç≥ÂèØ -->
                
                <!-- Ë≥áË®ä TabÔºàÈáçÊéíÁµêÊßãÔºöÂåØÁéá / Ëà™Áè≠ / ‰ΩèÂÆøÂú®‰∏äÔºå‰ΩøÁî®ËÄÖ & ÁÆ°ÁêÜÂú®ÊúÄ‰∏ãÔºâ -->
                <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in">
                    <!-- ÂåØÁéá -->
                    <div class="bg-gradient-to-r from-deep-sea-blue to-orange-700 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                        <div class="absolute bottom-0 left-0 w-32 h-32 bg-white/10 rounded-full -ml-10 -mb-10 blur-2xl"></div>
                        <h3 class="font-bold text-lg mb-4 flex items-center relative z-10"><i class="fa-solid fa-calculator mr-2"></i> ÂåØÁéáÊèõÁÆó</h3>
                        <div class="flex items-center justify-between space-x-3 relative z-10">
                            <div class="flex-1">
                                <label class="text-[10px] text-orange-200 block mb-1 uppercase tracking-wider">THB</label>
                                <input type="number" v-model.number="inputTHB" @input="updateTWD" class="w-full bg-white/20 border border-white/30 rounded-xl px-3 py-2.5 text-white placeholder-white focus:outline-none focus:bg-white/30 text-lg font-bold">
                            </div>
                            <i class="fa-solid fa-arrow-right-arrow-left text-orange-300 mt-5"></i>
                            <div class="flex-1">
                                <label class="text-[10px] text-orange-200 block mb-1 uppercase tracking-wider">TWD</label>
                                <input type="number" v-model.number="inputTWD" @input="updateTHB" class="w-full bg-white/10 border border-white/30 rounded-xl px-3 py-2.5 text-white placeholder-white focus:outline-none focus:bg-white/20 text-lg font-bold">
                            </div>
                        </div>
                        <p class="text-[10px] text-orange-200 mt-3 text-right relative z-10">1 THB = {{ EXCHANGE_RATE.toFixed(4) }} TWD</p>
                    </div>

                    <!-- Ëà™Áè≠ -->
                    <div class="bg-white rounded-3xl p-5 card-shadow">
                        <h3 class="font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2"><i class="fa-solid fa-plane-departure text-blue-500 mr-2"></i> Ëà™Áè≠Ë≥áË®ä</h3>
                        <div class="space-y-4">
                            <div class="bg-blue-50 rounded-xl p-3 border border-blue-100">
                                <div class="flex justify-between text-sm font-bold text-deep-sea-blue mb-1"><span>TPE Âè∞Âåó</span><i class="fa-solid fa-plane text-xs"></i><span>BKK ÊõºË∞∑</span></div>
                                <div class="flex justify-between text-xs text-slate-500"><span>10:05</span><span>CI0831 (1/16)</span><span>13:05</span></div>
                            </div>
                            <div class="bg-orange-50 rounded-xl p-3 border border-orange-100">
                                <div class="flex justify-between text-sm font-bold text-orange-800 mb-1"><span>BKK ÊõºË∞∑</span><i class="fa-solid fa-plane text-xs"></i><span>TPE Âè∞Âåó</span></div>
                                <div class="flex justify-between text-xs text-slate-500"><span>14:05</span><span>CI0832 (1/20)</span><span>18:40</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- ‰ΩèÂÆø -->
                    <div class="bg-white rounded-3xl p-6 card-shadow">
                        <h3 class="font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2"><i class="fa-solid fa-hotel text-rose-500 mr-2"></i> ‰ΩèÂÆøË≥áË®ä</h3>
                        <ul class="space-y-4">
                            <li v-for="hotel in hotels" :key="hotel.name" class="bg-rose-50 rounded-xl p-4 border border-rose-100">
                                <p class="font-bold text-deep-sea-blue mb-2">{{ hotel.name }}</p>
                                <p class="text-xs text-slate-500 mb-1 flex items-center"><i class="fa-solid fa-calendar-days w-4 text-center mr-2"></i> {{ hotel.date }}</p>
                                <p class="text-xs text-slate-500 mb-1 flex items-center"><i class="fa-solid fa-phone w-4 text-center mr-2"></i> {{ hotel.phone }}</p>
                                <p class="text-xs text-slate-500 flex items-center"><i class="fa-solid fa-location-dot w-4 text-center mr-2"></i> {{ hotel.address }}</p>
                            </li>
                        </ul>
                    </div>

                    <!-- ‰ΩøÁî®ËÄÖË≥áË®äÂç°ÔºöÊîæÂú®ÊúÄ‰∏ãÊñπ -->
                    <div class="bg-white rounded-3xl p-4 card-shadow flex items-center justify-between">
                        <div class="flex items-center space-x-3 w-full">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-100 to-white border border-indigo-50 flex items-center justify-center text-indigo-500 shadow-sm shrink-0">
                                 <i class="fa-solid fa-user-gear text-xl"></i>
                            </div>
                            <div class="flex-1 custom-select-wrapper">
                                 <p class="text-[10px] text-slate-400 font-medium tracking-wide">ÁõÆÂâçÊìç‰Ωú‰ΩøÁî®ËÄÖ</p>
                                 <select v-model="pendingUser" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                     <option v-for="m in members" :key="m.id" :value="m.name">{{ m.name }}</option>
                                 </select>
                                 <div class="flex items-center justify-between">
                                     <div class="min-w-0">
                                         <p class="text-lg font-bold text-slate-800 truncate">{{ currentUser }}</p>
                                     </div>
                                     <div class="bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100 flex items-center space-x-2 text-xs text-slate-500">
                                         <span>ÂàáÊèõ</span>
                                         <i class="fa-solid fa-chevron-down text-[10px]"></i>
                                     </div>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÁÆ°ÁêÜËÄÖÂ∞àÂ±¨Ôºö‰πüÂú®ÊúÄ‰∏ãÊñπÔºåÁ∑äÊé•Âú®‰ΩøÁî®ËÄÖÂç°ÁâáÂæå -->
                    <div v-if="currentUserRole === 'admin'" class="bg-gradient-to-br from-slate-700 to-slate-900 rounded-3xl p-5 card-shadow text-white">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold flex items-center"><i class="fa-solid fa-users-gear mr-2 text-accent-yellow"></i> ÊàêÂì°ÁÆ°ÁêÜÂæåÂè∞</h3>
                            <button @click="showMemberModal = true" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-xl text-sm font-bold transition-colors">
                                ÈÄ≤ÂÖ•ÁÆ°ÁêÜ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÂÖ∂È§òË≥ºÁâ© / Ëä±Ë≤ª Tab ‰øùÊåÅ‰∏çËÆäÔºà‰ΩøÁî®‰Ω†Ââç‰∏ÄÁâàÁöÑÂÖßÂÆπÔºâ -->

                <!-- ÊàêÂì°ÁÆ°ÁêÜ ModalÔºö‰øÆÊ≠£ÊéíÁâà‰∏çÊúÉË¢´ÂêçÁ®±ÊíêÂ£û -->
                <div v-if="showMemberModal" class="fixed inset-0 bg-slate-900/50 z-[70] flex flex-col items-center justify-end sm:justify-center animate-fade-in backdrop-blur-sm">
                    <div class="bg-white w-full sm:w-[480px] sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl h-[85vh] sm:h-auto sm:max-h-[85vh] flex flex-col">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-bold text-xl text-slate-800">ÊàêÂì°ÁÆ°ÁêÜÂæåÂè∞</h3>
                            <button @click="closeMemberModal" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200"><i class="fa-solid fa-times"></i></button>
                        </div>

                        <!-- ÊàêÂì°ÂàóË°®ÔºöÂ∑¶ÂÅ¥Âõ∫ÂÆö‰ΩîÊªøÔºåÂè≥ÂÅ¥Êìç‰ΩúÂõ∫ÂÆöÂØ¨Â∫¶ -->
                        <div class="flex-1 overflow-y-auto space-y-3 mb-4 pr-1">
                            <div v-for="m in members" :key="m.id" class="flex items-center justify-between bg-slate-50 rounded-2xl p-4 border border-slate-100 shadow-sm">
                                <!-- Â∑¶ÂÅ¥ÔºöÈ†≠ÂÉè + ÂêçÁ®± + ËßíËâ≤/ÁãÄÊÖã -->
                                <div class="flex items-center space-x-3 flex-1 min-w-0">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0"
                                         :class="m.role === 'admin' ? 'bg-orange-500' : 'bg-ice-blue'">
                                        {{ m.name.substring(0,1).toUpperCase() }}
                                    </div>
                                    <div class="flex flex-col min-w-0">
                                         <div class="flex items-center space-x-1 min-w-0">
                                            <template v-if="editingMemberId === m.id">
                                                <input v-model="tempMemberName" @keyup.enter="saveMemberName(m)" @blur="saveMemberName(m)" ref="editInput" class="w-full text-sm font-bold bg-white border border-blue-400 rounded px-2 py-1 outline-none">
                                            </template>
                                            <template v-else>
                                                <span class="font-bold text-slate-700 truncate max-w-[150px]">{{ m.name }}</span>
                                                <button @click="startEditMember(m)" class="text-slate-300 hover:text-blue-500 text-xs flex-shrink-0"><i class="fa-solid fa-pen"></i></button>
                                            </template>
                                         </div>
                                         <span class="text-[10px] text-slate-400 truncate">
                                            {{ m.role === 'admin' ? 'ÁÆ°ÁêÜÂì°' : '‰∏ÄËà¨ÊàêÂì°' }} 
                                            <span v-if="!m.active" class="text-red-400 ml-1">(Êú™ÂèÉËàá)</span>
                                         </span>
                                    </div>
                                </div>
                                
                                <!-- Âè≥ÂÅ¥ÔºöÂõ∫ÂÆöÂØ¨Â∫¶Êìç‰ΩúÊåâÈàïÂàó -->
                                <div class="flex items-center space-x-2 flex-shrink-0 w-[140px] justify-end">
                                    <!-- ÁãÄÊÖãÈñãÈóú -->
                                    <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" :id="'toggle-'+m.id" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer right-5" :checked="m.active" @change="toggleMemberActive(m)"/>
                                        <label :for="'toggle-'+m.id" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>

                                    <!-- ËßíËâ≤ÂàáÊèõ -->
                                    <button @click="updateMemberRole(m, m.role === 'admin' ? 'viewer' : 'admin')" 
                                            class="w-8 h-8 rounded-lg flex items-center justify-center transition-colors flex-shrink-0"
                                            :class="m.role === 'admin' ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-400'">
                                        <i class="fa-solid fa-crown text-xs"></i>
                                    </button>

                                    <!-- ÂØÜÁ¢ºË®≠ÂÆö -->
                                    <button @click="openSetPasswordMode(m)" 
                                            class="w-8 h-8 rounded-lg flex items-center justify-center transition-colors flex-shrink-0"
                                            :class="m.password ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-100 text-slate-400'">
                                        <i class="fa-solid fa-key text-xs"></i>
                                    </button>

                                    <!-- Âà™Èô§ -->
                                    <button v-if="m.name !== 'Êàë'" @click="removeMember(m.id)" 
                                            class="w-8 h-8 rounded-lg bg-red-50 text-red-400 hover:bg-red-500 hover:text-white transition-colors flex items-center justify-center flex-shrink-0">
                                        <i class="fa-solid fa-trash-can text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Êñ∞Â¢ûÊàêÂì° -->
                        <div class="mt-auto pt-4 border-t border-slate-100">
                            <div class="flex space-x-2">
                                <input v-model="newMemberName" @keyup.enter="addMember" placeholder="Ëº∏ÂÖ•Êñ∞ÊàêÂì°ÂêçÁ®±..." class="flex-1 bg-slate-50 rounded-xl px-4 py-3 text-sm outline-none border border-transparent focus:border-deep-sea-blue focus:bg-white transition-all">
                                <button @click="addMember" class="px-6 rounded-xl bg-deep-sea-blue text-white text-sm font-bold shadow-lg shadow-deep-sea-blue/20 hover:scale-105 transition-transform"><i class="fa-solid fa-plus mr-1"></i> Êñ∞Â¢û</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂØÜÁ¢º ModalÔºöz-[80]Ôºå‰∏çÊúÉË¢´ÁôªÂÖ•È†ÅÈÅÆ‰Ωè -->
                <div v-if="showRolePasswordModal" class="fixed inset-0 bg-slate-900/60 z-[80] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
                    <div class="bg-white rounded-3xl w-full max-w-xs p-6 shadow-2xl">
                        <div class="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-500">
                             <i class="fa-solid fa-shield-halved text-xl"></i>
                        </div>
                        <h3 class="font-bold text-base mb-2 text-center text-slate-800">
                            {{ 
                                passwordMode === 'role' ? 'ÈúÄË¶Å Admin Ê¨äÈôê' : 
                                passwordMode === 'loginAdmin' ? 'Admin Ë∫´‰ªΩÈ©óË≠â' : 
                                passwordMode === 'loginPersonal' ? `Ê≠°ËøéÂõû‰æÜÔºå${targetLoginMember?.name}` :
                                passwordMode === 'setPassword' ? `Ë®≠ÂÆö ${targetLoginMember?.name} ÁöÑÂØÜÁ¢º` : ''
                            }}
                        </h3>
                        <p class="text-xs text-center text-slate-400 mb-4">
                            {{ passwordMode === 'setPassword' ? 'Ë´ãË®≠ÂÆö‰∏ÄÁµÑÂè™ÊúâË©≤ÊàêÂì°Áü•ÈÅìÁöÑÂØÜÁ¢ºÔºåÁïôÁ©∫ÂâáÁßªÈô§‰øùË≠∑„ÄÇ' : 'ÁÇ∫‰∫ÜÁ¢∫‰øùÂÆâÂÖ®ÔºåË´ãËº∏ÂÖ•ÂØÜÁ¢º‰ª•ÁπºÁ∫å„ÄÇ' }}
                        </p>
                        
                        <input v-model="rolePasswordInput" 
                               :type="passwordMode === 'setPassword' ? 'text' : 'password'" 
                               :placeholder="passwordMode === 'setPassword' ? 'Ëº∏ÂÖ•Êñ∞ÂØÜÁ¢º (ÁïôÁ©∫ÁßªÈô§)' : 'Ë´ãËº∏ÂÖ•ÂØÜÁ¢º'" 
                               class="w-full bg-slate-50 rounded-xl p-3 text-center font-bold text-slate-700 outline-none border-2 border-slate-100 focus:border-indigo-500 focus:bg-white transition-all mb-4 tracking-widest">
                        
                        <div class="flex space-x-3">
                            <button @click="cancelRolePassword" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 text-sm font-bold hover:bg-slate-200">ÂèñÊ∂à</button>
                            <button @click="confirmRolePassword" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white text-sm font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700">Á¢∫Ë™ç</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ‰∏ªÁ®ãÂºè (JS) -->
    <script type="module">
        import { createApp, ref, computed, onMounted, nextTick, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyYCSGWQ0Wdf13AE62UG7W8WiwpqCHs_0",
            authDomain: "bankoktrip2026.firebaseapp.com",
            projectId: "bankoktrip2026",
            storageBucket: "bankoktrip2026.firebasestorage.app",
            messagingSenderId: "347622663908",
            appId: "1:347622663908:web:6a514d1761f215a2ae6ef1",
            measurementId: "G-ENHVD5XKF8"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);

        const app = createApp({
            setup() {
                const TRIP_YEAR = 2026;
                const EXCHANGE_RATE = ref(0.92);
                const WEATHER_API_KEY = 'e5e727b85066927db1d248be29dfa632';
                
                const currentTab = ref('itinerary');
                const selectedDateIndex = ref(0);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showItineraryModal = ref(false);
                const showMemberModal = ref(false);
                const isEditMode = ref(false);
                const inputTHB = ref(100);
                const inputTWD = ref(92);
                const expandedMember = ref(null);
                const editingMemberId = ref(null); 
                const tempMemberName = ref('');   
                const editInput = ref(null); 
                const recentlyMovedId = ref(null);
                
                const hasSelectedUser = ref(false);
                const currentUser = ref(''); 
                const pendingUser = ref(''); 
                const membersLoaded = ref(false);

                const isRoleEditMode = ref(false);
                const showRolePasswordModal = ref(false);
                const rolePasswordInput = ref('');
                const ROLE_PASSWORD = 'kappaho17';
                const roleEditUnlocked = ref(false);
                const passwordMode = ref('role');
                const targetLoginMember = ref(null);

                const dates = ref([
                    { date: '1/16', weekday: '‰∫î', hasCar: false },
                    { date: '1/17', weekday: 'ÂÖ≠', hasCar: false },
                    { date: '1/18', weekday: 'Êó•', hasCar: false },
                    { date: '1/19', weekday: '‰∏Ä', hasCar: false },
                    { date: '1/20', weekday: '‰∫å', hasCar: false }
                ]);
                const weatherData = ref([]);
                const itineraryData = ref([[], [], [], [], []]);
                
                const hotels = ref([
                    { name: 'The Quarter Ratchayothin By UHG', date: '1/16 - 1/20 (4Êôö)', phone: '+66 2 011 1888', address: 'Soi Ratchadaphisek 36, Chan Kasem, Chatuchak, Bangkok' }
                ]);

                const DEFAULT_MEMBERS = ['kappabooom', 'beibei1029', 'hsiannnnng', 'shinbinwei', 'aylwen4444', 'wunsin', 'rtrtr1', 'blackblacknu'];
                const members = ref([]);
                
                const allShoppingList = ref([]);
                const expenses = ref([]);
                const newMemberName = ref('');
                const editingExpenseId = ref(null);
                const newShoppingItem = ref({ name: '', checked: false });
                const newItinerary = ref({});
                const newExpense = ref({});

                const collapsedSections = ref({ expenses: false, split: true, transfer: true });
                const toggleSection = (key) => { collapsedSections.value[key] = !collapsedSections.value[key]; };

                const showToast = ref(false);
                const toastMessage = ref('');
                const triggerToast = (msg) => {
                    toastMessage.value = msg;
                    showToast.value = true;
                    setTimeout(() => { showToast.value = false; }, 3000);
                };

                const currentUserRole = computed(() => {
                    const m = members.value.find(m => m.name === currentUser.value);
                    return m?.role || 'viewer';
                });
                const canEditItinerary = computed(() => currentUserRole.value === 'admin');

                const currentShoppingList = computed(() => {
                    return allShoppingList.value.filter(item => item.owner === currentUser.value);
                });

                const transferSuggestions = computed(() => {
                    const balances = { ...memberBalances.value };
                    let debtors = [];
                    let creditors = [];
                    for (const [name, amount] of Object.entries(balances)) {
                        if (amount < -0.5) debtors.push({ name, amount });
                        if (amount > 0.5) creditors.push({ name, amount });
                    }
                    debtors.sort((a, b) => a.amount - b.amount);
                    creditors.sort((a, b) => b.amount - a.amount);
                    let suggestions = [];
                    let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let debtor = debtors[i];
                        let creditor = creditors[j];
                        let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                        if (amount > 0.5) {
                            suggestions.push({ from: debtor.name, to: creditor.name, amount: Math.round(amount) });
                        }
                        debtor.amount += amount;
                        creditor.amount -= amount;
                        if (Math.abs(debtor.amount) < 0.5) i++;
                        if (creditor.amount < 0.5) j++;
                    }
                    return suggestions;
                });

                const resetNewExpense = () => {
                    newExpense.value = { name: '', amount: null, category: 'food', date: '2026-01-16', payment: 'cash', currency: 'THB', payer: currentUser.value, splitMethod: 'personal', splitDetails: {} };
                };
                const formatNumber = (num) => num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
                
                onMounted(async () => {
                    const expensesCol = collection(db, 'expenses');
                    onSnapshot(expensesCol, (snapshot) => {
                        expenses.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    onSnapshot(collection(db, 'shopping_list'), (snapshot) => {
                        allShoppingList.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    const membersCol = collection(db, 'members');
                    onSnapshot(membersCol, async (snapshot) => {
                        if (!snapshot.empty) {
                            members.value = snapshot.docs.map(doc => {
                                const data = doc.data();
                                return {
                                    id: doc.id,
                                    name: data.name,
                                    active: data.active,
                                    role: data.role || 'viewer',
                                    password: data.password || '' 
                                };
                            });
                            membersLoaded.value = true;
                            if (!currentUser.value && members.value.length > 0) {
                                pendingUser.value = members.value[0].name;
                            }
                        } else {
                            for (const name of DEFAULT_MEMBERS) {
                                await addDoc(membersCol, { name, active: true, role: 'viewer', password: '' });
                            }
                        }
                    });

                    for(let i=0; i<dates.value.length; i++) {
                        const itineraryCol = collection(db, `itinerary_day_${i}`);
                        onSnapshot(itineraryCol, async (snapshot) => {
                            let items = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id, isNoteExpanded: false, order: doc.data().order ?? 9999 }));
                            itineraryData.value[i] = items;
                        });
                    }

                    await fetchExchangeRate();
                    await fetchWeather();
                    
                    setTimeout(() => {
                        const loader = document.getElementById('loading-screen');
                        if(loader) loader.classList.add('hidden');
                    }, 1500);
                });
                
                watch(pendingUser, (newVal, oldVal) => {
                    if (newVal && newVal !== currentUser.value && membersLoaded.value) {
                         const member = members.value.find(m => m.name === newVal);
                         if (member) {
                             attemptLogin(member);
                         }
                    }
                });

                const attemptLogin = (member) => {
                    targetLoginMember.value = member;
                    
                    if (member.role === 'admin') {
                        passwordMode.value = 'loginAdmin';
                        rolePasswordInput.value = '';
                        showRolePasswordModal.value = true;
                    } else if (member.password && member.password.trim() !== '') {
                        passwordMode.value = 'loginPersonal';
                        rolePasswordInput.value = '';
                        showRolePasswordModal.value = true;
                    } else {
                        performLogin(member);
                    }
                };

                const performLogin = (member) => {
                    currentUser.value = member.name;
                    pendingUser.value = member.name; 
                    hasSelectedUser.value = true;
                    triggerToast(`Ê≠°ËøéÂõû‰æÜÔºå${member.name}`);
                };

                const fetchExchangeRate = async () => { 
                    try { 
                        const r = await fetch('https://open.er-api.com/v6/latest/THB'); 
                        const d = await r.json(); 
                        if(d && d.rates && d.rates.TWD) EXCHANGE_RATE.value = Number(d.rates.TWD); 
                    } catch(e) { console.error('ÂåØÁéáÂ§±Êïó', e); } 
                };
                
                const fetchWeather = async () => { 
                    const tripStart = new Date(TRIP_YEAR, 0, 16); 
                    const now = new Date(); 
                    const diffDays = (tripStart - now) / (1000 * 60 * 60 * 24); 
                    
                    if (diffDays > 5) { 
                        const HISTORICAL_JAN = [
                            { condition: 'sunny', temp: '32/23', feel: '34', isFallback: true }, 
                            { condition: 'sunny', temp: '33/24', feel: '35', isFallback: true }, 
                            { condition: 'cloudy', temp: '32/23', feel: '34', isFallback: true }, 
                            { condition: 'sunny', temp: '32/22', feel: '33', isFallback: true }, 
                            { condition: 'sunny', temp: '33/23', feel: '35', isFallback: true }
                        ]; 
                        weatherData.value = HISTORICAL_JAN; 
                        return; 
                    } 
                    try { 
                        const url = `https://api.openweathermap.org/data/2.5/forecast?q=Bangkok,TH&appid=${WEATHER_API_KEY}&units=metric&lang=zh_tw`; 
                        const resp = await fetch(url); 
                        const data = await resp.json(); 
                        if (!data.list) throw new Error('No list'); 
                        const grouped = {}; 
                        data.list.forEach(i => { 
                            const d = new Date(i.dt*1000).getDate(); 
                            if(!grouped[d]) grouped[d] = []; 
                            grouped[d].push(i); 
                        }); 
                        const mapCondition = (m) => (['Rain','Drizzle','Thunderstorm'].includes(m)?'rain':(m==='Clouds'?'cloudy':'sunny')); 
                        const processed = Object.values(grouped).slice(0,5).map(dayList => { 
                            const temps = dayList.map(i=>i.main.temp); 
                            const max = Math.round(Math.max(...temps)); 
                            const min = Math.round(Math.min(...temps)); 
                            const feel = Math.round(dayList[0].main.feels_like); 
                            const cond = mapCondition(dayList[0].weather[0].main); 
                            return { condition: cond, temp: `${max}/${min}`, feel, isFallback: false }; 
                        }); 
                        weatherData.value = dates.value.map((d, i) => processed[i % processed.length] || processed[0]); 
                    } catch (err) { 
                        weatherData.value = Array(5).fill({ condition: 'sunny', temp: '32/24', feel: '35', isFallback: true }); 
                    } 
                };
                
                const currentItinerary = computed(() => (itineraryData.value[selectedDateIndex.value] || []).sort((a,b) => (a.order || 999) - (b.order || 999)));
                const splitMembers = computed(() => members.value.filter(m => m.active).map(m => m.name));
                const myExpenses = computed(() => { 
                    return expenses.value.filter(exp => { 
                        if (exp.payer === currentUser.value) return true; 
                        if (exp.splitMethod === 'equal' && members.value.find(m=>m.name===currentUser.value && m.active)) return true; 
                        if (exp.splitMethod === 'amount' || exp.splitMethod === 'ratio') return exp.splitDetails && Number(exp.splitDetails[currentUser.value]) > 0; 
                        return false; 
                    }).map(exp => { 
                        let myShare = 0; 
                        const totalAmount = Number(exp.amount) || 0; 
                        if (exp.payer === currentUser.value && exp.splitMethod === 'personal') myShare = totalAmount; 
                        else if (exp.splitMethod === 'equal') { 
                            const activeCount = members.value.filter(m => m.active).length || 1; 
                            myShare = Math.round(totalAmount / activeCount); 
                        } else if (exp.splitMethod === 'amount') myShare = Number(exp.splitDetails[currentUser.value]) || 0; 
                        else if (exp.splitMethod === 'ratio') { 
                            const totalRatio = Object.values(exp.splitDetails).reduce((sum, r) => sum + (Number(r) || 0), 0); 
                            const myRatio = Number(exp.splitDetails[currentUser.value]) || 0; 
                            if (totalRatio > 0) myShare = (totalAmount * myRatio) / totalRatio; 
                        } 
                        return { ...exp, displayAmount: myShare }; 
                    }).sort((a,b) => new Date(b.date) - new Date(a.date)); 
                });
                
                const totalTHB = computed(() => myExpenses.value.filter(e => e.currency === 'THB').reduce((sum, e) => sum + (Number(e.displayAmount) || 0), 0));
                const totalTWD = computed(() => myExpenses.value.filter(e => e.currency === 'TWD').reduce((sum, e) => sum + (Number(e.displayAmount) || 0), 0));
                const finalTotalTWD = computed(() => Math.round(totalTWD.value + (totalTHB.value * EXCHANGE_RATE.value)));
                const memberBalances = computed(() => { 
                    const balances = {}; 
                    members.value.forEach(m => { balances[m.name] = 0; }); 
                    expenses.value.forEach(exp => { 
                        const amountInTWD = exp.currency === 'TWD' ? (Number(exp.amount) || 0) : (Number(exp.amount) || 0) * EXCHANGE_RATE.value; 
                        if (balances[exp.payer] !== undefined) balances[exp.payer] += amountInTWD; 
                        switch (exp.splitMethod) { 
                            case 'equal': 
                                const participants = members.value.filter(m => m.active).map(m => m.name); 
                                const count = participants.length; 
                                if (count > 0) { 
                                    const share = amountInTWD / count; 
                                    participants.forEach(name => { if(balances[name] !== undefined) balances[name] -= share; }); 
                                } 
                                break; 
                            case 'personal': 
                                if (balances[exp.payer] !== undefined) balances[exp.payer] -= amountInTWD; 
                                break; 
                            case 'amount': 
                                for(const name in exp.splitDetails) { 
                                    const debt = exp.currency === 'TWD' ? (Number(exp.splitDetails[name]) || 0) : (Number(exp.splitDetails[name]) || 0) * EXCHANGE_RATE.value; 
                                    if(balances[name] !== undefined) balances[name] -= debt; 
                                } 
                                break; 
                            case 'ratio': 
                                const totalR = Object.values(exp.splitDetails).reduce((s, r) => s + Number(r||0), 0); 
                                if(totalR > 0) for(const name in exp.splitDetails) { 
                                    const s = (amountInTWD * (Number(exp.splitDetails[name])||0)) / totalR; 
                                    if(balances[name] !== undefined) balances[name] -= s; 
                                } 
                                break; 
                        } 
                    }); 
                    return balances; 
                });

                const handleAddClick = () => { 
                    if (currentTab.value === 'shopping') { 
                        showShoppingModal.value = true; 
                    } else if (currentTab.value === 'expenses') { 
                        editingExpenseId.value = null; 
                        resetNewExpense(); 
                        showExpenseModal.value = true; 
                    } else if (currentTab.value === 'itinerary') { 
                        if (!canEditItinerary.value) { 
                            triggerToast('‰Ω†ÁõÆÂâçÊòØ ViewerÔºåÁÑ°Ê≥ïÁ∑®ËºØË°åÁ®ã'); 
                            return; 
                        } 
                        isEditMode.value = false; 
                        const maxOrder = currentItinerary.value.length > 0 ? Math.max(...currentItinerary.value.map(i => i.order || 0)) : -1; 
                        newItinerary.value = { category: 'sightseeing', name: '', startTime: '', order: maxOrder + 1 }; 
                        showItineraryModal.value = true; 
                    } 
                };

                const saveExpense = async () => { 
                    if (!newExpense.value.name || !newExpense.value.amount) { 
                        triggerToast('‚ùå Ë´ãËº∏ÂÖ•ÂêçÁ®±ËàáÈáëÈ°ç'); 
                        return; 
                    } 
                    const data = JSON.parse(JSON.stringify(newExpense.value)); 
                    try { 
                        if (editingExpenseId.value === null) { 
                            await addDoc(collection(db, 'expenses'), data); 
                            triggerToast('‚úÖ ÊîØÂá∫Êñ∞Â¢ûÊàêÂäüÔºÅ'); 
                        } else { 
                            await updateDoc(doc(db, 'expenses', editingExpenseId.value), data); 
                            triggerToast('‚úÖ ÊîØÂá∫Êõ¥Êñ∞ÊàêÂäüÔºÅ'); 
                        } 
                        showExpenseModal.value = false; 
                        editingExpenseId.value = null; 
                    } catch (e) { 
                        console.error('Save failed:', e); 
                        triggerToast('‚ùå ÂÑ≤Â≠òÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑Ø'); 
                    } 
                };

                const removeExpense = async (id) => { 
                    if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÊîØÂá∫ÂóéÔºü')) { 
                        await deleteDoc(doc(db, 'expenses', id)); 
                        triggerToast('üóëÔ∏è ÊîØÂá∫Â∑≤Âà™Èô§'); 
                    } 
                };

                const addMember = async () => { 
                    if(newMemberName.value && !members.value.find(m=>m.name === newMemberName.value)) { 
                        await addDoc(collection(db, 'members'), {name: newMemberName.value, active: true, role: 'viewer', password: ''}); 
                        newMemberName.value=''; 
                    } 
                };

                const startEditMember = (m) => { 
                    editingMemberId.value = m.id; 
                    tempMemberName.value = m.name; 
                    nextTick(() => { 
                        const input = document.querySelector('input[type="text"][autofocus]'); 
                        if (input) input.focus(); 
                    }); 
                };

                const saveMemberName = async (m) => { 
                    if (editingMemberId.value === null) return; 
                    if (tempMemberName.value && tempMemberName.value !== m.name) { 
                        await updateDoc(doc(db, 'members', m.id), { name: tempMemberName.value }); 
                        triggerToast('‚úÖ ÊàêÂì°ÂêçÁ®±Â∑≤Êõ¥Êñ∞'); 
                    } 
                    editingMemberId.value = null; 
                    tempMemberName.value = ''; 
                };
                
                const toggleMemberActive = async (m) => await updateDoc(doc(db, 'members', m.id), {active: !m.active});
                const removeMember = async (id) => { if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÊàêÂì°ÂóéÔºü')) await deleteDoc(doc(db, 'members', id)); };
                const addShoppingItem = async () => { if(newShoppingItem.value.name) { await addDoc(collection(db, 'shopping_list'), { name: newShoppingItem.value.name, checked: false, owner: currentUser.value }); newShoppingItem.value.name=''; showShoppingModal.value=false; triggerToast('‚úÖ ÂïÜÂìÅÂ∑≤Âä†ÂÖ•'); } };
                const toggleShoppingItem = async (item) => { await updateDoc(doc(db, 'shopping_list', item.id), { checked: !item.checked }); };
                const removeShoppingItem = async (id) => { if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÂïÜÂìÅÂóéÔºü')) { await deleteDoc(doc(db, 'shopping_list', id)); triggerToast('üóëÔ∏è ÂïÜÂìÅÂ∑≤Âà™Èô§'); } };
                
                const saveItineraryItem = async () => { 
                    if (!canEditItinerary.value) { 
                        triggerToast('‰Ω†ÁõÆÂâçÊòØ ViewerÔºåÁÑ°Ê≥ïÁ∑®ËºØË°åÁ®ã'); 
                        return; 
                    } 
                    if(!newItinerary.value.name) return; 
                    const dataToSave = JSON.parse(JSON.stringify(newItinerary.value)); 
                    delete dataToSave.isNoteExpanded; 
                    const col = collection(db, `itinerary_day_${selectedDateIndex.value}`); 
                    if(isEditMode.value) { 
                        await updateDoc(doc(col, dataToSave.id), dataToSave); 
                    } else { 
                        await addDoc(col, dataToSave); 
                    } 
                    showItineraryModal.value=false; 
                };

                const removeItineraryItem = async (id) => { 
                    if (!canEditItinerary.value) { 
                        triggerToast('‰Ω†ÁõÆÂâçÊòØ ViewerÔºåÁÑ°Ê≥ïÁ∑®ËºØË°åÁ®ã'); 
                        return; 
                    } 
                    if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãË°åÁ®ãÂóéÔºü')) { 
                        await deleteDoc(doc(db, `itinerary_day_${selectedDateIndex.value}`, id)); 
                        showItineraryModal.value=false; 
                    } 
                };

                const moveItem = async (visualIndex, direction, itemId) => { 
                    if (!canEditItinerary.value) { 
                        triggerToast('‰Ω†ÁõÆÂâçÊòØ ViewerÔºåÁÑ°Ê≥ïÁ∑®ËºØË°åÁ®ã'); 
                        return; 
                    } 
                    recentlyMovedId.value = itemId; 
                    const sortedList = [...currentItinerary.value]; 
                    const targetIndex = visualIndex + direction; 
                    if (targetIndex < 0 || targetIndex >= sortedList.length) { 
                        recentlyMovedId.value = null; 
                        return; 
                    } 
                    const itemA = sortedList[visualIndex]; 
                    const itemB = sortedList[targetIndex]; 
                    const orderA = itemA.order ?? visualIndex; 
                    const orderB = itemB.order ?? targetIndex; 
                    itemA.order = orderB; 
                    itemB.order = orderA; 
                    setTimeout(() => { recentlyMovedId.value = null; }, 1000); 
                    const batch = writeBatch(db); 
                    const col = collection(db, `itinerary_day_${selectedDateIndex.value}`); 
                    batch.update(doc(col, itemA.id), { order: itemA.order }); 
                    batch.update(doc(col, itemB.id), { order: itemB.order }); 
                    await batch.commit(); 
                };

                const confirmRolePassword = async () => {
                    const input = rolePasswordInput.value;

                    if (passwordMode.value === 'role') {
                        if (input === ROLE_PASSWORD) {
                            isRoleEditMode.value = true;
                            roleEditUnlocked.value = true;
                            triggerToast('Â∑≤ÂïüÁî®ËßíËâ≤ÁÆ°ÁêÜÊ®°Âºè');
                            closePasswordModal();
                        } else {
                            triggerToast('Admin ÂØÜÁ¢ºÈåØË™§');
                        }
                    } 
                    else if (passwordMode.value === 'loginAdmin') {
                        if (input === ROLE_PASSWORD) {
                            performLogin(targetLoginMember.value);
                            closePasswordModal();
                        } else {
                            triggerToast('Admin ÂØÜÁ¢ºÈåØË™§');
                        }
                    }
                    else if (passwordMode.value === 'loginPersonal') {
                        if (input === targetLoginMember.value.password) {
                            performLogin(targetLoginMember.value);
                            closePasswordModal();
                        } else {
                            triggerToast('ÂØÜÁ¢ºÈåØË™§');
                        }
                    }
                    else if (passwordMode.value === 'setPassword') {
                        if (targetLoginMember.value) {
                            try {
                                await updateDoc(doc(db, 'members', targetLoginMember.value.id), { password: input });
                                triggerToast(input ? 'Â∑≤Ë®≠ÂÆöÂÄã‰∫∫ÂØÜÁ¢º' : 'Â∑≤ÁßªÈô§ÂÄã‰∫∫ÂØÜÁ¢º');
                                closePasswordModal();
                            } catch (e) {
                                triggerToast('ÂÑ≤Â≠òÂ§±Êïó');
                            }
                        }
                    }
                };

                const closePasswordModal = () => {
                    showRolePasswordModal.value = false;
                    rolePasswordInput.value = '';
                    targetLoginMember.value = null;
                    passwordMode.value = 'role';
                    pendingUser.value = currentUser.value; 
                };

                const cancelRolePassword = () => {
                    closePasswordModal();
                };

                const openRolePasswordMode = () => {
                    passwordMode.value = 'role';
                    rolePasswordInput.value = '';
                    showRolePasswordModal.value = true;
                };

                const openSetPasswordMode = (m) => {
                    targetLoginMember.value = m;
                    passwordMode.value = 'setPassword';
                    rolePasswordInput.value = ''; 
                    showRolePasswordModal.value = true;
                };

                const updateMemberRole = async (m, role) => {
                    try { 
                        await updateDoc(doc(db, 'members', m.id), { role }); 
                        triggerToast(`${m.name} Â∑≤Ë®≠ÁÇ∫ ${role === 'admin' ? 'Admin' : 'Viewer'}`); 
                    } catch (e) { 
                        console.error(e); 
                        triggerToast('Êõ¥Êñ∞ËßíËâ≤Â§±Êïó'); 
                    }
                };

                const closeMemberModal = () => { showMemberModal.value = false; isRoleEditMode.value = false; roleEditUnlocked.value = false; };
                const updateTWD = () => inputTWD.value = Math.round(inputTHB.value * EXCHANGE_RATE.value);
                const updateTHB = () => inputTHB.value = Math.round(inputTWD.value / EXCHANGE_RATE.value);
                const toggleMemberDetails = (n) => expandedMember.value = expandedMember.value===n ? null : n;
                const getMemberPaidExpenses = (n) => expenses.value.filter(e => e.payer===n && e.splitMethod!=='personal');
                const startEditExpense = (id, exp) => { editingExpenseId.value=id; newExpense.value=JSON.parse(JSON.stringify(exp)); delete newExpense.value.id; if(!newExpense.value.splitDetails) newExpense.value.splitDetails={}; showExpenseModal.value=true; };
                const closeExpenseModal = () => { showExpenseModal.value=false; editingExpenseId.value=null; };
                const getCategoryIcon = (c) => ({sightseeing:'fa-solid fa-camera', food:'fa-solid fa-utensils', shopping:'fa-solid fa-bag-shopping', accommodation:'fa-solid fa-bed', transport:'fa-solid fa-van-shuttle', ticket:'fa-solid fa-ticket', flight:'fa-solid fa-plane', other:'fa-solid fa-circle-dot'}[c]||'fa-solid fa-circle-dot');
                const getTransportIcon = (t) => ({car:'fa-solid fa-car', walk:'fa-solid fa-person-walking', public:'fa-solid fa-train-subway'}[t]||'fa-solid fa-arrow-right');
                const getCategoryColor = (c) => ({sightseeing:'#FF7043', food:'#FFA726', shopping:'#EC407A', accommodation:'#5C6BC0', transport:'#78909C', ticket:'#8D6E63', flight:'#29B6F6', other: '#9E9E9E'}[c]||'#BDBDBD');
                const getWeatherIcon = (c) => ({sunny:'fa-solid fa-sun', cloudy:'fa-solid fa-cloud-sun', rain:'fa-solid fa-cloud-showers-heavy'}[c]||'fa-solid fa-sun');
                const getWeatherDescription = (c) => ({sunny:'Êô¥ÊúóÁÇéÁÜ±', cloudy:'Â§öÈõ≤ÂÅ∂Êô¥', rain:'ÂçàÂæåÈõ∑Èô£Èõ®'}[c]||'Êô¥Êúó');
                const editItem = (i) => { if (!canEditItinerary.value) { triggerToast('‰Ω†ÁõÆÂâçÊòØ ViewerÔºåÁÑ°Ê≥ïÁ∑®ËºØË°åÁ®ã'); return; } isEditMode.value=true; newItinerary.value=JSON.parse(JSON.stringify(i)); showItineraryModal.value=true; };

                resetNewExpense();

                return {
                    currentTab, selectedDateIndex, showShoppingModal, showExpenseModal, showItineraryModal, showMemberModal,
                    isEditMode, editingExpenseId, expandedMember,
                    dates, weatherData, currentItinerary, hotels, expenses, members,
                    newShoppingItem, newExpense, newItinerary, newMemberName,
                    splitMembers, myExpenses, totalTHB, totalTWD, finalTotalTWD, memberBalances, EXCHANGE_RATE,
                    inputTHB, inputTWD, updateTWD, updateTHB, currentUser, currentShoppingList,
                    formatNumber, getCategoryIcon, handleAddClick, addMember, toggleMemberActive, removeMember,
                    toggleMemberDetails, getMemberPaidExpenses,
                    startEditExpense, saveExpense, removeExpense, closeExpenseModal,
                    addShoppingItem, removeShoppingItem, toggleShoppingItem,
                    saveItineraryItem, removeItineraryItem, editItem,
                    getWeatherIcon, getWeatherDescription, getTransportIcon, getCategoryColor,
                    collapsedSections, toggleSection, transferSuggestions,
                    showToast, toastMessage, triggerToast,
                    editingMemberId, tempMemberName, startEditMember, saveMemberName, editInput, moveItem, recentlyMovedId,
                    isRoleEditMode, showRolePasswordModal, rolePasswordInput, confirmRolePassword, cancelRolePassword,
                    updateMemberRole, closeMemberModal, openRolePasswordMode,
                    currentUserRole, canEditItinerary, 
                    hasSelectedUser, attemptLogin, targetLoginMember, passwordMode, openSetPasswordMode,
                    pendingUser, membersLoaded
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
