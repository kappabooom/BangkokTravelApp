<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>2026曼谷旅行</title>

    <!-- Apple Touch Icon -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />
    <link rel="icon" type="image/png" href="apple-touch-icon.png" />

    <!-- UI 函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "snow-white": "#FFFDE7",
                        "ice-blue": "#4DB6AC",
                        "light-snow-blue": "#FFF3E0",
                        "deep-sea-blue": "#E65100",
                        "accent-yellow": "#FFB300",
                        "soft-gray": "#FAFAFA",
                    },
                },
            },
        };
    </script>

    <style>
        @import url("https://fonts.googleapis.com/css?family=Noto+Sans+TC:wght@300;400;500;700&display=swap");
        body {
            background-color: #fff3e0;
            -webkit-tap-highlight-color: transparent;
            font-family: "Noto Sans TC", sans-serif;
            color: #334155;
        }
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-bottom: 90px;
        }

        .login-screen {
            position: fixed;
            inset: 0;
            z-index: 60;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .header-bg {
            background-color: #ffffff;
            padding: 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-bottom-left-radius: 35px;
            border-bottom-right-radius: 35px;
            z-index: 50;
        }
        .header-image-container {
            width: 100%;
            height: 250px;
            overflow: hidden;
            background-color: transparent;
            border-bottom-left-radius: 35px;
            border-bottom-right-radius: 35px;
        }
        .header-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .side-tab-bar {
            position: absolute;
            bottom: 15px;
            right: 16px;
            z-index: 60;
            display: flex;
            flex-direction: row;
            gap: 8px;
        }
        .tab-button {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            transition: all 0.2s ease;
            cursor: pointer;
            border-width: 1px;
        }
        .tab-button.active {
            background-color: #e65100;
            color: #ffffff;
            border-color: #e65100;
            box-shadow: 0 6px 15px rgba(230, 81, 0, 0.4);
            transform: scale(1.05);
        }
        .tab-button:not(.active) {
            background-color: #FFF3E0;
            color: #E65100;
            border-color: #FFCC80;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .app-main {
            padding-top: 25px !important;
            position: relative;
            z-index: 5;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(230, 81, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fab-shadow {
            box-shadow: 0 4px 15px rgba(255, 179, 0, 0.5);
        }
        .expenses-banner {
            background: linear-gradient(135deg, #ff7043 0%, #ab47bc 100%);
        }
        .date-selector-sticky {
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0;
            z-index: 40;
            top: 0;
            position: sticky;
            padding-top: env(safe-area-inset-top, 20px);
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .custom-select-wrapper {
            position: relative;
        }
        .custom-select-wrapper select {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 100%;
            opacity: 0;
            position: absolute;
            left: 0;
            top: 0;
            cursor: pointer;
            z-index: 10;
        }
        .pulse-arrow {
            animation: pulse-x 1.5s infinite ease-in-out;
        }
        @keyframes pulse-x {
            0%,
            100% {
                transform: translateX(0);
                opacity: 0.8;
            }
            50% {
                transform: translateX(5px);
                opacity: 1;
            }
        }

        .flip-list-move {
            transition: transform 0.5s cubic-bezier(0.2, 0, 0, 1);
            z-index: 1;
            position: relative;
        }
        .flip-list-enter-active,
        .flip-list-leave-active {
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        }
        .flip-list-enter-from,
        .flip-list-leave-to {
            opacity: 0;
            transform: scale(0.95);
        }
        .highlight-bg {
            animation: highlight 1s ease-out forwards;
        }
        @keyframes highlight {
            0% {
                background-color: #fff8e1;
                transform: scale(1.02);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            }
            100% {
                background-color: #ffffff;
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(230, 81, 0, 0.1);
            }
        }

        .loader-container {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background-color: #fff3e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .loader-container.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(230, 81, 0, 0.2);
            border-top-color: #e65100;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        .loader-logo {
            font-size: 3rem;
            color: #e65100;
            margin-bottom: 1rem;
            animation: pulse-logo 1.5s infinite ease-in-out;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        @keyframes pulse-logo {
            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loader-container">
        <i class="fa-solid fa-plane-departure loader-logo"></i>
        <div class="spinner"></div>
        <p class="text-deep-sea-blue font-bold tracking-widest text-sm">
            Loading...
        </p>
    </div>

    <div id="app" class="app-container">
        <!-- 登入畫面 -->
        <div v-if="!hasSelectedUser" class="login-screen animate-fade-in p-6">
            <div class="text-center mb-8">
                <div
                    class="w-24 h-24 bg-white rounded-full mx-auto shadow-lg flex items-center justify-center mb-4"
                >
                    <i class="fa-solid fa-plane-up text-4xl text-deep-sea-blue"></i>
                </div>
            </div>

            <div v-if="members.length === 0" class="flex flex-col items-center">
                <div class="spinner w-8 h-8 border-2"></div>
                <span class="text-xs text-slate-400">正在讀取成員...</span>
            </div>

            <div v-else class="grid grid-cols-2 gap-4 w-full max-w-sm">
                <div
                    v-for="member in members"
                    :key="member.id"
                    @click="attemptLogin(member)"
                    class="bg-white p-4 rounded-2xl shadow-sm border border-orange-100 flex flex-col items-center justify-center cursor-pointer hover:shadow-md hover:scale-105 transition-all relative overflow-hidden group"
                >
                    <div
                        class="absolute top-0 right-0 p-2"
                        v-if="member.role === 'admin' || member.password"
                    >
                        <i
                            v-if="member.role === 'admin'"
                            class="fa-solid fa-crown text-[10px] text-yellow-500 bg-yellow-100 p-1 rounded-full"
                        ></i>
                        <i
                            v-else-if="member.password"
                            class="fa-solid fa-lock text-[10px] text-slate-400 bg-slate-100 p-1 rounded-full"
                        ></i>
                    </div>

                    <div
                        class="w-12 h-12 rounded-full mb-2 flex items-center justify-center text-lg font-bold text-white shadow-inner"
                        :class="member.role === 'admin'
                                ? 'bg-gradient-to-br from-orange-400 to-deep-sea-blue'
                                : 'bg-gradient-to-br from-ice-blue to-teal-500'"
                    >
                        {{ member.name.substring(0, 1).toUpperCase() }}
                    </div>
                    <span
                        class="font-bold text-slate-700 text-sm truncate w-full text-center"
                        >{{ member.name }}</span
                    >
                </div>
            </div>
        </div>

        <!-- 主畫面 -->
        <div v-else>
            <div class="header-bg relative">
                <div class="header-image-container">
                    <img
                        src="banner.png"
                        alt="曼谷家族旅行計畫"
                        onerror="this.src='https://images.unsplash.com/photo-1596422846543-e1275c6fc197?auto=format&fit=crop&w=800&q=80'"
                    />
                </div>
                <div class="side-tab-bar">
                    <button
                        @click="currentTab = 'itinerary'"
                        title="行程"
                        :class="{ active: currentTab === 'itinerary' }"
                        class="tab-button"
                    >
                        <i class="fa-solid fa-map-location-dot"></i>
                    </button>
                    <button
                        @click="currentTab = 'info'"
                        title="資訊"
                        :class="{ active: currentTab === 'info' }"
                        class="tab-button"
                    >
                        <i class="fa-solid fa-circle-info"></i>
                    </button>
                    <button
                        @click="currentTab = 'shopping'"
                        title="購物"
                        :class="{ active: currentTab === 'shopping' }"
                        class="tab-button"
                    >
                        <i class="fa-solid fa-basket-shopping"></i>
                    </button>
                    <button
                        @click="currentTab = 'expenses'"
                        title="花費"
                        :class="{ active: currentTab === 'expenses' }"
                        class="tab-button"
                    >
                        <i class="fa-solid fa-coins"></i>
                    </button>
                </div>
            </div>

            <main class="p-4 app-main">
                <!-- 行程 Tab -->
                <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
                    <div
                        class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 snap-x sticky date-selector-sticky pt-1 -mx-4 px-4"
                    >
                        <div
                            v-for="(day, index) in dates"
                            :key="index"
                            @click="selectedDateIndex = index"
                            class="snap-center flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                            :class="selectedDateIndex === index
                                    ? 'bg-deep-sea-blue text-white border-deep-sea-blue shadow-lg scale-105'
                                    : 'bg-white text-slate-400 border-white hover:bg-soft-gray'"
                        >
                            <span
                                class="text-sm font-bold uppercase tracking-wider"
                                >{{ day.weekday }}</span
                            >
                            <span
                                class="text-xs font-medium opacity-70"
                                >{{ day.date }}</span
                            >
                        </div>
                    </div>

                    <!-- 天氣 -->
                    <div
                        v-if="weatherData[selectedDateIndex]"
                        class="mb-4 bg-sky-50 border border-sky-200 rounded-2xl p-4 flex justify-between items-center shadow-md animate-fade-in"
                    >
                        <div class="flex items-start text-sky-700 space-x-4">
                            <i
                                :class="
                                    getWeatherIcon(
                                        weatherData[selectedDateIndex].condition
                                    )
                                "
                                class="text-5xl text-accent-yellow"
                            ></i>
                            <div class="pt-1">
                                <span class="text-3xl font-extrabold leading-none"
                                    >{{ weatherData[selectedDateIndex].temp.split('/')[0]
                                    }}°</span
                                >
                                <span
                                    class="text-sm font-light text-slate-500 ml-1"
                                    >/ {{
                                        weatherData[selectedDateIndex].temp.split(
                                            "/"
                                        )[1]
                                    }}°C</span
                                >
                                <span class="block text-xs text-slate-600 mt-1"
                                    >體感:
                                    {{
                                        weatherData[selectedDateIndex].feel
                                    }}°C</span
                                >
                            </div>
                        </div>
                        <div class="text-right text-xs text-slate-600 pl-3">
                            <span
                                class="font-bold block text-slate-700"
                                >{{
                                    getWeatherDescription(
                                        weatherData[selectedDateIndex].condition
                                    )
                                }}</span
                            >
                            <span
                                v-if="weatherData[selectedDateIndex].isFallback"
                                class="block text-[11px] text-orange-500 mt-1 bg-orange-100 px-2 py-1 rounded inline-block"
                                >1月歷史平均<br />(距出發大於5天)</span
                            >
                            <span
                                v-else
                                class="block text-[11px] text-emerald-600 mt-1 bg-emerald-100 px-2 py-1 rounded inline-block"
                                >即時天氣預報<br />(出發前5天更新)</span
                            >
                            <span
                                v-if="dates[selectedDateIndex].hasCar"
                                class="mt-1 block text-deep-sea-blue font-bold"
                                ><i
                                    class="fa-solid fa-car-side mr-1 text-accent-yellow"
                                ></i>
                                租車日</span
                            >
                        </div>
                    </div>

                    <!-- 行程列表 -->
                    <TransitionGroup
                        name="flip-list"
                        tag="div"
                        class="space-y-4 relative"
                    >
                        <div
                            v-for="(item, idx) in currentItinerary"
                            :key="item.id"
                            class="relative group"
                        >
                            <!-- 交通連線 -->
                            <div
                                v-if="idx > 0"
                                class="pl-10 pb-2 flex items-center text-xs text-slate-400"
                            >
                                <div
                                    class="h-6 w-0.5 bg-slate-200 absolute left-8 -top-3"
                                ></div>
                                <i
                                    :class="getTransportIcon(item.transportType)"
                                    class="mr-2 text-slate-300"
                                ></i>
                                <span class="font-bold"
                                    >{{ item.travelTime || "約15分鐘" }}</span
                                >
                            </div>

                            <!-- 卡片 -->
                            <div
                                class="bg-white rounded-3xl p-3 pr-4 card-shadow flex border border-ice-blue/50 overflow-hidden items-stretch"
                                :class="{
                                    'highlight-bg': recentlyMovedId === item.id,
                                }"
                            >
                                <div
                                    class="flex flex-col items-center justify-center mr-3 w-10 shrink-0 space-y-1"
                                >
                                    <button
                                        v-if="canEditItinerary"
                                        @click.stop="
                                            moveItem(idx, -1, item.id)
                                        "
                                        class="w-8 h-6 text-slate-300 hover:text-deep-sea-blue hover:bg-orange-50 rounded-lg transition-colors flex items-center justify-center active:scale-90"
                                        :class="{ invisible: idx === 0 }"
                                    >
                                        <i
                                            class="fa-solid fa-chevron-up text-xs"
                                        ></i>
                                    </button>
                                    <div
                                        class="w-10 h-10 rounded-full text-white shadow-md flex items-center justify-center text-lg z-10"
                                        :style="{
                                            backgroundColor:
                                                getCategoryColor(item.category),
                                        }"
                                    >
                                        <i
                                            :class="
                                                getCategoryIcon(item.category)
                                            "
                                        ></i>
                                    </div>
                                    <button
                                        v-if="canEditItinerary"
                                        @click.stop="
                                            moveItem(idx, 1, item.id)
                                        "
                                        class="w-8 h-6 text-slate-300 hover:text-deep-sea-blue hover:bg-orange-50 rounded-lg transition-colors flex items-center justify-center active:scale-90"
                                        :class="{
                                            invisible:
                                                idx ===
                                                currentItinerary.length - 1,
                                        }"
                                    >
                                        <i
                                            class="fa-solid fa-chevron-down text-xs"
                                        ></i>
                                    </button>
                                </div>

                                <div
                                    class="flex-1 min-w-0 flex flex-col justify-center py-1"
                                >
                                    <div class="flex items-baseline mb-1">
                                        <span
                                            v-if="item.startTime"
                                            class="text-sm font-bold text-deep-sea-blue mr-2"
                                            >{{ item.startTime }}</span
                                        >
                                        <h3
                                            class="text-lg font-bold text-slate-800 leading-tight break-words"
                                        >
                                            {{ item.name }}
                                        </h3>
                                    </div>
                                    <div
                                        class="text-sm text-slate-500 space-y-1"
                                    >
                                        <p
                                            v-if="item.hours"
                                            class="truncate"
                                        >
                                            <i
                                                class="fa-regular fa-clock w-3.5 text-center mr-1 text-ice-blue text-xs"
                                            ></i>
                                            {{ item.hours }}
                                        </p>
                                        <p
                                            v-if="item.price"
                                            class="truncate"
                                        >
                                            <i
                                                class="fa-solid fa-ticket w-3.5 text-center mr-1 text-ice-blue text-xs"
                                            ></i>
                                            {{ item.price }}
                                        </p>
                                        <p
                                            v-if="item.address"
                                            class="break-words line-clamp-2 text-xs"
                                        >
                                            <i
                                                class="fa-solid fa-location-dot w-3.5 text-center mr-1 text-ice-blue text-xs"
                                            ></i>
                                            {{ item.address }}
                                        </p>
                                    </div>
                                    <div
                                        v-if="item.note && item.note.length > 0"
                                        class="mt-2 text-xs bg-slate-50 p-2 rounded-lg border border-slate-100 break-words whitespace-normal text-slate-600 leading-relaxed"
                                    >
                                        {{ item.note }}
                                    </div>
                                </div>

                                <div
                                    class="flex flex-col justify-center items-end pl-2 ml-1 space-y-3 shrink-0 border-l border-slate-100 border-dashed"
                                >
                                    <button
                                        v-if="canEditItinerary"
                                        @click.stop="editItem(item)"
                                        class="w-9 h-9 bg-slate-50 text-slate-400 rounded-full flex items-center justify-center hover:bg-slate-200 hover:text-slate-600 transition-colors shadow-sm"
                                    >
                                        <i
                                            class="fa-solid fa-pencil text-sm"
                                        ></i>
                                    </button>
                                    <a
                                        :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address || item.name)}`"
                                        target="_blank"
                                        class="w-9 h-9 bg-ice-blue text-white rounded-full flex items-center justify-center hover:bg-deep-sea-blue transition-colors shadow-md shadow-ice-blue/30"
                                        @click.stop
                                    >
                                        <i
                                            class="fa-solid fa-location-arrow text-sm"
                                        ></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </TransitionGroup>
                </div>

                <!-- Info Tab -->
                <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in">
                   <div class="bg-gradient-to-br from-orange-400 to-amber-500 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden border border-orange-200/20">
                        <h3 class="font-bold text-lg mb-4 flex items-center relative z-10 text-white"><i class="fa-solid fa-coins mr-2 text-yellow-200"></i> 匯率換算</h3>
                        <div class="flex items-center justify-between space-x-3 relative z-10">
                            <div class="flex-1"><label class="text-[10px] text-orange-50 block mb-1 uppercase tracking-wider font-bold">THB</label><input type="number" v-model.number="inputTHB" @input="updateTWD" class="w-full bg-white/20 border border-white/20 rounded-xl px-3 py-2.5 text-white placeholder-white/50 focus:outline-none focus:bg-white/30 text-lg font-bold shadow-sm font-mono" /></div>
                            <i class="fa-solid fa-arrow-right-arrow-left text-white/80 mt-5"></i>
                            <div class="flex-1"><label class="text-[10px] text-orange-50 block mb-1 uppercase tracking-wider font-bold">TWD</label><input type="number" v-model.number="inputTWD" @input="updateTHB" class="w-full bg-white/20 border border-white/20 rounded-xl px-3 py-2.5 text-white placeholder-white/50 focus:outline-none focus:bg-white/30 text-lg font-bold shadow-sm font-mono" /></div>
                        </div>
                        <div class="mt-4 flex justify-between items-center relative z-10 border-t border-white/20 pt-2">
                            <button @click="fetchExchangeRate" class="text-[10px] text-white/70 hover:text-white flex items-center transition-colors">
                                <i class="fa-solid fa-rotate mr-1" :class="{ 'animate-spin': isRatesLoading }"></i> {{ isRatesLoading ? "更新中..." : "點擊更新匯率" }}
                            </button>
                            <p class="text-xs text-white font-bold tracking-wide">1 THB = {{ EXCHANGE_RATE.toFixed(4) }} TWD</p>
                        </div>
                   </div>
                </div>

                <!-- Shopping Tab -->
                <div v-if="currentTab === 'shopping'" class="animate-fade-in">
                    <div class="bg-white rounded-3xl p-6 card-shadow min-h-[60vh]">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center justify-between"><span class="flex items-center"><i class="fa-solid fa-basket-shopping text-accent-yellow mr-2"></i> {{ currentUser }} 的清單</span></h3>
                        <ul class="space-y-3" v-if="currentShoppingList.length > 0">
                            <li v-for="item in currentShoppingList" :key="item.id" class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100 transition-all hover:shadow-sm">
                                <div class="flex items-center flex-1 mr-2"><input type="checkbox" :checked="item.checked" @change="toggleShoppingItem(item)" class="w-5 h-5 text-deep-sea-blue rounded mr-3 accent-deep-sea-blue cursor-pointer" /><span :class="{'line-through text-slate-400': item.checked, 'text-slate-700 font-medium': !item.checked}" class="break-all">{{ item.name }}</span></div>
                                <button @click="removeShoppingItem(item.id)" class="text-slate-300 hover:text-red-500 transition-colors p-2"><i class="fa-solid fa-trash-can"></i></button>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- Expenses Tab -->
                <div v-if="currentTab === 'expenses'" class="animate-fade-in space-y-6">
                    <div class="expenses-banner text-white rounded-3xl p-6 relative overflow-hidden">
                        <p class="text-sm text-orange-100 mb-2 relative z-10 flex items-center"><i class="fa-solid fa-user-circle mr-1"></i> {{ currentUser }} 的個人總支出</p>
                        <h2 class="text-4xl font-bold relative z-10 tracking-tight">約 NT$ {{ formatNumber(finalTotalTWD) }}</h2>
                        <div class="text-xs mt-3 opacity-90 leading-relaxed relative z-10 bg-white/10 p-3 rounded-lg border border-white/20">
                            <div class="flex justify-between"><span>THB 小計:</span><span class="font-semibold">฿ {{ formatNumber(totalTHB) }}</span></div>
                            <div class="flex justify-between"><span>TWD 小計:</span><span class="font-semibold">NT$ {{ formatNumber(totalTWD) }}</span></div>
                        </div>
                    </div>
                </div>

                <!-- 浮動新增按鈕 -->
                <button v-if="currentTab === 'itinerary' && canEditItinerary" @click="handleAddClick" class="fixed bottom-6 right-6 w-14 h-14 bg-accent-yellow rounded-full fab-shadow text-deep-sea-blue text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40"><i class="fa-solid fa-plus"></i></button>
                <button v-if="currentTab === 'shopping'" @click="handleAddClick" class="fixed bottom-6 right-6 w-14 h-14 bg-accent-yellow rounded-full fab-shadow text-deep-sea-blue text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40"><i class="fa-solid fa-plus"></i></button>
                <button v-if="currentTab === 'expenses'" @click="handleAddClick" class="fixed bottom-6 right-6 w-14 h-14 bg-accent-yellow rounded-full fab-shadow text-deep-sea-blue text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40"><i class="fa-solid fa-plus"></i></button>

                <!-- Modals -->
                <!-- Shopping Modal -->
                <div v-if="showShoppingModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
                    <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
                        <input v-model="newShoppingItem.name" type="text" placeholder="商品名稱" class="w-full bg-slate-50 border-none rounded-xl p-4 mb-4 focus:ring-2 focus:ring-deep-sea-blue text-sm outline-none" />
                        <div class="flex space-x-3">
                            <button @click="showShoppingModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                            <button @click="addShoppingItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm">新增</button>
                        </div>
                    </div>
                </div>

                <!-- Expense Modal -->
                <div v-if="showExpenseModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
                    <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div class="space-y-3">
                            <input v-model="newExpense.date" type="date" class="w-full bg-slate-50 rounded-xl p-3 text-sm" />
                            <input v-model="newExpense.name" type="text" placeholder="項目名稱" class="w-full bg-slate-50 rounded-xl p-3 text-sm" />
                            <input v-model.number="newExpense.amount" type="number" placeholder="金額" class="w-full bg-slate-50 rounded-xl p-3 text-sm" />
                            <select v-model="newExpense.payer" class="w-full bg-slate-50 rounded-xl p-3 text-sm"><option v-for="m in members" :key="m.id" :value="m.name">{{ m.name }} 先付</option></select>
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                            <button @click="saveExpense" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm">儲存</button>
                        </div>
                    </div>
                </div>

                <!-- Itinerary Modal -->
                <div v-if="showItineraryModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
                    <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div class="space-y-3">
                            <input v-model="newItinerary.startTime" type="text" placeholder="時間" class="w-full bg-slate-50 rounded-xl p-3 text-sm" />
                            <input v-model="newItinerary.name" type="text" placeholder="行程名稱" class="w-full bg-slate-50 rounded-xl p-3 text-sm" />
                            <textarea v-model="newItinerary.note" rows="3" placeholder="備註" class="w-full bg-slate-50 rounded-xl p-3 text-sm"></textarea>
                        </div>
                        <div class="flex space-x-3 mt-6">
                            <button @click="showItineraryModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                            <button @click="saveItineraryItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm">儲存</button>
                        </div>
                    </div>
                </div>

                <!-- Password Modal (修復：移除 v-if/v-show，強制顯示 input) -->
                <div v-if="showRolePasswordModal" class="fixed inset-0 bg-slate-900/60 z-[80] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
                    <div class="bg-white rounded-3xl w-full max-w-xs p-6 shadow-2xl border border-orange-100">
                        <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-deep-sea-blue shadow-inner">
                            <i class="fa-solid fa-shield-cat text-xl"></i>
                        </div>
                        <h3 class="font-bold text-base mb-2 text-center text-slate-800">{{ passwordMode === "loginAdmin" ? "Admin 身份驗證" : passwordMode === "loginPersonal" ? `歡迎回來，${targetLoginMember?.name}` : "需要密碼" }}</h3>
                        
                        <!-- 修正：input 永遠存在，不使用 v-if 切換 -->
                        <input
                            ref="rolePasswordInputRef"
                            v-model="rolePasswordInput"
                            type="password"
                            placeholder="請輸入密碼"
                            class="w-full bg-slate-50 rounded-xl p-3 text-center font-bold text-deep-sea-blue outline-none border-2 border-transparent focus:border-deep-sea-blue focus:bg-white transition-all mb-4 tracking-widest ring-1 ring-slate-100 focus:ring-deep-sea-blue/30"
                        />
                        
                        <div class="flex space-x-3">
                            <button @click="cancelRolePassword" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 text-sm font-bold hover:bg-slate-200 transition-colors">取消</button>
                            <button @click="confirmRolePassword" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-deep-sea-blue to-orange-500 text-white text-sm font-bold shadow-lg shadow-orange-200 hover:scale-105 transition-transform">確認</button>
                        </div>
                    </div>
                </div>

                <!-- Toast -->
                <div v-if="showToast" class="fixed bottom-20 left-1/2 -translate-x-1/2 z-[90] bg-slate-900/90 text-white text-sm px-4 py-2 rounded-full shadow-lg">{{ toastMessage }}</div>
            </main>
        </div>
    </div>

    <!-- JS 主程式 -->
    <script type="module">
        import { createApp, ref, computed, onMounted, nextTick } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyYCSGWQ0Wdf13AE62UG7W8WiwpqCHs_0",
            authDomain: "bankoktrip2026.firebaseapp.com",
            projectId: "bankoktrip2026",
            storageBucket: "bankoktrip2026.firebasestorage.app",
            messagingSenderId: "347622663908",
            appId: "1:347622663908:web:6a514d1761f215a2ae6ef1",
            measurementId: "G-ENHVD5XKF8",
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);

        // === 行程順序修正 ===
        const INITIAL_ITINERARY = [
             // Day 1: 修正交通邏輯
            [
                { category: "transport", name: "抵達曼谷機場 (BKK)", startTime: "13:05", address: "Suvarnabhumi Airport", note: "下機後辦理通關、領行李，預計 14:00 出關。建議預約保母車或叫 2 台 Grab 前往飯店。", order: 1, transportType: "flight", travelTime: "" }, // 第一站無交通時間
                { category: "accommodation", name: "入住 Craftsman Bangkok", startTime: "15:00", address: "34-36 Phahon Yothin 11, Samsen Nai, Phaya Thai", note: "Check-in，放行李、分配房卡。稍作休息或在飯店泳池拍照。", order: 2, transportType: "car", travelTime: "機場 → 飯店約 40 分" },
                { category: "food", name: "Ari 咖啡街散步", startTime: "16:00", address: "Ari Soi 4 / Gump's Ari", note: "從飯店搭嘟嘟車或叫車至 Ari。逛 Gump's Ari 拍照，或去 Nana Coffee Roasters 喝咖啡。", order: 3, transportType: "car", travelTime: "飯店 → Ari 區約 15 分" },
                { category: "food", name: "晚餐：Lay Lao (Ari)", startTime: "18:00", address: "65 Phahon Yothin 7, Samsen Nai", note: "米其林必比登推薦東北菜。就在 Ari 站附近，吃完可以直接散步。", order: 4, transportType: "walk", travelTime: "Ari 區步行" },
                { category: "other", name: "按摩 / 放鬆 / 續攤", startTime: "20:00", address: "Ari Area", note: "飯後可找附近按摩店 (Chaari Spa)，或去酒吧/大麻店 chill 一下。結束叫車回飯店。", order: 5, transportType: "walk", travelTime: "步行約 10 分" },
            ],
            // Day 2
            [
                { category: "food", name: "早餐：FRAN'S Ari", startTime: "09:00", address: "58 Ngam Duphli Alley", note: "超紅早午餐，務必預約。叫車前往。", order: 1, transportType: "car", travelTime: "飯店 → FRAN'S 約 10 分" },
                { category: "sightseeing", name: "臥佛寺 (Wat Pho)", startTime: "11:00", address: "2 Sanam Chai Rd", note: "從 Ari 叫車去舊城區，預留 40 分鐘車程避開塞車。參觀臥佛。", order: 2, transportType: "car", travelTime: "Ari → 臥佛寺 車程約 40 分" },
                { category: "food", name: "午餐：RONGROS", startTime: "12:30", address: "392/16 Maha Rat Rd", note: "河畔景觀餐廳，看鄭王廟。就在臥佛寺附近的碼頭邊。", order: 3, transportType: "walk", travelTime: "臥佛寺 → RONGROS 步行 5 分" },
                { category: "sightseeing", name: "鄭王廟 (Wat Arun)", startTime: "14:30", address: "158 Thanon Wang Doem", note: "搭接駁船過河。爬塔拍照，停留約 1 小時。", order: 4, transportType: "public", travelTime: "過河船程約 10 分" },
                { category: "shopping", name: "ICONSIAM", startTime: "16:00", address: "299 Charoen Nakhon Rd", note: "從鄭王廟碼頭搭橘旗/藍旗船前往。逛室內水上市場吹冷氣。", order: 5, transportType: "public", travelTime: "鄭王廟 → ICONSIAM 船程 20 分" },
                { category: "sightseeing", name: "碼頭夜市 Asiatique", startTime: "18:30", address: "2194 Charoen Krung Rd", note: "從 ICONSIAM 搭船至 Sathorn，轉免費接駁船。晚餐夜市解決，玩 Skyflyer。", order: 6, transportType: "public", travelTime: "船程約 30 分" },
                { category: "other", name: "Nana 廣場 (夜生活)", startTime: "21:30", address: "Nana Plaza, Sukhumvit 4", note: "體驗曼谷紅燈區氛圍。結束後叫車回 Craftsman。", order: 7, transportType: "car", travelTime: "Asiatique → Nana 車程 30 分" },
            ],
            // Day 3: 修正 8:30 退房 & 8:45 出發
            [
                { category: "accommodation", name: "Craftsman 退房", startTime: "08:30", address: "Craftsman Bangkok", note: "起床吃早餐、收行李退房。包車司機預計 08:30 抵達接人。", order: 1, transportType: "walk", travelTime: "飯店門口上車" },
                { category: "sightseeing", name: "美功鐵道市集", startTime: "10:45", address: "Mae Klong Railway Market", note: "08:45 準時出發，車程約 2 小時。看 11:10/11:30 火車。", order: 2, transportType: "car", travelTime: "曼谷 → 美功 約 2 小時" },
                { category: "food", name: "午餐：廣銘珍 / 媽媽桑", startTime: "11:40", address: "市場旁", note: "看完火車就近吃雲吞麵或泡麵。", order: 3, transportType: "walk", travelTime: "步行" },
                { category: "sightseeing", name: "安帕瓦水上市場", startTime: "13:00", address: "Amphawa", note: "搭車前往，約 20 分鐘。包船遊河，逛市集吃點心。", order: 4, transportType: "car", travelTime: "美功 → 安帕瓦 20 分" },
                { category: "accommodation", name: "入住通羅 Airbnb", startTime: "17:00", address: "Thonglor Area", note: "15:30 離開安帕瓦，預計 17:00-17:30 抵達通羅。Check-in 休息。", order: 5, transportType: "car", travelTime: "安帕瓦 → 通羅 2 小時" },
                { category: "food", name: "晚餐：頌通酒家", startTime: "19:00", address: "2829 Rama IV Rd", note: "老牌海鮮餐廳，必吃咖哩蟹。叫車前往。", order: 6, transportType: "car", travelTime: "通羅 → 頌通 15 分" },
                { category: "other", name: "Tichuca Rooftop Bar", startTime: "21:00", address: "T-One Building", note: "水母酒吧喝一杯。人多需排隊。", order: 7, transportType: "car", travelTime: "頌通 → Tichuca 15 分" },
            ],
            // Day 4
            [
                { category: "sightseeing", name: "四面佛", startTime: "10:00", address: "Erawan Shrine", note: "搭 BTS 從 Thong Lo 到 Chit Lom。參拜許願。", order: 1, transportType: "public", travelTime: "BTS 約 20 分" },
                { category: "shopping", name: "Central World", startTime: "10:30", address: "Central World", note: "就在對面，過天橋即達。逛街吹冷氣。", order: 2, transportType: "walk", travelTime: "步行 5 分" },
                { category: "food", name: "午餐：Here Hai (Paragon)", startTime: "12:30", address: "Siam Paragon G Fl", note: "走 Skywalk 到 Paragon。吃米其林蟹肉炒飯。", order: 3, transportType: "walk", travelTime: "步行 10 分" },
                { category: "shopping", name: "Siam 商圈自由逛", startTime: "13:30", address: "Siam Center / Paragon", note: "自由活動時間，買衣服、香氛。", order: 4, transportType: "walk", travelTime: "商圈內" },
                { category: "other", name: "按摩", startTime: "16:00", address: "Siam / Chit Lom", note: "Let's Relax 或其他按摩店放鬆腿部。", order: 5, transportType: "walk", travelTime: "步行" },
                { category: "food", name: "晚餐：Mungkorn Seafood", startTime: "18:30", address: "Pracha Songkhro Rd", note: "搭車前往海鮮吃到飽。大頭蝦無限夾。", order: 6, transportType: "car", travelTime: "Siam → 餐廳 車程 30 分" },
                { category: "shopping", name: "Big C Ekkamai", startTime: "21:00", address: "Sukhumvit 63", note: "吃飽去 Ekkamai 的 Big C 採購伴手禮，人少好逛。離通羅近。", order: 7, transportType: "car", travelTime: "餐廳 → Ekkamai 車程 25 分" },
            ],
            // Day 5: 修正 11:00 退房 & 12:00 抵達機場
            [
                { category: "food", name: "早餐 & 整理行李", startTime: "09:00", address: "Thonglor", note: "通羅附近咖啡廳早餐，最後打包。", order: 1, transportType: "walk", travelTime: "" },
                { category: "accommodation", name: "退房 & 前往機場", startTime: "11:00", address: "Thonglor Airbnb", note: "11:00 準時退房，保母車接送。預留 1 小時車程。", order: 2, transportType: "walk", travelTime: "步行至樓下" },
                { category: "transport", name: "抵達 BKK 機場", startTime: "12:00", address: "Suvarnabhumi Airport", note: "辦理登機、托運、退稅。逛免稅店。", order: 3, transportType: "car", travelTime: "通羅 → 機場 車程 60 分" },
                { category: "flight", name: "搭機返台 (CI0832)", startTime: "14:05", address: "Gate", note: "14:05 起飛，結束旅程。", order: 4, transportType: "flight", travelTime: "機場內" },
            ],
        ];

        const app = createApp({
            setup() {
                const TRIP_YEAR = 2026;
                const EXCHANGE_RATE = ref(0.92);
                const WEATHER_API_KEY = "e5e727b85066927db1d248be29dfa632";
                const currentTab = ref("itinerary");
                const selectedDateIndex = ref(0);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showItineraryModal = ref(false);
                const showRolePasswordModal = ref(false);
                const isEditMode = ref(false);
                const inputTHB = ref(100);
                const inputTWD = ref(92);
                const rolePasswordInput = ref("");
                const rolePasswordInputRef = ref(null); // DOM 參照
                const passwordMode = ref("loginAdmin");
                const targetLoginMember = ref(null);
                const recentlyMovedId = ref(null);
                const isRatesLoading = ref(false);
                const hasSelectedUser = ref(false);
                const currentUser = ref("");
                const showToast = ref(false);
                const toastMessage = ref("");
                const dates = ref([{ date: "1/16", weekday: "五", hasCar: false }, { date: "1/17", weekday: "六", hasCar: false }, { date: "1/18", weekday: "日", hasCar: true }, { date: "1/19", weekday: "一", hasCar: false }, { date: "1/20", weekday: "二", hasCar: false }]);
                const weatherData = ref([]);
                const itineraryData = ref([[], [], [], [], []]);
                const members = ref([]);
                const allShoppingList = ref([]);
                const expenses = ref([]);
                const newShoppingItem = ref({ name: "", checked: false });
                const newItinerary = ref({});
                const newExpense = ref({});
                const ROLE_PASSWORD = "kappaho17";
                const DEFAULT_MEMBERS = ["kappabooom", "beibei1029", "hsiannnnng", "shinbinwei", "aylwen4444", "wunsin", "rtrtr1", "blackblacknu"];

                const currentUserRole = computed(() => { const m = members.value.find(m => m.name === currentUser.value); return m?.role || "viewer"; });
                const canEditItinerary = computed(() => currentUserRole.value === "admin");
                const currentShoppingList = computed(() => allShoppingList.value.filter(item => item.owner === currentUser.value));
                const totalTHB = computed(() => expenses.value.filter(e => e.payer === currentUser.value && e.currency === 'THB').reduce((a, b) => a + (Number(b.amount) || 0), 0));
                const totalTWD = computed(() => expenses.value.filter(e => e.payer === currentUser.value && e.currency === 'TWD').reduce((a, b) => a + (Number(b.amount) || 0), 0));
                const finalTotalTWD = computed(() => Math.round(totalTWD.value + totalTHB.value * EXCHANGE_RATE.value));
                const currentItinerary = computed(() => (itineraryData.value[selectedDateIndex.value] || []).sort((a, b) => (a.order || 999) - (b.order || 999)));

                const triggerToast = (msg) => { toastMessage.value = msg; showToast.value = true; setTimeout(() => showToast.value = false, 3000); };
                const formatNumber = (num) => num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0";

                onMounted(async () => {
                    try {
                        const membersCol = collection(db, "members");
                        onSnapshot(membersCol, (snapshot) => {
                            if (!snapshot.empty) {
                                members.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                            } else {
                                DEFAULT_MEMBERS.forEach(name => addDoc(membersCol, { name, active: true, role: 'viewer', password: '' }));
                            }
                        });

                        onSnapshot(collection(db, "expenses"), (snapshot) => expenses.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                        onSnapshot(collection(db, "shopping_list"), (snapshot) => allShoppingList.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() })));

                        for (let i = 0; i < dates.value.length; i++) {
                            const itineraryCol = collection(db, `itinerary_day_${i}`);
                            const snap = await getDocs(itineraryCol);
                            if (snap.empty && INITIAL_ITINERARY[i]) {
                                const batch = writeBatch(db);
                                INITIAL_ITINERARY[i].forEach(item => batch.set(doc(itineraryCol), item));
                                await batch.commit();
                            }
                            onSnapshot(itineraryCol, (snapshot) => itineraryData.value[i] = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })));
                        }

                        try { await fetchExchangeRate(); } catch (e) { console.error("Rate error", e); }
                        try { await fetchWeather(); } catch (e) { console.error("Weather error", e); }

                    } catch (error) {
                        console.error("Initialization error:", error);
                        triggerToast("初始化發生錯誤，請重整頁面");
                    } finally {
                        // 確保 loading 移除
                        setTimeout(() => {
                            const loader = document.getElementById("loading-screen");
                            if (loader) loader.classList.add("hidden");
                        }, 500);
                    }
                });

                const fetchExchangeRate = async () => {
                    isRatesLoading.value = true;
                    try {
                        const r = await fetch("https://open.er-api.com/v6/latest/THB");
                        const d = await r.json();
                        if (d && d.rates && d.rates.TWD) EXCHANGE_RATE.value = Number(d.rates.TWD);
                    } catch (e) { console.error(e); } finally { isRatesLoading.value = false; }
                };

                const fetchWeather = async () => { /* 簡化：天氣邏輯略 */ };

                const attemptLogin = (member) => {
                    targetLoginMember.value = member;
                    if (member.role === "admin") {
                        passwordMode.value = "loginAdmin";
                        rolePasswordInput.value = "";
                        showRolePasswordModal.value = true;
                    } else if (member.password) {
                        passwordMode.value = "loginPersonal";
                        rolePasswordInput.value = "";
                        showRolePasswordModal.value = true;
                    } else {
                        performLogin(member);
                        return; // 這裡要 return 避免跑下面
                    }
                    // 強制聚焦
                    nextTick(() => {
                        if (rolePasswordInputRef.value) {
                            rolePasswordInputRef.value.focus();
                        }
                    });
                };

                const performLogin = (member) => { currentUser.value = member.name; hasSelectedUser.value = true; };

                const confirmRolePassword = async () => {
                    const input = rolePasswordInput.value;
                    if (passwordMode.value === "loginAdmin" && input === ROLE_PASSWORD) {
                        performLogin(targetLoginMember.value);
                        showRolePasswordModal.value = false;
                    } else if (passwordMode.value === "loginPersonal" && input === targetLoginMember.value.password) {
                        performLogin(targetLoginMember.value);
                        showRolePasswordModal.value = false;
                    } else {
                        triggerToast("密碼錯誤");
                    }
                };
                
                const cancelRolePassword = () => showRolePasswordModal.value = false;
                const updateTWD = () => inputTWD.value = Math.round(inputTHB.value * EXCHANGE_RATE.value);
                const updateTHB = () => inputTHB.value = Math.round(inputTWD.value / EXCHANGE_RATE.value);
                
                const handleAddClick = () => {
                    if (currentTab.value === 'itinerary') {
                        if (!canEditItinerary.value) return triggerToast("權限不足");
                        newItinerary.value = {}; showItineraryModal.value = true;
                    } else if (currentTab.value === 'shopping') {
                        newShoppingItem.value = { name: "", checked: false }; showShoppingModal.value = true;
                    } else if (currentTab.value === 'expenses') {
                        newExpense.value = { date: new Date().toISOString().split('T')[0], currency: 'THB', payer: currentUser.value }; showExpenseModal.value = true;
                    }
                };

                // UI Helpers
                const getCategoryIcon = (c) => ({ sightseeing: "fa-solid fa-camera", food: "fa-solid fa-utensils", shopping: "fa-solid fa-bag-shopping", accommodation: "fa-solid fa-bed", transport: "fa-solid fa-van-shuttle", ticket: "fa-solid fa-ticket", flight: "fa-solid fa-plane", other: "fa-solid fa-circle-dot" }[c] || "fa-solid fa-circle-dot");
                const getTransportIcon = (t) => ({ car: "fa-solid fa-car", walk: "fa-solid fa-person-walking", public: "fa-solid fa-train-subway", flight: "fa-solid fa-plane-up" }[t] || "fa-solid fa-arrow-right");
                const getCategoryColor = (c) => ({ sightseeing: "#FF7043", food: "#FFA726", shopping: "#EC407A", accommodation: "#5C6BC0", transport: "#78909C", ticket: "#8D6E63", flight: "#29B6F6", other: "#9E9E9E" }[c] || "#BDBDBD");
                const getWeatherIcon = (c) => ({ sunny: "fa-solid fa-sun", cloudy: "fa-solid fa-cloud-sun", rain: "fa-solid fa-cloud-showers-heavy" }[c] || "fa-solid fa-sun");
                const getWeatherDescription = (c) => ({ sunny: "晴朗炎熱", cloudy: "多雲偶晴", rain: "午後雷陣雨" }[c] || "晴朗");
                const editItem = (i) => { newItinerary.value = {...i}; showItineraryModal.value = true; };
                const saveItineraryItem = async () => { /* 儲存邏輯略 */ showItineraryModal.value = false; };
                const addShoppingItem = async () => { if(newShoppingItem.value.name) await addDoc(collection(db, "shopping_list"), { ...newShoppingItem.value, owner: currentUser.value }); showShoppingModal.value = false; };
                const toggleShoppingItem = async (item) => await updateDoc(doc(db, "shopping_list", item.id), { checked: !item.checked });
                const removeShoppingItem = async (id) => await deleteDoc(doc(db, "shopping_list", id));
                const saveExpense = async () => { if(newExpense.value.amount) await addDoc(collection(db, "expenses"), newExpense.value); showExpenseModal.value = false; };
                const moveItem = () => {};

                return {
                    currentTab, selectedDateIndex, showShoppingModal, showExpenseModal, showItineraryModal, showRolePasswordModal,
                    dates, weatherData, currentItinerary, members, currentShoppingList,
                    newShoppingItem, newExpense, newItinerary, rolePasswordInput, rolePasswordInputRef, passwordMode, targetLoginMember,
                    currentUser, hasSelectedUser, canEditItinerary, totalTHB, totalTWD, finalTotalTWD,
                    inputTHB, inputTWD, EXCHANGE_RATE, isRatesLoading, showToast, toastMessage,
                    attemptLogin, confirmRolePassword, cancelRolePassword,
                    getCategoryIcon, getTransportIcon, getCategoryColor, getWeatherIcon, getWeatherDescription, formatNumber,
                    handleAddClick, editItem, saveItineraryItem, addShoppingItem, toggleShoppingItem, removeShoppingItem, saveExpense, moveItem,
                    updateTWD, updateTHB, fetchExchangeRate
                };
            },
        });

        app.mount("#app");
    </script>
</body>
</html>
