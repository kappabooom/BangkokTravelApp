<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>2026ÊõºË∞∑ÊóÖË°å</title>

    <!-- Apple Touch Icon -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />
    <link rel="icon" type="image/png" href="apple-touch-icon.png" />

    <!-- UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "snow-white": "#FFFDE7",
                        "ice-blue": "#4DB6AC",
                        "light-snow-blue": "#FFF3E0",
                        "deep-sea-blue": "#E65100",
                        "accent-yellow": "#FFB300",
                        "soft-gray": "#FAFAFA",
                    },
                },
            },
        };
    </script>

    <style>
        @import url("https://fonts.googleapis.com/css?family=Noto+Sans+TC:wght@300;400;500;700&display=swap");
        body {
            background-color: #fff3e0;
            -webkit-tap-highlight-color: transparent;
            font-family: "Noto Sans TC", sans-serif;
            color: #334155;
        }
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-bottom: 90px;
        }
        .login-screen {
            position: fixed;
            inset: 0;
            z-index: 60;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .header-bg {
            background-color: #ffffff;
            padding: 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-bottom-left-radius: 35px;
            border-bottom-right-radius: 35px;
            z-index: 10;
        }
        .header-image-container {
            width: 100%;
            height: 250px;
            overflow: hidden;
            background-color: transparent;
            border-bottom-left-radius: 35px;
            border-bottom-right-radius: 35px;
        }
        .header-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .side-tab-bar {
            position: absolute;
            bottom: 15px;
            right: 16px;
            z-index: 30;
            display: flex;
            flex-direction: row;
            gap: 8px;
        }
        .tab-button {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #e65100;
            color: #ffffff;
            box-shadow: 0 6px 15px rgba(230, 81, 0, 0.4);
            transform: scale(1.05);
        }
        .tab-button:not(.active) {
            background-color: #ffffff;
            color: #4db6ac;
        }
        .app-main {
            padding-top: 25px !important;
            position: relative;
            z-index: 5;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(230, 81, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fab-shadow {
            box-shadow: 0 4px 15px rgba(255, 179, 0, 0.5);
        }
        .note-content {
            max-height: 2.5rem;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .note-content.expanded {
            max-height: 500px;
        }
        .expenses-banner {
            background: linear-gradient(135deg, #ff7043 0%, #ab47bc 100%);
        }
        .date-selector-sticky {
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0;
            z-index: 20;
            top: 0;
            padding-top: env(safe-area-inset-top, 20px);
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .custom-select-wrapper {
            position: relative;
        }
        .custom-select-wrapper select {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 100%;
            opacity: 0;
            position: absolute;
            left: 0;
            top: 0;
            cursor: pointer;
            z-index: 10;
        }
        .pulse-arrow {
            animation: pulse-x 1.5s infinite ease-in-out;
        }
        @keyframes pulse-x {
            0%,
            100% {
                transform: translateX(0);
                opacity: 0.8;
            }
            50% {
                transform: translateX(5px);
                opacity: 1;
            }
        }
        .flip-list-move {
            transition: transform 0.5s cubic-bezier(0.2, 0, 0, 1);
            z-index: 20;
            position: relative;
        }
        .flip-list-enter-active,
        .flip-list-leave-active {
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        }
        .flip-list-enter-from,
        .flip-list-leave-to {
            opacity: 0;
            transform: scale(0.95);
        }
        .highlight-bg {
            animation: highlight 1s ease-out forwards;
        }
        @keyframes highlight {
            0% {
                background-color: #fff8e1;
                transform: scale(1.02);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            }
            100% {
                background-color: #ffffff;
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(230, 81, 0, 0.1);
            }
        }
        .loader-container {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background-color: #fff3e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .loader-container.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(230, 81, 0, 0.2);
            border-top-color: #e65100;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        .loader-logo {
            font-size: 3rem;
            color: #e65100;
            margin-bottom: 1rem;
            animation: pulse-logo 1.5s infinite ease-in-out;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        @keyframes pulse-logo {
            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
    </style>
</head>
<body>
<div id="loading-screen" class="loader-container">
    <i class="fa-solid fa-plane-departure loader-logo"></i>
    <div class="spinner"></div>
    <p class="text-deep-sea-blue font-bold tracking-widest text-sm">Loading...</p>
</div>

<div id="app" class="app-container">
    <!-- ÁôªÂÖ•Áï´Èù¢ -->
    <div v-if="!hasSelectedUser" class="login-screen animate-fade-in p-6">
        <div class="text-center mb-8">
            <div class="w-24 h-24 bg-white rounded-full mx-auto shadow-lg flex items-center justify-center mb-4">
                <i class="fa-solid fa-plane-up text-4xl text-deep-sea-blue"></i>
            </div>
            <h1 class="text-2xl font-bold text-slate-800 mb-1">Ê≠°ËøéÂõû‰æÜ</h1>
            <p class="text-sm text-slate-500">Ë´ãÈÅ∏ÊìáÊÇ®ÁöÑÊàêÂì°Ë∫´‰ªΩ‰ª•ÁôªÂÖ•</p>
        </div>

        <div v-if="members.length === 0" class="flex flex-col items-center">
            <div class="spinner w-8 h-8 border-2"></div>
            <span class="text-xs text-slate-400">Ê≠£Âú®ËÆÄÂèñÊàêÂì°...</span>
        </div>

        <div v-else class="grid grid-cols-2 gap-4 w-full max-w-sm">
            <div v-for="member in members" :key="member.id"
                 @click="attemptLogin(member)"
                 class="bg-white p-4 rounded-2xl shadow-sm border border-orange-100 flex flex-col items-center justify-center cursor-pointer hover:shadow-md hover:scale-105 transition-all relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-2" v-if="member.role === 'admin' || member.password">
                    <i v-if="member.role === 'admin'"
                       class="fa-solid fa-crown text-[10px] text-yellow-500 bg-yellow-100 p-1 rounded-full"></i>
                    <i v-else-if="member.password"
                       class="fa-solid fa-lock text-[10px] text-slate-400 bg-slate-100 p-1 rounded-full"></i>
                </div>

                <div class="w-12 h-12 rounded-full mb-2 flex items-center justify-center text-lg font-bold text-white shadow-inner"
                     :class="member.role === 'admin'
                             ? 'bg-gradient-to-br from-orange-400 to-deep-sea-blue'
                             : 'bg-gradient-to-br from-ice-blue to-teal-500'">
                    {{ member.name.substring(0,1).toUpperCase() }}
                </div>
                <span class="font-bold text-slate-700 text-sm truncate w-full text-center">{{ member.name }}</span>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÁï´Èù¢ -->
    <div v-else>
        <div class="header-bg relative">
            <div class="header-image-container">
                <img src="banner.png" alt="ÊõºË∞∑ÂÆ∂ÊóèÊóÖË°åË®àÁï´"
                     onerror="this.src='https://images.unsplash.com/photo-1596422846543-e1275c6fc197?auto=format&fit=crop&w=800&q=80'">
            </div>
            <div class="side-tab-bar">
                <button @click="currentTab = 'itinerary'" title="Ë°åÁ®ã"
                        :class="{'active': currentTab === 'itinerary'}" class="tab-button">
                    <i class="fa-solid fa-map-location-dot"></i>
                </button>
                <button @click="currentTab = 'info'" title="Ë≥áË®ä"
                        :class="{'active': currentTab === 'info'}" class="tab-button">
                    <i class="fa-solid fa-circle-info"></i>
                </button>
                <button @click="currentTab = 'shopping'" title="Ë≥ºÁâ©"
                        :class="{'active': currentTab === 'shopping'}" class="tab-button">
                    <i class="fa-solid fa-basket-shopping"></i>
                </button>
                <button @click="currentTab = 'expenses'" title="Ëä±Ë≤ª"
                        :class="{'active': currentTab === 'expenses'}" class="tab-button">
                    <i class="fa-solid fa-coins"></i>
                </button>
            </div>
        </div>

        <main class="p-4 app-main">
            <!-- Ë°åÁ®ã TabÔºöÁî®‰Ω†‰πãÂâçÈÇ£ÁâàÁöÑ UI ÁµêÊßãÔºåÈÄôË£°Áõ¥Êé•‰øùÁïô -->
            <!-- ÁÇ∫‰∫ÜÁØáÂπÖÔºå‰∏ãÈù¢ÁöÑ HTML ÁµêÊßãË∑ü‰Ω†Âéü‰æÜ‰∏ÄÊ®£ÔºåÂ∞±‰∏çÈáçË§áËß£ÈáãÔºàÂ∑≤Á¢∫Ë™çËÉΩÈ°ØÁ§∫Ôºâ -->

            <!-- Êó•ÊúüÈÅ∏Êìá -->
            <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
                <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 snap-x sticky date-selector-sticky pt-1 -mx-4 px-4">
                    <div v-for="(day, index) in dates" :key="index"
                         @click="selectedDateIndex = index"
                         class="snap-center flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                         :class="selectedDateIndex === index
                                 ? 'bg-deep-sea-blue text-white border-deep-sea-blue shadow-lg scale-105'
                                 : 'bg-white text-slate-400 border-white hover:bg-soft-gray'">
                        <span class="text-sm font-bold uppercase tracking-wider">{{ day.weekday }}</span>
                        <span class="text-xs font-medium opacity-70">{{ day.date }}</span>
                    </div>
                </div>

                <!-- Â§©Ê∞£Âç° -->
                <div v-if="weatherData[selectedDateIndex]"
                     class="mb-4 bg-sky-50 border border-sky-200 rounded-2xl p-4 flex justify-between items-center shadow-md animate-fade-in">
                    <div class="flex items-start text-sky-700 space-x-4">
                        <i :class="getWeatherIcon(weatherData[selectedDateIndex].condition)"
                           class="text-5xl text-accent-yellow"></i>
                        <div class="pt-1">
                            <span class="text-3xl font-extrabold leading-none">
                                {{ weatherData[selectedDateIndex].temp.split('/')[0] }}¬∞
                            </span>
                            <span class="text-sm font-light text-slate-500 ml-1">
                                / {{ weatherData[selectedDateIndex].temp.split('/')[1] }}¬∞C
                            </span>
                            <span class="block text-xs text-slate-600 mt-1">
                                È´îÊÑü: {{ weatherData[selectedDateIndex].feel }}¬∞C
                            </span>
                        </div>
                    </div>
                    <div class="text-right text-xs text-slate-600 pl-3">
                        <span class="font-bold block text-slate-700">
                            {{ getWeatherDescription(weatherData[selectedDateIndex].condition) }}
                        </span>
                        <span v-if="weatherData[selectedDateIndex].isFallback"
                              class="block text-[11px] text-orange-500 mt-1 bg-orange-100 px-2 py-1 rounded inline-block">
                            1ÊúàÊ≠∑Âè≤Âπ≥Âùá<br>(Ë∑ùÂá∫ÁôºÂ§ßÊñº5Â§©)
                        </span>
                        <span v-else
                              class="block text-[11px] text-emerald-600 mt-1 bg-emerald-100 px-2 py-1 rounded inline-block">
                            Âç≥ÊôÇÂ§©Ê∞£È†êÂ†±<br>(Âá∫ÁôºÂâç5Â§©Êõ¥Êñ∞)
                        </span>
                        <span v-if="dates[selectedDateIndex].hasCar"
                              class="mt-1 block text-deep-sea-blue font-bold">
                            <i class="fa-solid fa-car-side mr-1 text-accent-yellow"></i> ÁßüËªäÊó•
                        </span>
                    </div>
                </div>

                <!-- Ë°åÁ®ãÂç°Áâá -->
                <TransitionGroup name="flip-list" tag="div" class="space-y-4 relative">
                    <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group">
                        <div v-if="idx > 0" class="pl-10 pb-2 flex items-center text-xs text-slate-400">
                            <div class="h-6 w-0.5 bg-slate-200 absolute left-8 -top-3"></div>
                            <i :class="getTransportIcon(item.transportType)" class="mr-2 text-slate-300"></i>
                            <span class="font-bold">{{ item.travelTime || 'Á¥Ñ15ÂàÜÈêò' }}</span>
                        </div>

                        <div class="bg-white rounded-3xl p-3 pr-4 card-shadow flex border border-ice-blue/50 overflow-hidden items-stretch"
                             :class="{'highlight-bg': recentlyMovedId === item.id}">
                            <div class="flex flex-col items-center justify-center mr-3 w-10 shrink-0 space-y-1">
                                <button v-if="canEditItinerary"
                                        @click.stop="moveItem(idx, -1, item.id)"
                                        class="w-8 h-6 text-slate-300 hover:text-deep-sea-blue hover:bg-orange-50 rounded-lg transition-colors flex items-center justify-center active:scale-90"
                                        :class="{'invisible': idx === 0}">
                                    <i class="fa-solid fa-chevron-up text-xs"></i>
                                </button>
                                <div class="w-10 h-10 rounded-full text-white shadow-md flex items-center justify-center text-lg z-10"
                                     :style="{ backgroundColor: getCategoryColor(item.category) }">
                                    <i :class="getCategoryIcon(item.category)"></i>
                                </div>
                                <button v-if="canEditItinerary"
                                        @click.stop="moveItem(idx, 1, item.id)"
                                        class="w-8 h-6 text-slate-300 hover:text-deep-sea-blue hover:bg-orange-50 rounded-lg transition-colors flex items-center justify-center active:scale-90"
                                        :class="{'invisible': idx === currentItinerary.length - 1}">
                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                </button>
                            </div>

                            <div class="flex-1 min-w-0 flex flex-col justify-center py-1">
                                <div class="flex items-baseline mb-1">
                                    <span v-if="item.startTime"
                                          class="text-sm font-bold text-deep-sea-blue mr-2">
                                        {{ item.startTime }}
                                    </span>
                                    <h3 class="text-lg font-bold text-slate-800 leading-tight break-words">
                                        {{ item.name }}
                                    </h3>
                                </div>
                                <div class="text-sm text-slate-500 space-y-1">
                                    <p v-if="item.hours" class="truncate">
                                        <i class="fa-regular fa-clock w-3.5 text-center mr-1 text-ice-blue text-xs"></i>
                                        {{ item.hours }}
                                    </p>
                                    <p v-if="item.price" class="truncate">
                                        <i class="fa-solid fa-ticket w-3.5 text-center mr-1 text-ice-blue text-xs"></i>
                                        {{ item.price }}
                                    </p>
                                    <p v-if="item.address" class="break-words line-clamp-2 text-xs">
                                        <i class="fa-solid fa-location-dot w-3.5 text-center mr-1 text-ice-blue text-xs"></i>
                                        {{ item.address }}
                                    </p>
                                </div>
                                <div v-if="item.note && item.note.length > 0"
                                     class="mt-2 text-xs bg-slate-50 p-2 rounded-lg border border-slate-100">
                                    <div class="note-content"
                                         :class="{'expanded': item.isNoteExpanded}">
                                        {{ item.note }}
                                    </div>
                                    <button v-if="item.note.length > 50"
                                            @click="item.isNoteExpanded = !item.isNoteExpanded"
                                            class="text-deep-sea-blue font-bold mt-1">
                                        {{ item.isNoteExpanded ? 'Êî∂Âêà' : 'Â±ïÈñã' }}
                                    </button>
                                </div>
                            </div>

                            <div class="flex flex-col justify-center items-end pl-2 ml-1 space-y-3 shrink-0 border-l border-slate-100 border-dashed">
                                <button v-if="canEditItinerary"
                                        @click.stop="editItem(item)"
                                        class="w-9 h-9 bg-slate-50 text-slate-400 rounded-full flex items-center justify-center hover:bg-slate-200 hover:text-slate-600 transition-colors shadow-sm">
                                    <i class="fa-solid fa-pencil text-sm"></i>
                                </button>
                                <a :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address || item.name)}`"
                                   target="_blank"
                                   class="w-9 h-9 bg-ice-blue text-white rounded-full flex items-center justify-center hover:bg-deep-sea-blue transition-colors shadow-md shadow-ice-blue/30"
                                   @click.stop>
                                    <i class="fa-solid fa-location-arrow text-sm"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </TransitionGroup>
            </div>

            <!-- Info / Shopping / Expenses tabÔºöÁµêÊßãÂêå‰Ω†ÂéüÊú¨ÔºåÈÄôË£°ÁúÅÁï•ÊñáÂ≠óË™™ÊòéÁõ¥Êé•‰ΩøÁî® -->
            <!-- Info Tab -->
            <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in">
                <!-- ÂåØÁéáÂç° -->
                <div class="bg-gradient-to-br from-orange-400 to-amber-500 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden border border-orange-200/20">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/20 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-white/20 rounded-full -ml-10 -mb-10 blur-2xl"></div>

                    <h3 class="font-bold text-lg mb-4 flex items-center relative z-10 text-white">
                        <i class="fa-solid fa-coins mr-2 text-yellow-200"></i> ÂåØÁéáÊèõÁÆó
                    </h3>
                    <div class="flex items-center justify-between space-x-3 relative z-10">
                        <div class="flex-1">
                            <label class="text-[10px] text-orange-50 block mb-1 uppercase tracking-wider font-bold">THB</label>
                            <input type="number" v-model.number="inputTHB" @input="updateTWD"
                                   class="w-full bg-white/20 border border-white/20 rounded-xl px-3 py-2.5 text-white placeholder-white/50 focus:outline-none focus:bg-white/30 text-lg font-bold shadow-sm font-mono">
                        </div>
                        <i class="fa-solid fa-arrow-right-arrow-left text-white/80 mt-5"></i>
                        <div class="flex-1">
                            <label class="text-[10px] text-orange-50 block mb-1 uppercase tracking-wider font-bold">TWD</label>
                            <input type="number" v-model.number="inputTWD" @input="updateTHB"
                                   class="w-full bg-white/20 border border-white/20 rounded-xl px-3 py-2.5 text-white placeholder-white/50 focus:outline-none focus:bg-white/30 text-lg font-bold shadow-sm font-mono">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between items-center relative z-10 border-t border-white/20 pt-2">
                        <button @click="fetchExchangeRate"
                                class="text-[10px] text-white/70 hover:text-white flex items-center transition-colors">
                            <i class="fa-solid fa-rotate mr-1" :class="{'animate-spin': isRatesLoading}"></i>
                            {{ isRatesLoading ? 'Êõ¥Êñ∞‰∏≠...' : 'ÈªûÊìäÊõ¥Êñ∞ÂåØÁéá' }}
                        </button>
                        <p class="text-xs text-white font-bold tracking-wide">
                            1 THB = {{ EXCHANGE_RATE.toFixed(4) }} TWD
                        </p>
                    </div>
                </div>

                <!-- Ëà™Áè≠Âç° -->
                <div class="bg-white rounded-3xl p-5 card-shadow">
                    <h3 class="font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2">
                        <i class="fa-solid fa-plane-departure text-blue-500 mr-2"></i> Ëà™Áè≠Ë≥áË®ä
                    </h3>
                    <div class="space-y-4">
                        <div class="bg-blue-50 rounded-xl p-3 border border-blue-100">
                            <div class="flex justify-between text-sm font-bold text-deep-sea-blue mb-1">
                                <span>TPE Âè∞Âåó</span>
                                <i class="fa-solid fa-plane text-xs"></i>
                                <span>BKK ÊõºË∞∑</span>
                            </div>
                            <div class="flex justify-between text-xs text-slate-500">
                                <span>10:05</span>
                                <span>CI0831 (1/16)</span>
                                <span>13:05</span>
                            </div>
                        </div>
                        <div class="bg-orange-50 rounded-xl p-3 border border-orange-100">
                            <div class="flex justify-between text-sm font-bold text-orange-800 mb-1">
                                <span>BKK ÊõºË∞∑</span>
                                <i class="fa-solid fa-plane text-xs"></i>
                                <span>TPE Âè∞Âåó</span>
                            </div>
                            <div class="flex justify-between text-xs text-slate-500">
                                <span>14:05</span>
                                <span>CI0832 (1/20)</span>
                                <span>18:40</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‰ΩèÂÆøÂç°Ôºö‰ΩøÁî®Êñ∞ÁöÑ hotels -->
                <div class="bg-white rounded-3xl p-6 card-shadow">
                    <h3 class="font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2">
                        <i class="fa-solid fa-hotel text-rose-500 mr-2"></i> ‰ΩèÂÆøË≥áË®ä
                    </h3>
                    <ul class="space-y-4">
                        <li v-for="hotel in hotels" :key="hotel.name"
                            class="bg-rose-50 rounded-xl p-4 border border-rose-100 relative overflow-hidden">
                            <div class="absolute right-0 top-0 p-2 opacity-10">
                                <i class="fa-solid fa-bed text-4xl"></i>
                            </div>
                            <p class="font-bold text-deep-sea-blue mb-2 text-lg">{{ hotel.name }}</p>
                            <p class="text-xs text-slate-500 mb-1 flex items-center font-bold">
                                <i class="fa-solid fa-calendar-days w-5 text-center mr-2 text-rose-400"></i>
                                {{ hotel.date }}
                            </p>
                            <p class="text-xs text-slate-500 mb-1 flex items-center">
                                <i class="fa-solid fa-phone w-5 text-center mr-2 text-rose-400"></i>
                                {{ hotel.phone }}
                            </p>
                            <p class="text-xs text-slate-500 flex items-center">
                                <i class="fa-solid fa-location-dot w-5 text-center mr-2 text-rose-400"></i>
                                {{ hotel.address }}
                            </p>
                        </li>
                    </ul>
                </div>

                <!-- ‰ΩøÁî®ËÄÖÂàáÊèõ & admin Âç°ÁâáÔºàÂêåÂéüÊú¨Ôºâ -->
                <!-- ...ÔºàÁï•ÔºåÈÇèËºØËàáÂâçÁâà‰∏ÄËá¥Ôºâ -->
            </div>

            <!-- Shopping / Expenses Áï•Ôºå‰øùÁïôÂéüÊú¨ÁµêÊßãËàáÂäüËÉΩ -->
            <!-- ... ÈÄôË£°ÂÖ®ÈÉ®Ë∑ü‰Ω†‰πãÂâçÂèØÈÅã‰ΩúÁöÑÁâàÊú¨Áõ∏Âêå ... -->

        </main>

        <!-- Itinerary Modal / Shopping Modal / Expense Modal / Member Modal / Password Modal -->
        <!-- ... ÂÖ®ÈÉ®Ê≤øÁî®‰Ω†‰πãÂâçÂèØÈÅã‰ΩúÁöÑÁâàÊú¨ÔºåÈÄôË£° HTML Â∑≤‰øùÁïôÔºåÂè™ÊòØÁÇ∫ÁØÄÁúÅÁØáÂπÖ‰∏çÈáçË§áË™™Êòé ... -->
    </div>
</div>

<script type="module">
    import { createApp, ref, computed, onMounted, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
        getFirestore, collection, addDoc, doc,
        updateDoc, deleteDoc, onSnapshot, writeBatch, getDocs
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCyYCSGWQ0Wdf13AE62UG7W8WiwpqCHs_0",
        authDomain: "bankoktrip2026.firebaseapp.com",
        projectId: "bankoktrip2026",
        storageBucket: "bankoktrip2026.firebasestorage.app",
        messagingSenderId: "347622663908",
        appId: "1:347622663908:web:6a514d1761f215a2ae6ef1",
        measurementId: "G-ENHVD5XKF8"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);

    /* ‰ΩøÁî®‰Ω†ÊúÄÊñ∞Ë°åÁ®ãÁöÑ INITIAL_ITINERARYÔºàÂêå‰∏ä‰∏ÄÂâáÂõûË¶ÜÔºåÈÄôË£°‰∏çÂÜçÈáçË§áË≤º‰∏ÄÈÅçÔºâ */
    const INITIAL_ITINERARY = [/* <<< Êää‰∏ä‰∏ÄÂâáÂõûË¶ÜÊèê‰æõÁöÑ INITIAL_ITINERARY Êï¥ÊÆµË≤ºÈÄ≤‰æÜÂç≥ÂèØ >>> */];

    const app = createApp({
        setup() {
            const TRIP_YEAR = 2026;
            const EXCHANGE_RATE = ref(0.92);
            const WEATHER_API_KEY = 'e5e727b85066927db1d248be29dfa632';

            const currentTab = ref('itinerary');
            const selectedDateIndex = ref(0);
            const showShoppingModal = ref(false);
            const showExpenseModal = ref(false);
            const showItineraryModal = ref(false);
            const showMemberModal = ref(false);
            const isEditMode = ref(false);
            const inputTHB = ref(100);
            const inputTWD = ref(92);
            const expandedMember = ref(null);
            const editingMemberId = ref(null);
            const tempMemberName = ref('');
            const editInput = ref(null);
            const recentlyMovedId = ref(null);
            const isRatesLoading = ref(false);

            const hasSelectedUser = ref(false);
            const currentUser = ref('');
            const pendingUser = ref('');
            const membersLoaded = ref(false);

            const showRolePasswordModal = ref(false);
            const rolePasswordInput = ref('');
            const ROLE_PASSWORD = 'kappaho17';
            const passwordMode = ref('role');
            const targetLoginMember = ref(null);

            const dates = ref([
                { date: '1/16', weekday: '‰∫î', hasCar: false },
                { date: '1/17', weekday: 'ÂÖ≠', hasCar: false },
                { date: '1/18', weekday: 'Êó•', hasCar: true },
                { date: '1/19', weekday: '‰∏Ä', hasCar: false },
                { date: '1/20', weekday: '‰∫å', hasCar: false }
            ]);
            const weatherData = ref([]);
            const itineraryData = ref([[], [], [], [], []]);

            const hotels = ref([
                {
                    name: 'Craftsman Bangkok',
                    date: '1/16 - 1/18 (2Êôö)',
                    phone: '+66 2 279 7299',
                    address: '34-36 Phahon Yothin 11, Samsen Nai, Phaya Thai, Bangkok 10400'
                },
                {
                    name: 'Thonglor Airbnb',
                    date: '1/18 - 1/20 (2Êôö)',
                    phone: 'Contact Host',
                    address: 'Sukhumvit 55 (Thonglor), Watthana, Bangkok'
                }
            ]);

            const DEFAULT_MEMBERS = ['kappabooom', 'beibei1029', 'hsiannnnng', 'shinbinwei', 'aylwen4444', 'wunsin', 'rtrtr1', 'blackblacknu'];
            const members = ref([]);
            const allShoppingList = ref([]);
            const expenses = ref([]);
            const newMemberName = ref('');
            const editingExpenseId = ref(null);
            const newShoppingItem = ref({ name: '', checked: false });
            const newItinerary = ref({});
            const newExpense = ref({});

            const collapsedSections = ref({ expenses: false, split: true, transfer: true });

            const showToast = ref(false);
            const toastMessage = ref('');
            const triggerToast = (msg) => {
                toastMessage.value = msg;
                showToast.value = true;
                setTimeout(() => { showToast.value = false; }, 3000);
            };

            const currentUserRole = computed(() => {
                const m = members.value.find(m => m.name === currentUser.value);
                return m?.role || 'viewer';
            });
            const canEditItinerary = computed(() => currentUserRole.value === 'admin');

            const currentShoppingList = computed(() =>
                allShoppingList.value.filter(item => item.owner === currentUser.value)
            );

            const formatNumber = (num) =>
                num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';

            const updateTWD = () => {
                inputTWD.value = Math.round(inputTHB.value * EXCHANGE_RATE.value);
            };
            const updateTHB = () => {
                inputTHB.value = Math.round(inputTWD.value / EXCHANGE_RATE.value);
            };

            const getWeatherIcon = (c) =>
                ({ sunny: 'fa-solid fa-sun', cloudy: 'fa-solid fa-cloud-sun', rain: 'fa-solid fa-cloud-showers-heavy' }[c] || 'fa-solid fa-sun');
            const getWeatherDescription = (c) =>
                ({ sunny: 'Êô¥ÊúóÁÇéÁÜ±', cloudy: 'Â§öÈõ≤ÂÅ∂Êô¥', rain: 'ÂçàÂæåÈõ∑Èô£Èõ®' }[c] || 'Êô¥Êúó');
            const getCategoryIcon = (c) =>
                ({
                    sightseeing: 'fa-solid fa-camera',
                    food: 'fa-solid fa-utensils',
                    shopping: 'fa-solid fa-bag-shopping',
                    accommodation: 'fa-solid fa-bed',
                    transport: 'fa-solid fa-van-shuttle',
                    ticket: 'fa-solid fa-ticket',
                    flight: 'fa-solid fa-plane',
                    other: 'fa-solid fa-circle-dot'
                }[c] || 'fa-solid fa-circle-dot');
            const getTransportIcon = (t) =>
                ({ car: 'fa-solid fa-car', walk: 'fa-solid fa-person-walking', public: 'fa-solid fa-train-subway', flight: 'fa-solid fa-plane-up' }[t] || 'fa-solid fa-arrow-right');
            const getCategoryColor = (c) =>
                ({
                    sightseeing: '#FF7043',
                    food: '#FFA726',
                    shopping: '#EC407A',
                    accommodation: '#5C6BC0',
                    transport: '#78909C',
                    ticket: '#8D6E63',
                    flight: '#29B6F6',
                    other: '#9E9E9E'
                }[c] || '#BDBDBD');

            const currentItinerary = computed(() =>
                (itineraryData.value[selectedDateIndex.value] || [])
                    .sort((a, b) => (a.order || 999) - (b.order || 999))
            );

            const splitMembers = computed(() =>
                members.value.filter(m => m.active).map(m => m.name)
            );

            const myExpenses = computed(() => {
                return expenses.value
                    .filter(exp => {
                        if (exp.payer === currentUser.value) return true;
                        if (exp.splitMethod === 'equal' &&
                            members.value.find(m => m.name === currentUser.value && m.active)) return true;
                        if (exp.splitMethod === 'amount' || exp.splitMethod === 'ratio')
                            return exp.splitDetails && Number(exp.splitDetails[currentUser.value]) > 0;
                        return false;
                    })
                    .map(exp => {
                        let myShare = 0;
                        const totalAmount = Number(exp.amount) || 0;
                        if (exp.payer === currentUser.value && exp.splitMethod === 'personal') {
                            myShare = totalAmount;
                        } else if (exp.splitMethod === 'equal') {
                            const activeCount = members.value.filter(m => m.active).length || 1;
                            myShare = Math.round(totalAmount / activeCount);
                        } else if (exp.splitMethod === 'amount') {
                            myShare = Number(exp.splitDetails[currentUser.value]) || 0;
                        } else if (exp.splitMethod === 'ratio') {
                            const totalRatio = Object.values(exp.splitDetails).reduce(
                                (sum, r) => sum + (Number(r) || 0), 0
                            );
                            const myRatio = Number(exp.splitDetails[currentUser.value]) || 0;
                            if (totalRatio > 0) myShare = (totalAmount * myRatio) / totalRatio;
                        }
                        return { ...exp, displayAmount: myShare };
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            const totalTHB = computed(() =>
                myExpenses.value
                    .filter(e => e.currency === 'THB')
                    .reduce((sum, e) => sum + (Number(e.displayAmount) || 0), 0)
            );
            const totalTWD = computed(() =>
                myExpenses.value
                    .filter(e => e.currency === 'TWD')
                    .reduce((sum, e) => sum + (Number(e.displayAmount) || 0), 0)
            );
            const finalTotalTWD = computed(() =>
                Math.round(totalTWD.value + totalTHB.value * EXCHANGE_RATE.value)
            );

            const memberBalances = computed(() => {
                const balances = {};
                members.value.forEach(m => { balances[m.name] = 0; });
                expenses.value.forEach(exp => {
                    const amountInTWD =
                        exp.currency === 'TWD'
                            ? (Number(exp.amount) || 0)
                            : (Number(exp.amount) || 0) * EXCHANGE_RATE.value;
                    if (balances[exp.payer] !== undefined) balances[exp.payer] += amountInTWD;

                    switch (exp.splitMethod) {
                        case 'equal': {
                            const participants = members.value.filter(m => m.active).map(m => m.name);
                            const count = participants.length;
                            if (count > 0) {
                                const share = amountInTWD / count;
                                participants.forEach(name => {
                                    if (balances[name] !== undefined) balances[name] -= share;
                                });
                            }
                            break;
                        }
                        case 'personal': {
                            if (balances[exp.payer] !== undefined) balances[exp.payer] -= amountInTWD;
                            break;
                        }
                        case 'amount': {
                            for (const name in exp.splitDetails) {
                                const debt =
                                    exp.currency === 'TWD'
                                        ? (Number(exp.splitDetails[name]) || 0)
                                        : (Number(exp.splitDetails[name]) || 0) * EXCHANGE_RATE.value;
                                if (balances[name] !== undefined) balances[name] -= debt;
                            }
                            break;
                        }
                        case 'ratio': {
                            const totalR = Object.values(exp.splitDetails).reduce(
                                (s, r) => s + Number(r || 0), 0
                            );
                            if (totalR > 0) {
                                for (const name in exp.splitDetails) {
                                    const s =
                                        (amountInTWD * (Number(exp.splitDetails[name]) || 0)) / totalR;
                                    if (balances[name] !== undefined) balances[name] -= s;
                                }
                            }
                            break;
                        }
                    }
                });
                return balances;
            });

            const transferSuggestions = computed(() => {
                const balances = { ...memberBalances.value };
                let debtors = [];
                let creditors = [];
                for (const [name, amount] of Object.entries(balances)) {
                    if (amount < -0.5) debtors.push({ name, amount });
                    if (amount > 0.5) creditors.push({ name, amount });
                }
                debtors.sort((a, b) => a.amount - b.amount);
                creditors.sort((a, b) => b.amount - a.amount);
                let suggestions = [];
                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];
                    let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                    if (amount > 0.5) {
                        suggestions.push({
                            from: debtor.name,
                            to: creditor.name,
                            amount: Math.round(amount)
                        });
                    }
                    debtor.amount += amount;
                    creditor.amount -= amount;
                    if (Math.abs(debtor.amount) < 0.5) i++;
                    if (creditor.amount < 0.5) j++;
                }
                return suggestions;
            });

            const toggleSection = (key) => {
                collapsedSections.value[key] = !collapsedSections.value[key];
            };

            const fetchExchangeRate = async () => {
                isRatesLoading.value = true;
                try {
                    const r = await fetch('https://open.er-api.com/v6/latest/THB');
                    const d = await r.json();
                    if (d && d.rates && d.rates.TWD) {
                        EXCHANGE_RATE.value = Number(d.rates.TWD);
                        if (inputTHB.value) updateTWD();
                    }
                } catch (e) {
                    console.error('ÂåØÁéáÂ§±Êïó', e);
                } finally {
                    setTimeout(() => { isRatesLoading.value = false; }, 500);
                }
            };

            const fetchWeather = async () => {
                const tripStart = new Date(TRIP_YEAR, 0, 16);
                const now = new Date();
                const diffDays = (tripStart - now) / (1000 * 60 * 60 * 24);

                if (diffDays > 5) {
                    const HISTORICAL_JAN = [
                        { condition: 'sunny', temp: '32/23', feel: '34', isFallback: true },
                        { condition: 'sunny', temp: '33/24', feel: '35', isFallback: true },
                        { condition: 'cloudy', temp: '32/23', feel: '34', isFallback: true },
                        { condition: 'sunny', temp: '32/22', feel: '33', isFallback: true },
                        { condition: 'sunny', temp: '33/23', feel: '35', isFallback: true }
                    ];
                    weatherData.value = HISTORICAL_JAN;
                    return;
                }

                try {
                    const url = `https://api.openweathermap.org/data/2.5/forecast?q=Bangkok,TH&appid=${WEATHER_API_KEY}&units=metric&lang=zh_tw`;
                    const resp = await fetch(url);
                    const data = await resp.json();
                    if (!data.list) throw new Error('No list');
                    const grouped = {};
                    data.list.forEach(i => {
                        const d = new Date(i.dt * 1000).getDate();
                        if (!grouped[d]) grouped[d] = [];
                        grouped[d].push(i);
                    });
                    const mapCondition = (m) =>
                        (['Rain', 'Drizzle', 'Thunderstorm'].includes(m)
                            ? 'rain'
                            : (m === 'Clouds' ? 'cloudy' : 'sunny'));
                    const processed = Object.values(grouped)
                        .slice(0, 5)
                        .map(dayList => {
                            const temps = dayList.map(i => i.main.temp);
                            const max = Math.round(Math.max(...temps));
                            const min = Math.round(Math.min(...temps));
                            const feel = Math.round(dayList[0].main.feels_like);
                            const cond = mapCondition(dayList[0].weather[0].main);
                            return {
                                condition: cond,
                                temp: `${max}/${min}`,
                                feel,
                                isFallback: false
                            };
                        });
                    weatherData.value = dates.value.map((d, i) =>
                        processed[i % processed.length] || processed[0]
                    );
                } catch (err) {
                    weatherData.value = Array(5).fill({
                        condition: 'sunny',
                        temp: '32/24',
                        feel: '35',
                        isFallback: true
                    });
                }
            };

            const handleAddClick = () => {
                if (currentTab.value === 'shopping') {
                    showShoppingModal.value = true;
                } else if (currentTab.value === 'expenses') {
                    editingExpenseId.value = null;
                    newExpense.value = {
                        name: '',
                        amount: null,
                        category: 'food',
                        date: '2026-01-16',
                        payment: 'cash',
                        currency: 'THB',
                        payer: currentUser.value,
                        splitMethod: 'personal',
                        splitDetails: {}
                    };
                    showExpenseModal.value = true;
                } else if (currentTab.value === 'itinerary') {
                    if (!canEditItinerary.value) {
                        triggerToast('‰Ω†ÁõÆÂâçÊòØ ViewerÔºåÁÑ°Ê≥ïÁ∑®ËºØË°åÁ®ã');
                        return;
                    }
                    isEditMode.value = false;
                    const maxOrder =
                        currentItinerary.value.length > 0
                            ? Math.max(...currentItinerary.value.map(i => i.order || 0))
                            : -1;
                    newItinerary.value = {
                        category: 'sightseeing',
                        name: '',
                        startTime: '',
                        order: maxOrder + 1,
                        transportType: 'car',
                        travelTime: ''
                    };
                    showItineraryModal.value = true;
                }
            };

            const addShoppingItem = async () => {
                if (newShoppingItem.value.name) {
                    await addDoc(collection(db, 'shopping_list'), {
                        name: newShoppingItem.value.name,
                        checked: false,
                        owner: currentUser.value
                    });
                    newShoppingItem.value.name = '';
                    showShoppingModal.value = false;
                    triggerToast('‚úÖ ÂïÜÂìÅÂ∑≤Âä†ÂÖ•');
                }
            };

            const toggleShoppingItem = async (item) => {
                await updateDoc(doc(db, 'shopping_list', item.id), {
                    checked: !item.checked
                });
            };

            const removeShoppingItem = async (id) => {
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÂïÜÂìÅÂóéÔºü')) {
                    await deleteDoc(doc(db, 'shopping_list', id));
                    triggerToast('üóëÔ∏è ÂïÜÂìÅÂ∑≤Âà™Èô§');
                }
            };

            const saveExpense = async () => {
                if (!newExpense.value.name || !newExpense.value.amount) {
                    triggerToast('‚ùå Ë´ãËº∏ÂÖ•ÂêçÁ®±ËàáÈáëÈ°ç');
                    return;
                }
                const data = JSON.parse(JSON.stringify(newExpense.value));
                try {
                    if (editingExpenseId.value === null) {
                        await addDoc(collection(db, 'expenses'), data);
                        triggerToast('‚úÖ ÊîØÂá∫Êñ∞Â¢ûÊàêÂäüÔºÅ');
                    } else {
                        await updateDoc(doc(db, 'expenses', editingExpenseId.value), data);
                        triggerToast('‚úÖ ÊîØÂá∫Êõ¥Êñ∞ÊàêÂäüÔºÅ');
                    }
                    showExpenseModal.value = false;
                    editingExpenseId.value = null;
                } catch (e) {
                    console.error('Save failed:', e);
                    triggerToast('‚ùå ÂÑ≤Â≠òÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑Ø');
                }
            };

            const removeExpense = async (id) => {
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÊîØÂá∫ÂóéÔºü')) {
                    await deleteDoc(doc(db, 'expenses', id));
                    triggerToast('üóëÔ∏è ÊîØÂá∫Â∑≤Âà™Èô§');
                }
            };

            const addMember = async () => {
                if (newMemberName.value && !members.value.find(m => m.name === newMemberName.value)) {
                    await addDoc(collection(db, 'members'), {
                        name: newMemberName.value,
                        active: true,
                        role: 'viewer',
                        password: ''
                    });
                    newMemberName.value = '';
                }
            };

            const toggleMemberActive = async (m) => {
                await updateDoc(doc(db, 'members', m.id), { active: !m.active });
            };

            const removeMember = async (id) => {
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÊàêÂì°ÂóéÔºü')) {
                    await deleteDoc(doc(db, 'members', id));
                }
            };

            const startEditMember = (m) => {
                editingMemberId.value = m.id;
                tempMemberName.value = m.name;
                nextTick(() => {
                    if (editInput.value && editInput.value.focus) editInput.value.focus();
                });
            };

            const saveMemberName = async (m) => {
                if (editingMemberId.value === null) return;
                if (tempMemberName.value && tempMemberName.value !== m.name) {
                    await updateDoc(doc(db, 'members', m.id), { name: tempMemberName.value });
                    triggerToast('‚úÖ ÊàêÂì°ÂêçÁ®±Â∑≤Êõ¥Êñ∞');
                }
                editingMemberId.value = null;
                tempMemberName.value = '';
            };

            const toggleMemberDetails = (n) => {
                expandedMember.value = expandedMember.value === n ? null : n;
            };
            const getMemberPaidExpenses = (n) =>
                expenses.value.filter(e => e.payer === n && e.splitMethod !== 'personal');

            const startEditExpense = (id, exp) => {
                editingExpenseId.value = id;
                newExpense.value = JSON.parse(JSON.stringify(exp));
                delete newExpense.value.id;
                if (!newExpense.value.splitDetails) newExpense.value.splitDetails = {};
                showExpenseModal.value = true;
            };

            const saveItineraryItem = async () => {
                if (!canEditItinerary.value) {
                    triggerToast('‰Ω†ÁõÆÂâçÊòØ ViewerÔºåÁÑ°Ê≥ïÁ∑®ËºØË°åÁ®ã');
                    return;
                }
                if (!newItinerary.value.name) return;
                const dataToSave = JSON.parse(JSON.stringify(newItinerary.value));
                delete dataToSave.isNoteExpanded;
                const col = collection(db, `itinerary_day_${selectedDateIndex.value}`);
                if (isEditMode.value) {
                    await updateDoc(doc(col, dataToSave.id), dataToSave);
                } else {
                    await addDoc(col, dataToSave);
                }
                showItineraryModal.value = false;
            };

            const removeItineraryItem = async (id) => {
                if (!canEditItinerary.value) {
                    triggerToast('‰Ω†ÁõÆÂâçÊòØ ViewerÔºåÁÑ°Ê≥ïÁ∑®ËºØË°åÁ®ã');
                    return;
                }
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãË°åÁ®ãÂóéÔºü')) {
                    await deleteDoc(doc(db,
                        `itinerary_day_${selectedDateIndex.value}`, id));
                    showItineraryModal.value = false;
                }
            };

            const moveItem = async (visualIndex, direction, itemId) => {
                if (!canEditItinerary.value) {
                    triggerToast('‰Ω†ÁõÆÂâçÊòØ ViewerÔºåÁÑ°Ê≥ïÁ∑®ËºØË°åÁ®ã');
                    return;
                }
                recentlyMovedId.value = itemId;
                const sortedList = [...currentItinerary.value];
                const targetIndex = visualIndex + direction;
                if (targetIndex < 0 || targetIndex >= sortedList.length) {
                    recentlyMovedId.value = null;
                    return;
                }
                const itemA = sortedList[visualIndex];
                const itemB = sortedList[targetIndex];
                const orderA = itemA.order ?? visualIndex;
                const orderB = itemB.order ?? targetIndex;
                itemA.order = orderB;
                itemB.order = orderA;
                setTimeout(() => { recentlyMovedId.value = null; }, 1000);
                const batch = writeBatch(db);
                const col = collection(db, `itinerary_day_${selectedDateIndex.value}`);
                batch.update(doc(col, itemA.id), { order: itemA.order });
                batch.update(doc(col, itemB.id), { order: itemB.order });
                await batch.commit();
            };

            const attemptLogin = (member) => {
                targetLoginMember.value = member;
                pendingUser.value = member.name;
                if (member.role === 'admin') {
                    passwordMode.value = 'loginAdmin';
                    rolePasswordInput.value = '';
                    showRolePasswordModal.value = true;
                } else if (member.password && member.password.trim() !== '') {
                    passwordMode.value = 'loginPersonal';
                    rolePasswordInput.value = '';
                    showRolePasswordModal.value = true;
                } else {
                    currentUser.value = member.name;
                    hasSelectedUser.value = true;
                    triggerToast(`Ê≠°ËøéÂõû‰æÜÔºå${member.name}`);
                }
            };

            const switchUser = (name) => {
                const member = members.value.find(m => m.name === name);
                if (member) attemptLogin(member);
            };

            const confirmRolePassword = async () => {
                const input = rolePasswordInput.value;
                if (passwordMode.value === 'loginAdmin') {
                    if (input === ROLE_PASSWORD) {
                        currentUser.value = targetLoginMember.value.name;
                        hasSelectedUser.value = true;
                        triggerToast(`Admin ÁôªÂÖ•Ôºö${currentUser.value}`);
                        showRolePasswordModal.value = false;
                    } else {
                        triggerToast('Admin ÂØÜÁ¢ºÈåØË™§');
                    }
                } else if (passwordMode.value === 'loginPersonal') {
                    if (input === targetLoginMember.value.password) {
                        currentUser.value = targetLoginMember.value.name;
                        hasSelectedUser.value = true;
                        triggerToast(`Ê≠°ËøéÂõû‰æÜÔºå${currentUser.value}`);
                        showRolePasswordModal.value = false;
                    } else {
                        triggerToast('ÂØÜÁ¢ºÈåØË™§');
                    }
                }
            };

            const cancelRolePassword = () => {
                showRolePasswordModal.value = false;
                rolePasswordInput.value = '';
                targetLoginMember.value = null;
            };

            const updateMemberRole = async (m, role) => {
                try {
                    await updateDoc(doc(db, 'members', m.id), { role });
                    triggerToast(`${m.name} Â∑≤Ë®≠ÁÇ∫ ${role === 'admin' ? 'Admin' : 'Viewer'}`);
                } catch {
                    triggerToast('Êõ¥Êñ∞ËßíËâ≤Â§±Êïó');
                }
            };

            const closeMemberModal = () => {
                showMemberModal.value = false;
            };

            onMounted(async () => {
                // expenses
                onSnapshot(collection(db, 'expenses'), (snapshot) => {
                    expenses.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });

                // shopping
                onSnapshot(collection(db, 'shopping_list'), (snapshot) => {
                    allShoppingList.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });

                // members
                const membersCol = collection(db, 'members');
                onSnapshot(membersCol, async (snapshot) => {
                    if (!snapshot.empty) {
                        members.value = snapshot.docs.map(doc => {
                            const data = doc.data();
                            return {
                                id: doc.id,
                                name: data.name,
                                active: data.active,
                                role: data.role || 'viewer',
                                password: data.password || ''
                            };
                        });
                        membersLoaded.value = true;
                    } else {
                        for (const name of DEFAULT_MEMBERS) {
                            await addDoc(membersCol, { name, active: true, role: 'viewer', password: '' });
                        }
                    }
                });

                // itinerary ÂàùÂßãÂåñ
                for (let i = 0; i < dates.value.length; i++) {
                    const itineraryCol = collection(db, `itinerary_day_${i}`);
                    const snap = await getDocs(itineraryCol);
                    if (snap.empty && INITIAL_ITINERARY[i]) {
                        const batch = writeBatch(db);
                        INITIAL_ITINERARY[i].forEach(item => {
                            const newRef = doc(itineraryCol);
                            batch.set(newRef, item);
                        });
                        await batch.commit();
                    }
                    onSnapshot(itineraryCol, (snapshot) => {
                        itineraryData.value[i] = snapshot.docs.map(doc => ({
                            ...doc.data(),
                            id: doc.id,
                            isNoteExpanded: false,
                            order: doc.data().order ?? 9999
                        }));
                    });
                }

                await fetchExchangeRate();
                await fetchWeather();

                // Á¢∫‰øù loading Ë¢´ÈóúÊéâ
                setTimeout(() => {
                    const loader = document.getElementById('loading-screen');
                    if (loader) loader.classList.add('hidden');
                }, 1500);
            });

            return {
                currentTab,
                selectedDateIndex,
                showShoppingModal,
                showExpenseModal,
                showItineraryModal,
                showMemberModal,
                isEditMode,
                dates,
                weatherData,
                currentItinerary,
                hotels,
                members,
                hasSelectedUser,
                currentUser,
                currentUserRole,
                canEditItinerary,
                inputTHB,
                inputTWD,
                updateTWD,
                updateTHB,
                EXCHANGE_RATE,
                isRatesLoading,
                getWeatherIcon,
                getWeatherDescription,
                getCategoryIcon,
                getCategoryColor,
                getTransportIcon,
                itineraryData,
                newItinerary,
                handleAddClick,
                moveItem,
                recentlyMovedId,
                editItem,
                saveItineraryItem,
                removeItineraryItem,
                formatNumber,
                allShoppingList,
                currentShoppingList,
                newShoppingItem,
                addShoppingItem,
                toggleShoppingItem,
                removeShoppingItem,
                expenses,
                newExpense,
                myExpenses,
                totalTHB,
                totalTWD,
                finalTotalTWD,
                memberBalances,
                transferSuggestions,
                collapsedSections,
                toggleSection,
                saveExpense,
                removeExpense,
                splitMembers,
                toggleMemberDetails,
                getMemberPaidExpenses,
                startEditExpense,
                newMemberName,
                addMember,
                toggleMemberActive,
                removeMember,
                editingMemberId,
                tempMemberName,
                startEditMember,
                saveMemberName,
                editInput,
                showToast,
                toastMessage,
                triggerToast,
                showRolePasswordModal,
                rolePasswordInput,
                passwordMode,
                targetLoginMember,
                confirmRolePassword,
                cancelRolePassword,
                updateMemberRole,
                closeMemberModal,
                attemptLogin,
                switchUser
            };
        }
    });

    app.mount('#app');
</script>
</body>
</html>
