<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Apple Touch Icon Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" href="apple-touch-icon.png">

    <title>2026曼谷旅行</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-white': '#FFFDE7',
                        'ice-blue': '#4DB6AC',
                        'light-snow-blue': '#FFF3E0',
                        'deep-sea-blue': '#E65100',
                        'accent-yellow': '#FFB300',
                        'soft-gray': '#FAFAFA'
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body {
            background-color: #FFF3E0;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-bottom: 90px;
        }

        .header-bg {
            background-color: #ffffff;
            padding: 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-bottom-left-radius: 35px;
            border-bottom-right-radius: 35px;
            z-index: 10;
        }

        .header-image-container {
            width: 100%;
            height: 250px;
            overflow: hidden;
            background-color: transparent;
            border-bottom-left-radius: 35px;
            border-bottom-right-radius: 35px;
        }

        .header-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .side-tab-bar {
            position: absolute;
            bottom:  15px;
            right: 16px;
            z-index: 30;
            display: flex;
            flex-direction: row;
            gap: 8px;
        }

        .tab-button {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .tab-button.active {
            background-color: #E65100;
            color: #ffffff;
            box-shadow: 0 6px 15px rgba(230, 81, 0, 0.4);
            transform: scale(1.05);
        }

        .tab-button:not(.active) {
            background-color: #ffffff;
            color: #4DB6AC;
        }

        .app-main {
            padding-top: 25px !important;
            position: relative;
            z-index: 5;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .card-shadow {
            box-shadow: 0 4px 20px rgba(230, 81, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fab-shadow {
            box-shadow: 0 4px 15px rgba(255, 179, 0, 0.5);
        }

        .note-content {
            max-height: 2.5rem;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .note-content.expanded {
            max-height: 500px;
        }

        .expenses-banner {
            background: linear-gradient(135deg, #FF7043 0%, #AB47BC 100%);
        }

        .date-selector-sticky {
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0;
            z-index: 20;
            top: 0;
            padding-top: env(safe-area-inset-top, 20px);
        }
        
        .placeholder-white::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <div class="header-bg relative">
            <div class="header-image-container">
                <img src="banner.png" alt="曼谷家族旅行計畫">
            </div>
            <div class="side-tab-bar">
                <button @click="currentTab = 'itinerary'" title="行程" :class="{'active': currentTab === 'itinerary'}" class="tab-button">
                    <i class="fa-solid fa-map-location-dot"></i>
                </button>
                <button @click="currentTab = 'info'" title="資訊" :class="{'active': currentTab === 'info'}" class="tab-button">
                    <i class="fa-solid fa-circle-info"></i>
                </button>
                <button @click="currentTab = 'shopping'" title="購物" :class="{'active': currentTab === 'shopping'}" class="tab-button">
                    <i class="fa-solid fa-basket-shopping"></i>
                </button>
                <button @click="currentTab = 'expenses'" title="花費" :class="{'active': currentTab === 'expenses'}" class="tab-button">
                    <i class="fa-solid fa-coins"></i>
                </button>
            </div>
        </div>

        <main class="p-4 app-main">
            <!-- 1. 行程 Tab -->
            <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
                <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 snap-x px-1 sticky date-selector-sticky pt-1 -mx-4 px-4">
                    <div v-for="(day, index) in dates" :key="index" @click="selectedDateIndex = index"
                         class="snap-center flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                         :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white border-deep-sea-blue shadow-lg scale-105' : 'bg-white text-slate-400 border-white hover:bg-soft-gray'">
                        <span class="text-sm font-bold uppercase tracking-wider">{{ day.weekday }}</span>
                        <span class="text-xs font-medium opacity-70">{{ day.date }}</span>
                    </div>
                </div>

                <!-- 天氣區塊 -->
                <div v-if="weatherData[selectedDateIndex] && !isPastDate" class="mb-4 bg-snow-white border border-ice-blue rounded-2xl p-4 flex justify-between items-center shadow-md animate-fade-in">
                    <div class="flex items-start text-deep-sea-blue space-x-4">
                        <i :class="getWeatherIcon(weatherData[selectedDateIndex].condition)" class="text-5xl text-accent-yellow"></i>
                        <div class="pt-1">
                            <span class="text-3xl font-extrabold leading-none">{{ weatherData[selectedDateIndex].temp.split('/')[0] }}°</span>
                            <span class="text-sm font-light text-slate-500 ml-1">/ {{ weatherData[selectedDateIndex].temp.split('/')[1] }}°C</span>
                            <span class="block text-xs text-slate-600 mt-1">體感: {{ weatherData[selectedDateIndex].feel }}°C</span>
                        </div>
                    </div>
                    <div class="text-right text-xs text-slate-600 pl-3">
                        <span class="font-bold block text-slate-700">{{ getWeatherDescription(weatherData[selectedDateIndex].condition) }}</span>
                        
                        <!-- 預計 / 非預計日期註記 -->
                        <span v-if="weatherData[selectedDateIndex].isFallback" class="block text-[11px] text-orange-500 mt-1">
                            非預計日期<br>
                            (顯示 {{ weatherData[selectedDateIndex].sourceDate }} 天氣)
                        </span>
                        <span v-else class="block text-[11px] text-emerald-600 mt-1">
                            預計日期天氣<br>
                            ({{ weatherData[selectedDateIndex].sourceDate }})
                        </span>

                        <span v-if="dates[selectedDateIndex].hasCar" class="mt-1 block text-deep-sea-blue font-bold">
                            <i class="fa-solid fa-car-side mr-1 text-accent-yellow"></i> 租車日
                        </span>
                        <span v-else class="mt-1 block text-slate-400">本日步行/大眾運輸</span>
                    </div>
                </div>
                <!-- 當天氣被隱藏時的提示 (可選) -->
                
                <div class="space-y-4">
                    <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group">
                        <div v-if="idx > 0" class="pl-8 pb-2 flex items-center text-xs text-slate-400">
                            <div class="h-6 w-0.5 bg-slate-200 absolute left-6 -top-3"></div>
                            <i :class="getTransportIcon(item.transportType)" 
                               class="mr-2 text-slate-300 cursor-pointer hover:text-deep-sea-blue transition-colors"
                               @click="openMapDirections(currentItinerary[idx - 1], item)"></i>
                            <span class="font-bold">{{ item.travelTime || '約15分鐘' }}</span>
                        </div>

                        <div class="bg-white rounded-3xl p-5 card-shadow relative overflow-hidden flex items-start border border-ice-blue/50">
                            <div class="mr-4 flex flex-col items-center min-w-[50px]">
                                <div class="p-2 rounded-full text-white shadow-md text-base mb-1" :style="{ backgroundColor: getCategoryColor(item.category) }">
                                    <i :class="getCategoryIcon(item.category)"></i>
                                </div>
                                <span v-if="item.startTime" class="text-xs font-bold text-slate-600 mt-1">{{ item.startTime }}</span>
                            </div>
                            <div class="flex-1 pb-1">
                                <h3 class="text-lg font-bold text-slate-800 mb-1 leading-tight pr-8">{{ item.name }}</h3>
                                <div class="text-sm text-slate-500 space-y-1.5 mt-2">
                                    <p v-if="item.hours" class="flex items-center"><i class="fa-regular fa-clock w-4 text-center mr-2 text-ice-blue"></i> 營業: {{ item.hours }}</p>
                                    <p v-if="item.price" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center mr-2 text-ice-blue"></i> 費用: {{ item.price }}</p>
                                    <p v-if="item.address" class="flex items-start"><i class="fa-solid fa-location-dot w-4 text-center mr-2 mt-1 text-ice-blue"></i> {{ item.address }}</p>
                                </div>
                                <div v-if="item.note && item.note.length > 0" class="mt-3 text-xs bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                    <p class="text-slate-600 font-bold mb-1 flex items-center">
                                        <i class="fa-solid fa-highlighter text-accent-yellow mr-2"></i> 備註
                                    </p>
                                    <div class="note-content" :class="{'expanded': item.isNoteExpanded}">
                                        {{ item.note }}
                                    </div>
                                    <button v-if="item.note.length > 50" @click="item.isNoteExpanded = !item.isNoteExpanded" class="text-deep-sea-blue font-bold mt-1 block">
                                        {{ item.isNoteExpanded ? '收合備註' : '查看更多...' }}
                                    </button>
                                </div>
                            </div>
                            <div class="absolute top-3 right-3 flex flex-col space-y-1">
                                <button v-if="idx > 0" @click.stop="moveItinerary(item.id, -1)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-300 transition-colors">
                                    <i class="fa-solid fa-arrow-up"></i>
                                </button>
                                <button v-if="idx < currentItinerary.length - 1" @click.stop="moveItinerary(item.id, 1)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-300 transition-colors">
                                    <i class="fa-solid fa-arrow-down"></i>
                                </button>
                                <button @click.stop="openMap(item.address || item.name)" class="w-7 h-7 bg-ice-blue text-white rounded-full flex items-center justify-center text-xs hover:bg-deep-sea-blue transition-colors">
                                    <i class="fa-solid fa-location-arrow"></i>
                                </button>
                                <button @click.stop="editItem(item)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-200 transition-colors">
                                    <i class="fa-solid fa-pencil"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentItinerary.length === 0" class="text-center py-16 text-slate-300">
                        <i class="fa-solid fa-map-location-dot text-5xl mb-3 text-slate-200"></i>
                        <p class="text-sm">本日尚無行程<br>請點擊右下角新增</p>
                    </div>
                </div>
            </div>

            <!-- 2. 資訊 Tab -->
            <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in">
                <div class="bg-gradient-to-r from-deep-sea-blue to-orange-700 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-white/10 rounded-full -ml-10 -mb-10 blur-2xl"></div>
                    <h3 class="font-bold text-lg mb-4 flex items-center relative z-10"><i class="fa-solid fa-calculator mr-2"></i> 匯率換算</h3>
                    
                    <div class="flex items-center justify-between space-x-3 relative z-10">
                        <div class="flex-1">
                            <label class="text-[10px] text-orange-200 block mb-1 uppercase tracking-wider">THB (泰銖)</label>
                            <input type="number" v-model.number="inputTHB" @input="updateTWD" class="w-full bg-white/20 border border-white/30 rounded-xl px-3 py-2.5 text-white placeholder-white focus:outline-none focus:bg-white/30 text-lg font-bold placeholder-white" placeholder="輸入泰銖">
                        </div>
                        <i class="fa-solid fa-arrow-right-arrow-left text-orange-300 mt-5"></i>
                        <div class="flex-1">
                            <label class="text-[10px] text-orange-200 block mb-1 uppercase tracking-wider">TWD (台幣)</label>
                            <input type="number" v-model.number="inputTWD" @input="updateTHB" class="w-full bg-white/10 border border-white/30 rounded-xl px-3 py-2.5 text-white placeholder-white focus:outline-none focus:bg-white/20 text-lg font-bold placeholder-white" placeholder="輸入台幣">
                        </div>
                    </div>
                    <p class="text-[10px] text-orange-200 mt-3 text-right relative z-10">匯率基準: 1 THB = {{ EXCHANGE_RATE.toFixed(4) }} TWD</p>
                </div>

                <div class="bg-white rounded-3xl p-5 card-shadow">
                    <h3 class="font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2"><i class="fa-solid fa-plane-departure text-blue-500 mr-2"></i> 航班資訊</h3>
                    <div class="space-y-4">
                        <div class="bg-blue-50 rounded-xl p-3 border border-blue-100">
                            <div class="flex justify-between text-sm font-bold text-deep-sea-blue mb-1">
                                <span>TPE 台北</span>
                                <i class="fa-solid fa-plane text-xs"></i>
                                <span>BKK 曼谷</span>
                            </div>
                            <div class="flex justify-between text-xs text-slate-500">
                                <span>10:05</span>
                                <span>CI0831 (1/16)</span>
                                <span>13:05</span>
                            </div>
                        </div>
                        <div class="bg-orange-50 rounded-xl p-3 border border-orange-100">
                            <div class="flex justify-between text-sm font-bold text-orange-800 mb-1">
                                <span>BKK 曼谷</span>
                                <i class="fa-solid fa-plane text-xs"></i>
                                <span>TPE 台北</span>
                            </div>
                            <div class="flex justify-between text-xs text-slate-500">
                                <span>14:05</span>
                                <span>CI0832 (1/20)</span>
                                <span>18:40</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-6 card-shadow">
                    <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3"><i class="fa-solid fa-hotel text-indigo-500 mr-2"></i> 住宿資訊</h3>
                    <ul class="space-y-5">
                        <li v-for="hotel in hotels" class="border-b last:border-0 pb-4 last:pb-0">
                            <div class="flex justify-between items-start group">
                                <div class="flex-1">
                                    <span class="font-bold block text-slate-700 text-lg">{{ hotel.name }}</span>
                                    <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full inline-block mt-1">{{ hotel.date }}</span>
                                </div>
                                <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center group-hover:bg-indigo-500 group-hover:text-white transition-all"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                            </div>
                            <div class="text-sm text-slate-500 mt-2 space-y-1">
                                <p class="flex items-center"><i class="fa-solid fa-phone w-5 text-center mr-1 text-slate-300"></i> {{ hotel.phone }}</p>
                                <p class="flex items-start"><i class="fa-solid fa-map-pin w-5 text-center mr-1 mt-1 text-slate-300"></i> {{ hotel.address }}</p>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <!-- 身份切換區 (移動至此) -->
                <div class="bg-white rounded-3xl p-5 card-shadow border border-deep-sea-blue/10">
                    <h3 class="font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2 flex items-center">
                        <i class="fa-solid fa-user-gear text-deep-sea-blue mr-2"></i> 使用者設定
                    </h3>
                    <div>
                        <label class="text-xs text-slate-500 mb-1 block font-bold">我是誰？(切換身份)</label>
                        <select v-model="currentUser" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none font-bold text-deep-sea-blue">
                            <option v-for="m in members" :key="m.id" :value="m.name">{{ m.name }}</option>
                        </select>
                        <p class="text-[10px] text-slate-400 mt-2">切換後，花費頁面將只顯示該成員的支出紀錄。</p>
                    </div>
                </div>
            </div>

            <!-- 3. 購物 Tab -->
            <div v-if="currentTab === 'shopping'" class="animate-fade-in">
                <div class="bg-white rounded-3xl p-6 card-shadow min-h-[60vh]">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center justify-between">
                        <span><i class="fa-solid fa-basket-shopping text-accent-yellow mr-2"></i> 購物清單</span>
                        <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded-lg">{{ shoppingList.length }} 項</span>
                    </h3>
                    
                    <ul class="space-y-3" v-if="shoppingList.length > 0">
                        <li v-for="(item, index) in shoppingList" :key="index" class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                            <div class="flex items-center">
                                <input type="checkbox" v-model="item.checked" class="w-5 h-5 text-deep-sea-blue rounded focus:ring-deep-sea-blue border-gray-300 mr-3 accent-deep-sea-blue">
                                <span :class="{'line-through text-slate-400': item.checked, 'text-slate-700 font-medium': !item.checked}">{{ item.name }}</span>
                            </div>
                            <button @click="removeShoppingItem(index)" class="text-slate-300 hover:text-red-500 transition-colors">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </li>
                    </ul>

                    <div v-else class="text-center py-12 text-slate-300">
                        <i class="fa-solid fa-bag-shopping text-5xl mb-3 text-slate-200"></i>
                        <p class="text-sm">購物清單空白<br>請點擊右下角新增</p>
                    </div>
                </div>
            </div>

            <!-- 4. 花費 Tab (核心功能區) -->
            <div v-if="currentTab === 'expenses'" class="animate-fade-in space-y-6">
                <div class="expenses-banner text-white rounded-3xl p-6 relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 bg-white/10 w-48 h-48 rounded-full blur-3xl"></div>
                    <div class="absolute -left-10 -bottom-10 bg-white/20 w-40 h-40 rounded-full blur-2xl"></div>
                    
                    <!-- 顯示當前使用者的總支出 -->
                    <p class="text-sm text-orange-100 mb-2 relative z-10 flex items-center">
                        <i class="fa-solid fa-user-circle mr-1"></i> {{ currentUser }} 的個人總支出
                    </p>
                    
                    <h2 class="text-4xl font-bold relative z-10 tracking-tight">
                      約 NT$ {{ formatNumber(finalTotalTWD) }}
                    </h2>
                    <div class="text-xs mt-3 opacity-90 leading-relaxed relative z-10 bg-white/10 p-3 rounded-lg border border-white/20">
                        <div class="flex justify-between">
                            <span>THB 小計:</span>
                            <span class="font-semibold">฿ {{ formatNumber(totalTHB) }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>TWD 小計:</span>
                            <span class="font-semibold">NT$ {{ formatNumber(totalTWD) }}</span>
                        </div>
                        <div class="mt-2 pt-2 border-t border-white/20 text-right text-[10px]">
                            匯率基準: 1 THB = {{ EXCHANGE_RATE.toFixed(4) }} TWD
                        </div>
                    </div>
                </div>

                <!-- 我的支出紀錄 -->
                <div class="bg-white rounded-3xl p-6 card-shadow">
                    <h3 class="font-bold text-slate-800 mb-4">
                        <i class="fa-solid fa-user-pen mr-2 text-deep-sea-blue"></i> {{ currentUser }} 的支出紀錄
                    </h3>
                    <ul v-if="myExpenses.length > 0" class="space-y-4">
                        <li v-for="(exp, idx) in myExpenses" :key="idx" 
                            class="flex items-center justify-between border-b border-slate-50 last:border-0 pb-3 last:pb-0 transition-colors rounded-lg px-2 -mx-2 hover:bg-slate-50">
                            <div class="flex items-center cursor-pointer flex-1" @click="startEditExpense(getOriginalIndex(exp.id), exp)">
                                <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center mr-3 text-slate-500 flex-shrink-0 self-center">
                                    <i :class="getCategoryIcon(exp.category)"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-bold text-slate-700 text-sm leading-tight">{{ exp.name }}</p>
                                    <p class="text-xs text-slate-400 mt-0.5">{{ exp.date }}
                                        <span v-if="exp.splitMethod!=='personal'" class="ml-1 px-1.5 py-0.5 rounded-full bg-slate-200 text-[9px] font-medium text-slate-600">分帳</span>
                                        <span v-if="exp.payer !== currentUser" class="ml-1 px-1.5 py-0.5 rounded-full bg-orange-200 text-[9px] font-bold text-orange-800">{{ exp.payer }}先付</span>
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="text-right mr-3 cursor-pointer" @click="startEditExpense(getOriginalIndex(exp.id), exp)">
                                    <p class="font-bold text-deep-sea-blue">{{ exp.currency === 'TWD' ? 'NT$' : '฿' }}{{ formatNumber(exp.displayAmount) }}</p>
                                    <p class="text-xs text-slate-400 uppercase">{{ exp.payment }}</p>
                                </div>
                                <button @click.stop="removeExpense(getOriginalIndex(exp.id))" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-300 hover:bg-red-50 hover:text-red-500 transition-colors">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </li>
                    </ul>
                    <div v-else class="text-center py-8 text-slate-400">
                        <i class="fa-solid fa-file-invoice-dollar text-3xl text-slate-300 mb-2"></i>
                        <p>尚無由 {{ currentUser }} 支付或分攤的款項</p>
                    </div>
                </div>

                <!-- 分帳總覽 -->
                <div class="bg-white rounded-3xl p-6 card-shadow">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center justify-between">
                        <span><i class="fa-solid fa-receipt mr-2 text-indigo-500"></i> 分帳總覽</span>
                        <span class="text-[10px] text-slate-400 font-normal">點擊成員查看明細</span>
                    </h3>
                    <ul class="space-y-3">
                        <li v-for="([name, balance]) in Object.entries(memberBalances)" :key="name" class="flex flex-col bg-slate-50 rounded-xl overflow-hidden transition-all duration-300 border border-transparent" :class="{'border-indigo-100 shadow-sm': expandedMember === name}">
                            <div class="flex items-center justify-between p-3 cursor-pointer" @click="toggleMemberDetails(name)" :class="balance > 0 ? 'bg-green-50' : 'bg-red-50'">
                                <span class="font-bold text-sm flex items-center" :class="balance > 0 ? 'text-green-700' : 'text-red-700'">
                                    <i class="fa-solid mr-2 text-xs" :class="expandedMember === name ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                                    {{ name }}
                                </span>
                                <div class="text-right">
                                    <span class="font-bold text-lg" :class="balance > 0 ? 'text-green-600' : 'text-red-600'">
                                        {{ balance > 0 ? '+' : '' }}NT$ {{ formatNumber(Math.round(balance)) }}
                                    </span>
                                    <span class="text-xs ml-1" :class="balance > 0 ? 'text-green-500' : 'text-red-500'">
                                        {{ balance > 0 ? '應收' : (balance < 0 ? '應付' : '已結清') }}
                                    </span>
                                </div>
                            </div>
                            <div v-if="expandedMember === name" class="bg-white p-3 border-t border-slate-100 animate-fade-in">
                                <p class="text-xs text-slate-400 mb-2 font-bold">該成員支付的分帳項目：</p>
                                <ul class="space-y-2">
                                    <li v-for="detail in getMemberPaidExpenses(name)" :key="detail.id" class="flex justify-between items-center text-xs text-slate-600 border-b border-slate-50 pb-1 last:border-0 last:pb-0">
                                        <div class="flex-1 truncate pr-2">
                                            <span class="block text-slate-800">{{ detail.name }}</span>
                                            <span class="text-[10px] text-slate-400">{{ detail.date }}</span>
                                        </div>
                                        <span class="font-medium whitespace-nowrap">{{ detail.currency === 'TWD' ? 'NT$' : '฿' }} {{ formatNumber(detail.amount) }}</span>
                                    </li>
                                    <li v-if="getMemberPaidExpenses(name).length === 0" class="text-center text-slate-300 py-2">無支付紀錄</li>
                                </ul>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <!-- 結算建議 -->
                <div class="bg-white rounded-3xl p-6 card-shadow">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                        <i class="fa-solid fa-handshake-angle mr-2 text-cyan-500"></i> 結算建議
                    </h3>
                    <ul v-if="settlementSteps.length > 0" class="space-y-2">
                        <li v-for="(step, idx) in settlementSteps" :key="idx" class="text-center bg-slate-50 p-3 rounded-lg text-sm text-slate-600">
                           {{ step }}
                        </li>
                    </ul>
                    <div v-else class="text-center py-4 text-slate-400">
                        <i class="fa-solid fa-circle-check text-2xl text-green-400 mb-2"></i>
                        <p>帳務已結清</p>
                    </div>
                </div>
            </div>
        </main>

        <button v-if="currentTab !== 'info'" @click="handleAddClick" class="fixed bottom-6 right-6 w-14 h-14 bg-accent-yellow rounded-full fab-shadow text-deep-sea-blue text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40">
            <i class="fa-solid fa-plus"></i>
        </button>

        <!-- Modals 省略不變的部分... -->
        <!-- Shopping Modal -->
        <div v-if="showShoppingModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
                <h3 class="font-bold text-lg mb-5 text-center text-slate-800">新增購物清單</h3>
                <input v-model="newShoppingItem.name" type="text" placeholder="商品名稱" class="w-full bg-slate-50 border-none rounded-xl p-4 mb-4 focus:ring-2 focus:ring-deep-sea-blue text-sm outline-none">
                <div class="flex space-x-3">
                    <button @click="showShoppingModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                    <button @click="addShoppingItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-lg shadow-deep-sea-blue/30">新增</button>
                </div>
            </div>
        </div>

        <!-- Expense Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="font-bold text-lg mb-5 text-center text-slate-800">{{ editingExpenseIndex === null ? "記一筆" : "編輯支出" }}</h3>
                <div class="space-y-3">
                    <input v-model="newExpense.date" type="date" class="w-full bg-slate-50 rounded-xl p-3 text-sm text-slate-600 outline-none">
                    <input v-model="newExpense.name" type="text" placeholder="項目名稱" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <div class="grid grid-cols-2 gap-3">
                        <select v-model="newExpense.payer" class="bg-slate-50 rounded-xl p-3 text-sm text-slate-600 outline-none">
                            <option v-for="member in members" :key="member.id" :value="member.name">{{ member.name }} (支付)</option>
                        </select>
                         <select v-model="newExpense.payment" class="bg-slate-50 rounded-xl p-3 text-sm text-slate-600 outline-none">
                            <option value="cash">現金</option>
                            <option value="card">信用卡</option>
                        </select>
                    </div>
                    <div class="flex space-x-2">
                        <select v-model="newExpense.currency" class="bg-slate-50 rounded-xl p-3 text-sm outline-none font-bold text-slate-700 w-24">
                            <option value="THB">฿ THB</option>
                            <option value="TWD">$ TWD</option>
                        </select>
                        <input v-model.number="newExpense.amount" type="number" placeholder="金額" class="flex-1 bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    </div>
                    <div class="bg-slate-50 rounded-xl p-3 border border-slate-100 mt-2">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs font-bold text-slate-500"><i class="fa-solid fa-user-group mr-1"></i> 多人分帳</span>
                            <button @click="showMemberModal = true" class="text-[10px] px-2 py-1 rounded-lg bg-white border border-slate-200 text-deep-sea-blue font-medium shadow-sm"><i class="fa-solid fa-users-gear mr-1"></i>管理成員</button>
                        </div>
                        <div class="flex space-x-1 mb-3 bg-white p-1 rounded-lg border border-slate-200">
                            <button class="flex-1 py-1 text-[10px] rounded transition-colors" :class="newExpense.splitMethod==='personal' ? 'bg-deep-sea-blue text-white shadow' : 'text-slate-500'" @click="newExpense.splitMethod='personal'">個人</button>
                            <button class="flex-1 py-1 text-[10px] rounded transition-colors" :class="newExpense.splitMethod==='equal' ? 'bg-deep-sea-blue text-white shadow' : 'text-slate-500'" @click="newExpense.splitMethod='equal'">均分</button>
                            <button class="flex-1 py-1 text-[10px] rounded transition-colors" :class="newExpense.splitMethod==='ratio' ? 'bg-deep-sea-blue text-white shadow' : 'text-slate-500'" @click="newExpense.splitMethod='ratio'">比例</button>
                            <button class="flex-1 py-1 text-[10px] rounded transition-colors" :class="newExpense.splitMethod==='amount' ? 'bg-deep-sea-blue text-white shadow' : 'text-slate-500'" @click="newExpense.splitMethod='amount'">金額</button>
                        </div>
                        <div v-if="newExpense.splitMethod !== 'personal'">
                            <div v-if="splitMembers.length > 0" class="space-y-2 max-h-32 overflow-y-auto pr-1">
                                 <div v-if="newExpense.splitMethod === 'equal'" class="text-xs text-slate-500 p-2 text-center bg-white rounded border border-slate-100">
                                    將由 {{ splitMembers.length }} 位啟用成員均分<br><span class="text-[10px] text-orange-400">(除不盡的餘額將隨機分配)</span>
                                 </div>
                                 <div v-else>
                                    <p class="text-xs text-slate-400 mb-2">請輸入分帳{{ newExpense.splitMethod === 'ratio' ? '比例' : '金額' }}：</p>
                                    <div v-for="member in splitMembers" :key="member" class="flex items-center justify-between mb-2 last:mb-0">
                                        <span class="text-xs text-slate-600 truncate w-20">{{ member }}</span>
                                        <input v-model="newExpense.splitDetails[member]" type="number" 
                                               :placeholder="newExpense.splitMethod === 'ratio' ? '比例' : '金額'" 
                                               class="flex-1 bg-white p-1.5 rounded border border-slate-200 text-xs text-right outline-none focus:border-deep-sea-blue">
                                    </div>
                                 </div>
                            </div>
                            <div v-else class="text-xs text-slate-400 text-center py-2">沒有啟用的分帳成員</div>
                        </div>
                        <div v-else class="text-xs text-slate-400 text-center py-2 bg-white rounded border border-slate-100">此筆為個人支出</div>
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button @click="closeExpenseModal" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                    <button @click="saveExpense" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-lg shadow-deep-sea-blue/30">{{ editingExpenseIndex === null ? "儲存" : "更新" }}</button>
                </div>
            </div>
        </div>

        <!-- Itinerary Modal -->
        <div v-if="showItineraryModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="font-bold text-lg mb-5 text-center text-slate-800">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
                <div class="space-y-3">
                    <select v-model="newItinerary.category" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                        <option value="sightseeing">景點</option>
                        <option value="food">飲食</option>
                        <option value="shopping">購物</option>
                        <option value="accommodation">住宿</option>
                        <option value="transport">交通</option>
                        <option value="ticket">門票</option>
                        <option value="flight">航班</option>
                        <option value="other">其他</option>
                    </select>
                    <input v-model="newItinerary.startTime" type="text" placeholder="時間" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <input v-model="newItinerary.name" type="text" placeholder="行程名稱" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <input v-model="newItinerary.address" type="text" placeholder="地址" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <textarea v-model="newItinerary.note" rows="3" placeholder="備註" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none"></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <input v-model="newItinerary.hours" type="text" placeholder="營業時間" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                        <input v-model="newItinerary.price" type="text" placeholder="預算" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button @click="showItineraryModal = false; isEditMode = false" :class="isEditMode ? 'w-1/3' : 'flex-1'" class="py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                    <button v-if="isEditMode" @click="removeItineraryItem(newItinerary.id)" class="w-1/3 py-3 rounded-xl bg-red-100 text-red-600 font-bold text-sm hover:bg-red-200 transition-colors"><i class="fa-solid fa-trash-can mr-1"></i> 刪除</button>
                    <button @click="saveItineraryItem" :class="isEditMode ? 'w-1/3' : 'flex-1'" class="py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-lg shadow-deep-sea-blue/30">{{ isEditMode ? '儲存' : '新增' }}</button>
                </div>
            </div>
        </div>

        <!-- Member Modal -->
        <div v-if="showMemberModal" class="fixed inset-0 bg-deep-sea-blue/40 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
                <h3 class="font-bold text-lg mb-4 text-center text-slate-800">分帳成員管理</h3>
                <div class="space-y-2 max-h-60 overflow-y-auto mb-4 min-h-[100px]">
                    <div v-for="m in members" :key="m.id" class="flex items-center justify-between bg-slate-50 rounded-xl px-3 py-3 border border-slate-100">
                        <span class="text-sm font-medium" :class="m.active ? 'text-slate-700' : 'text-slate-400 line-through'">{{ m.name }}</span>
                        <div class="flex items-center space-x-2">
                            <button @click="toggleMemberActive(m)" class="px-2 py-1 rounded-lg text-[10px] font-bold transition-colors" :class="m.active ? 'bg-green-100 text-green-600' : 'bg-slate-200 text-slate-500'">{{ m.active ? '參與分帳' : '不參與' }}</button>
                            <button v-if="m.name !== '我'" @click="removeMember(m.id)" class="w-6 h-6 rounded-full bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors"><i class="fa-solid fa-times text-xs"></i></button>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2 mb-4">
                    <input v-model="newMemberName" @keyup.enter="addMember" placeholder="新成員名稱" class="flex-1 bg-slate-50 rounded-xl p-3 text-sm outline-none border border-transparent focus:border-deep-sea-blue">
                    <button @click="addMember" class="px-4 rounded-xl bg-deep-sea-blue text-white text-sm font-bold shadow-lg shadow-deep-sea-blue/20">新增</button>
                </div>
                <button @click="showMemberModal = false" class="w-full py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm hover:bg-slate-200 transition-colors">完成</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';

        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCyYCSGWQ0Wdf13AE62UG7W8WiwpqCHs_0",
          authDomain: "bankoktrip2026.firebaseapp.com",
          projectId: "bankoktrip2026",
          storageBucket: "bankoktrip2026.firebasestorage.app",
          messagingSenderId: "347622663908",
          appId: "1:347622663908:web:6a514d1761f215a2ae6ef1",
          measurementId: "G-ENHVD5XKF8"
        };

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const analytics = getAnalytics(firebaseApp);
        const db = getFirestore(firebaseApp);
        const DB_NAME = 'expenses_2026';

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const selectedDateIndex = ref(0);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showItineraryModal = ref(false);
                const showMemberModal = ref(false);
                const isEditMode = ref(false);
                const editingExpenseIndex = ref(null);
                const expandedMember = ref(null);
                const currentUser = ref('kappabooom'); // Default current user
                const isSyncing = ref(true); // Loading state for Firebase

                const dates = ref([
                    { day: 'Thu', date: '16', full: '2025-01-16' },
                    { day: 'Fri', date: '17', full: '2025-01-17' },
                    { day: 'Sat', date: '18', full: '2025-01-18' },
                    { day: 'Sun', date: '19', full: '2025-01-19' },
                    { day: 'Mon', date: '20', full: '2025-01-20' }
                ]);

                // Weather Logic
                const weatherData = ref([]);
                const WEATHER_API_KEY = 'e5e727b85066927db1d248be29dfa632'; // User's key from previous context
                const FALLBACK_WEATHER = [
                    { condition: 'sunny', temp: '32/24', feel: '35', isFallback: true },
                    { condition: 'cloudy', temp: '31/25', feel: '34', isFallback: true },
                    { condition: 'sunny', temp: '33/24', feel: '36', isFallback: true },
                    { condition: 'rain', temp: '30/24', feel: '32', isFallback: true },
                    { condition: 'sunny', temp: '32/25', feel: '35', isFallback: true }
                ];

                const fetchWeather = async () => {
                    try {
                        const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=Bangkok,th&units=metric&lang=zh_tw&appid=${WEATHER_API_KEY}`);
                        if (!response.ok) throw new Error('Weather API Error');
                        const data = await response.json();

                        const dailyForecasts = {};
                        data.list.forEach(item => {
                            const dateStr = item.dt_txt.split(' ')[0];
                            if (!dailyForecasts[dateStr] && item.dt_txt.includes('12:00:00')) {
                                dailyForecasts[dateStr] = item;
                            }
                        });

                        // Fill weather data matching dates
                        weatherData.value = dates.value.map((d, i) => {
                             // Simple matching logic or fallback
                             const forecast = dailyForecasts[d.full];
                             if(forecast) {
                                 return {
                                     condition: forecast.weather[0].main.toLowerCase().includes('rain') ? 'rain' : (forecast.weather[0].main.toLowerCase().includes('cloud') ? 'cloudy' : 'sunny'),
                                     temp: `${Math.round(forecast.main.temp_max)}/${Math.round(forecast.main.temp_min)}`,
                                     feel: Math.round(forecast.main.feels_like),
                                     desc: forecast.weather[0].description,
                                     isReal: true
                                 };
                             }
                             return FALLBACK_WEATHER[i];
                        });

                    } catch (e) {
                        console.error('Weather fetch failed', e);
                        weatherData.value = FALLBACK_WEATHER;
                    }
                };

                // Currency Logic
                const EXCHANGE_RATE = ref(0.92);
                const inputTHB = ref('');
                const inputTWD = ref('');

                const fetchExchangeRate = async () => {
                    try {
                        const res = await fetch('https://open.er-api.com/v6/latest/THB');
                        const data = await res.json();
                        if (data && data.rates && data.rates.TWD) {
                            EXCHANGE_RATE.value = data.rates.TWD;
                        }
                    } catch (e) {
                        console.error('Exchange rate fetch failed', e);
                    }
                };

                const updateTWD = () => {
                    if (inputTHB.value === '') inputTWD.value = '';
                    else inputTWD.value = (parseFloat(inputTHB.value) * EXCHANGE_RATE.value).toFixed(0);
                };
                const updateTHB = () => {
                    if (inputTWD.value === '') inputTHB.value = '';
                    else inputTHB.value = (parseFloat(inputTWD.value) / EXCHANGE_RATE.value).toFixed(0);
                };

                // Data Models
                const currentItinerary = ref([
                    { id: 1, time: '10:00', name: '大皇宮', type: 'sightseeing', location: 'Na Phra Lan Rd', note: '門票 500 THB', transport: 'taxi', transportTime: '20' },
                    { id: 2, time: '12:30', name: 'Kub Kao Kub Pla', type: 'food', location: 'IconSiam 5F', note: '必點咖哩蟹', transport: 'boat', transportTime: '15' }
                ]);

                const hotels = ref([
                    { name: 'Grande Centre Point', address: '151 Ratchadamri Rd', checkin: '14:00', checkout: '12:00', wifi: 'GCP_Guest / guest123' }
                ]);

                const shoppingList = ref([]);
                const members = ref([
                    { id: 'kappabooom', name: 'kappabooom', active: true },
                    { id: 'beibei1029', name: 'beibei1029', active: true },
                    { id: 'hsiannnnnng', name: 'hsiannnnnng', active: true },
                    { id: 'shinbinwei', name: 'shinbinwei', active: true },
                    { id: 'aylwen4444', name: 'aylwen4444', active: true },
                    { id: 'wunsin', name: 'wunsin', active: true },
                    { id: 'rtrtr1', name: 'rtrtr1', active: true },
                    { id: 'blackblacknu', name: 'blackblacknu', active: true }
                ]);

                // FIREBASE: Expenses are now reactive to Firestore
                const expenses = ref([]);

                // Initial Load & Listeners
                onMounted(() => {
                    fetchWeather();
                    fetchExchangeRate();

                    // FIREBASE: Real-time listener
                    const q = query(collection(db, DB_NAME), orderBy("createdAt", "desc"));
                    onSnapshot(q, (snapshot) => {
                        expenses.value = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        isSyncing.value = false;
                    }, (error) => {
                        console.error("Firebase Snapshot Error:", error);
                        isSyncing.value = false;
                    });
                });

                // Computed
                const isPastDate = computed(() => {
                    // Logic to hide past weather cards
                    return (dateStr) => {
                        const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                        const target = dateStr.replace(/-/g, '');
                        return target < today;
                    }
                });

                const totalTHB = computed(() => expenses.value.filter(e => e.currency === 'THB').reduce((sum, e) => sum + Number(e.amount), 0));
                const totalTWD = computed(() => expenses.value.filter(e => e.currency === 'TWD').reduce((sum, e) => sum + Number(e.amount), 0));
                const finalTotalTWD = computed(() => Math.round(totalTWD.value + (totalTHB.value * EXCHANGE_RATE.value)));

                const myExpenses = computed(() => {
                    // Filter expenses where 'I' (currentUser) am involved
                    return expenses.value.filter(e => {
                        // 1. I paid for it (and it's not a split bill, or it is)
                        // 2. Or someone else paid, but I have a share in it
                        if (e.payer === currentUser.value) return true; 
                        if (e.splitDetails && e.splitDetails[currentUser.value] > 0) return true;
                        return false;
                    }).map(e => {
                        // Calculate my share cost
                        let myCost = 0;
                        if (e.splitDetails && e.splitDetails[currentUser.value]) {
                            myCost = e.splitDetails[currentUser.value];
                        } else if (e.payer === currentUser.value && (!e.splitDetails || Object.keys(e.splitDetails).length === 0)) {
                            myCost = e.amount; // Personal expense
                        }

                        // Convert myCost to TWD for display if needed, but keeping original currency is usually better for detail
                        // Logic requested: "分到我身上的項目"
                        return {
                            ...e,
                            myShareAmount: myCost,
                            isPayer: e.payer === currentUser.value
                        };
                    });
                });

                const splitMembers = computed(() => members.value.filter(m => m.active));

                // Member Balance Calculation (Complex logic simplified)
                const memberBalances = computed(() => {
                    const balances = {};
                    members.value.forEach(m => balances[m.id] = 0);

                    expenses.value.forEach(exp => {
                        // If no split details, skip (assume personal expense unless marked otherwise, 
                        // but your app logic seems to enforce split for group expenses)
                        if (!exp.splitDetails) return;

                        const payer = exp.payer;
                        const amount = Number(exp.amount);
                        // Convert everything to TWD for settlement? Or keep separate?
                        // Usually settlement is done in one currency. Let's assume TWD for simplicity or base currency.
                        // If expense is THB, convert to TWD for settlement balance
                        const amountInTWD = exp.currency === 'THB' ? amount * EXCHANGE_RATE.value : amount;

                        // Payer 'paid' this amount, so they are 'owed' this amount initially
                        // But we need to subtract their own share.

                        // Actually, easier way:
                        // Payer +amount
                        // Everyone -their_share

                        // Add total paid to payer
                        balances[payer] += amountInTWD;

                        // Subtract share from each member
                        Object.entries(exp.splitDetails).forEach(([memberId, share]) => {
                             const shareInTWD = exp.currency === 'THB' ? share * EXCHANGE_RATE.value : share;
                             if(balances[memberId] !== undefined) {
                                 balances[memberId] -= shareInTWD;
                             }
                        });
                    });

                    return Object.entries(balances)
                        .map(([id, amount]) => ({ 
                            id, 
                            name: members.value.find(m => m.id === id)?.name || id, 
                            amount: Math.round(amount) 
                        }))
                        .sort((a, b) => b.amount - a.amount);
                });

                const settlementSteps = computed(() => {
                    // Greedy algorithm for settlement
                    let debtors = memberBalances.value.filter(m => m.amount < -1).map(m => ({...m}));
                    let creditors = memberBalances.value.filter(m => m.amount > 1).map(m => ({...m}));

                    // Sort by magnitude
                    debtors.sort((a, b) => a.amount - b.amount); // Most negative first
                    creditors.sort((a, b) => b.amount - a.amount); // Most positive first

                    const steps = [];
                    let i = 0; // debtor index
                    let j = 0; // creditor index

                    while (i < debtors.length && j < creditors.length) {
                        const debtor = debtors[i];
                        const creditor = creditors[j];

                        // The amount to settle is the minimum of (abs(debt), credit)
                        const amount = Math.min(Math.abs(debtor.amount), creditor.amount);

                        if (amount > 0) {
                            steps.push({
                                from: debtor.name,
                                to: creditor.name,
                                amount: amount
                            });
                        }

                        debtor.amount += amount;
                        creditor.amount -= amount;

                        // If settled (close to 0), move to next
                        if (Math.abs(debtor.amount) < 1) i++;
                        if (creditor.amount < 1) j++;
                    }
                    return steps;
                });


                // Inputs
                const newShoppingItem = ref({ name: '', price: '', buyer: '' });
                const newExpense = ref({ 
                    item: '', 
                    amount: '', 
                    currency: 'THB', 
                    type: 'food', 
                    payer: '', 
                    splitMethod: 'even', // even, custom
                    splitDetails: {} 
                });
                const newItinerary = ref({ time: '', name: '', type: 'sightseeing', location: '', note: '', transport: 'taxi' });
                const newMemberName = ref('');

                // Methods
                const formatNumber = (num) => new Intl.NumberFormat('en-US').format(Math.round(num));
                const getCategoryIcon = (type) => ({ food: 'fa-utensils', transport: 'fa-train-subway', ticket: 'fa-ticket', shopping: 'fa-bag-shopping', accommodation: 'fa-bed', other: 'fa-asterisk' }[type] || 'fa-asterisk');

                const handleAddClick = () => {
                    if (currentTab.value === 'shopping') showShoppingModal.value = true;
                    if (currentTab.value === 'expenses') {
                         resetNewExpense();
                         showExpenseModal.value = true;
                    }
                    if (currentTab.value === 'itinerary') {
                        isEditMode.value = false;
                        newItinerary.value = { time: '', name: '', type: 'sightseeing', location: '', note: '', transport: 'taxi' };
                        showItineraryModal.value = true;
                    }
                };

                // Helper to get index in filtered list
                const getOriginalIndex = (item) => expenses.value.findIndex(e => e.id === item.id);

                const resetNewExpense = () => {
                    newExpense.value = { 
                        item: '', amount: '', currency: 'THB', type: 'food', 
                        payer: currentUser.value, // Default payer is me
                        splitMethod: 'even', splitDetails: {} 
                    };
                    isEditMode.value = false;
                    editingExpenseIndex.value = null;
                };

                const startEditExpense = (expense) => {
                    isEditMode.value = true;
                    editingExpenseIndex.value = expense.id; // Use ID for Firebase
                    newExpense.value = JSON.parse(JSON.stringify(expense));
                    showExpenseModal.value = true;
                };

                // FIREBASE: Save (Add/Update)
                const saveExpense = async () => {
                    if (!newExpense.value.item || !newExpense.value.amount) return alert('請輸入項目與金額');

                    // Logic to calculate splitDetails if 'even'
                    if (newExpense.value.splitMethod === 'even') {
                        const activeMembers = members.value.filter(m => m.active);
                        const count = activeMembers.length;
                        const total = Number(newExpense.value.amount);
                        const perPerson = Math.floor(total / count);
                        let remainder = total - (perPerson * count);

                        const details = {};
                        activeMembers.forEach((m, idx) => {
                            let share = perPerson;
                            if (remainder > 0) {
                                share += 1;
                                remainder--;
                            }
                            details[m.id] = share;
                        });
                        newExpense.value.splitDetails = details;
                    }

                    const expenseData = {
                        ...newExpense.value,
                        date: new Date().toISOString().split('T')[0], // Simple date
                        createdAt: serverTimestamp()
                    };

                    try {
                        if (isEditMode.value && editingExpenseIndex.value) {
                             const expenseRef = doc(db, DB_NAME, editingExpenseIndex.value);
                             const { id, ...dataToUpdate } = expenseData; // remove id if exists in object
                             await updateDoc(expenseRef, dataToUpdate);
                        } else {
                             await addDoc(collection(db, DB_NAME), expenseData);
                        }
                        closeExpenseModal();
                    } catch (e) {
                        alert("儲存失敗: " + e.message);
                        console.error(e);
                    }
                };

                // FIREBASE: Remove
                const removeExpense = async (id) => {
                    if(confirm('確定要刪除此筆紀錄？')) {
                        try {
                            await deleteDoc(doc(db, DB_NAME, id));
                        } catch (e) {
                            alert("刪除失敗");
                        }
                    }
                };

                const closeExpenseModal = () => {
                    showExpenseModal.value = false;
                    editingExpenseIndex.value = null;
                    resetNewExpense();
                }

                // Member Methods
                const addMember = () => {
                    if (newMemberName.value) {
                        const id = newMemberName.value; // simple ID
                        members.value.push({ id, name: newMemberName.value, active: true });
                        newMemberName.value = '';
                    }
                };
                const toggleMemberActive = (m) => m.active = !m.active;
                const removeMember = (idx) => members.value.splice(idx, 1);
                const toggleMemberDetails = (mId) => {
                     expandedMember.value = expandedMember.value === mId ? null : mId;
                };
                const getMemberPaidExpenses = (mId) => {
                    return expenses.value.filter(e => e.payer === mId);
                };

                // Shopping & Itinerary (Local Only for now as per request focus on expenses)
                const addShoppingItem = () => {
                    if (newShoppingItem.value.name) {
                        shoppingList.value.push({ ...newShoppingItem.value });
                        newShoppingItem.value.name = '';
                        showShoppingModal.value = false;
                    }
                };
                const removeShoppingItem = (idx) => shoppingList.value.splice(idx, 1);

                const saveItineraryItem = () => {
                    if (!newItinerary.value.name) return alert('請輸入名稱');
                    const list = currentItinerary.value;
                    if (isEditMode.value) {
                        const idx = list.findIndex(i => i.id === newItinerary.value.id);
                        if (idx !== -1) list[idx] = { ...newItinerary.value };
                    } else {
                        list.push({ ...newItinerary.value, id: Date.now() });
                    }
                    showItineraryModal.value = false;
                };

                const removeItineraryItem = (id) => {
                    const idx = currentItinerary.value.findIndex(i => i.id === id);
                    if (idx !== -1) currentItinerary.value.splice(idx, 1);
                    showItineraryModal.value = false;
                };

                const moveItinerary = (id, direction) => {
                    const list = currentItinerary.value;
                    const idx = list.findIndex(i => i.id === id);
                    if (idx === -1) return;
                    const newIdx = idx + direction;
                    if (newIdx >= 0 && newIdx < list.length) {
                        const item = list.splice(idx, 1)[0];
                        list.splice(newIdx, 0, item);
                    }
                };

                const openMap = (q) => { if(q) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank'); };
                const openMapDirections = (start, end) => {
                    const o = start.address || start.name;
                    const d = end.address || end.name;
                    if(o && d) window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(o)}&destination=${encodeURIComponent(d)}`, '_blank');
                };
                const editItem = (item) => {
                    isEditMode.value = true;
                    newItinerary.value = JSON.parse(JSON.stringify(item));
                    showItineraryModal.value = true;
                };\n
                const getWeatherIcon = (cond) => {
                    const map = { sunny: 'fa-solid fa-sun', cloudy: 'fa-solid fa-cloud-sun', rain: 'fa-solid fa-cloud-showers-heavy' };
                    return map[cond] || 'fa-solid fa-sun';
                };
                const getWeatherDescription = (cond) => ({ sunny: '晴朗炎熱', cloudy: '多雲偶晴', rain: '午後雷陣雨' }[cond] || '晴朗');
                const getTransportIcon = (type) => ({ car: 'fa-solid fa-car', walk: 'fa-solid fa-person-walking', public: 'fa-solid fa-train-subway' }[type] || 'fa-solid fa-arrow-right');
                const getCategoryColor = (cat) => ({
                    sightseeing: '#FF7043', food: '#FFA726', shopping: '#EC407A', accommodation: '#5C6BC0', 
                    transport: '#78909C', ticket: '#8D6E63', flight: '#29B6F6', other: '#BDBDBD'
                }[cat] || '#BDBDBD');

                return {
                    currentTab, selectedDateIndex, showShoppingModal, showExpenseModal, showItineraryModal, showMemberModal, isEditMode, editingExpenseIndex, expandedMember,
                    dates, weatherData, currentItinerary, hotels, shoppingList, expenses, members,
                    newShoppingItem, newExpense, newItinerary, newMemberName,
                    splitMembers, myExpenses, totalTHB, totalTWD, finalTotalTWD, memberBalances, settlementSteps, EXCHANGE_RATE, 
                    inputTHB, inputTWD, updateTHB, updateTWD, isPastDate, isSyncing,
                    formatNumber, getCategoryIcon, handleAddClick, getOriginalIndex,
                    addMember, toggleMemberActive, removeMember, toggleMemberDetails, getMemberPaidExpenses,
                    startEditExpense, saveExpense, removeExpense, closeExpenseModal,
                    addShoppingItem, removeShoppingItem,
                    saveItineraryItem, removeItineraryItem, moveItinerary, openMap, openMapDirections, editItem,
                    getWeatherIcon, getWeatherDescription, getTransportIcon, getCategoryColor, currentUser
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
